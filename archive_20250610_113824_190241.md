file_dir: logs.sh

journalctl -u myapp.service -n 100 --no-pager

file_dir: config.py

import os
import secrets

# é¡¹ç›®æ ¹ç›®å½•
BASE_DIR = os.path.dirname(os.path.abspath(__file__))

# Flask çš„ SECRET_KEY
SECRET_KEY = secrets.token_urlsafe(32)

# è£èª‰ç±»å‹
HONOR_TYPE = (
    'æ•™å­¦æ¯”æ­¦',
    'æŠ€èƒ½æ¯”æ­¦',
    'å­¦ç”Ÿç«èµ›',
    'è£èª‰',
    'è®ºæ–‡',
    'è¯¾é¢˜',
    'æˆæœ',
    'æŠ¥å‘Š',
    'è¯´è¯¾',
    'å…¬å¼€è¯¾',
    'å…¶ä»–'
)

# ç­‰çº§
LEVEL_TYPE = (
    'å›½å®¶çº§',
    'çœçº§',
    'å¸‚çº§',
    'å¿çº§',
    'æ ¡çº§'
)

file_dir: push.sh

git push -u origin main


file_dir: run.sh

sudo systemctl daemon-reload
sudo systemctl restart redis
sudo systemctl restart myapp
sudo systemctl restart nginx
sudo systemctl status myapp          # æ£€æŸ¥çŠ¶æ€


file_dir: package-lock.json

{
  "name": "ArchiveSystem",
  "lockfileVersion": 3,
  "requires": true,
  "packages": {
    "": {
      "dependencies": {
        "echarts": "^5.6.0"
      }
    },
    "node_modules/echarts": {
      "version": "5.6.0",
      "resolved": "https://registry.npmjs.org/echarts/-/echarts-5.6.0.tgz",
      "integrity": "sha512-oTbVTsXfKuEhxftHqL5xprgLoc0k7uScAwtryCgWF6hPYFLRwOUHiFmHGCBKP5NPFNkDVopOieyUqYGH8Fa3kA==",
      "license": "Apache-2.0",
      "dependencies": {
        "tslib": "2.3.0",
        "zrender": "5.6.1"
      }
    },
    "node_modules/tslib": {
      "version": "2.3.0",
      "resolved": "https://registry.npmjs.org/tslib/-/tslib-2.3.0.tgz",
      "integrity": "sha512-N82ooyxVNm6h1riLCoyS9e3fuJ3AMG2zIZs2Gd1ATcSFjSA23Q0fzjjZeh0jbJvWVDZ0cJT8yaNNaaXHzueNjg==",
      "license": "0BSD"
    },
    "node_modules/zrender": {
      "version": "5.6.1",
      "resolved": "https://registry.npmjs.org/zrender/-/zrender-5.6.1.tgz",
      "integrity": "sha512-OFXkDJKcrlx5su2XbzJvj/34Q3m6PvyCZkVPHGYpcCJ52ek4U/ymZyfuV1nKE23AyBJ51E/6Yr0mhZ7xGTO4ag==",
      "license": "BSD-3-Clause",
      "dependencies": {
        "tslib": "2.3.0"
      }
    }
  }
}


file_dir: main.py

import io
import zipfile
from PIL import Image
import re
import os
import json
from flask import (
    Flask, render_template, request, jsonify, redirect, url_for,
    session, send_from_directory, flash, abort, send_file
)
# from flask_session import Session # å¦‚æœéœ€è¦ Redis Sessionï¼Œå–æ¶ˆæ³¨é‡Š
import random
import datetime
from dateutil.relativedelta import relativedelta
from werkzeug.utils import secure_filename
import time
from functools import wraps
from config import HONOR_TYPE, LEVEL_TYPE # å‡è®¾ä½ çš„ config.py æœ‰è¿™ä¸¤ä¸ªåˆ—è¡¨
import markdown # <<< æ–°å¢ï¼šå¯¼å…¥ markdown åº“

# --- é…ç½® ---
SECRET_KEY = os.urandom(24)
UPLOAD_FOLDER = 'uploads'
ALLOWED_EXTENSIONS = {'png', 'jpg', 'jpeg', 'gif'}
USER_DATA_FILE = 'data/user.json'
HONORS_DATA_FILE = 'data/honors.json'
README_FILE = 'README.md' # <<< æ–°å¢ï¼šå®šä¹‰ README æ–‡ä»¶å

app = Flask(__name__)
app.secret_key = SECRET_KEY
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
app.config['SESSION_PERMANENT'] = True
app.config['SESSION_USE_SIGNER'] = True
app.config['PERMANENT_SESSION_LIFETIME'] = datetime.timedelta(days=7)

# --- æ—¥å¿— ---
logger = app.logger

# --- ç¡®ä¿ç›®å½•å’Œæ–‡ä»¶å­˜åœ¨ ---
# ... (ä¿æŒä¸å˜) ...
if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)
    logger.info(f"åˆ›å»ºä¸Šä¼ æ–‡ä»¶å¤¹: {UPLOAD_FOLDER}")

if not os.path.exists('data'):
    os.makedirs('data')
    logger.info("åˆ›å»ºæ•°æ®æ–‡ä»¶å¤¹: data")

if not os.path.exists(HONORS_DATA_FILE):
    with open(HONORS_DATA_FILE, 'w', encoding='utf-8') as f:
        json.dump({}, f)
    logger.info(f"åˆ›å»ºè£èª‰æ•°æ®æ–‡ä»¶: {HONORS_DATA_FILE}")

# --- è¾…åŠ©å‡½æ•° ---
# ... (parse_date_safe, allowed_file, load_data, save_data, load_honors_data, save_honors_data, load_user_data - ä¿æŒä¸å˜) ...
def parse_date_safe(date_str):
    """Safely parses YYYY-MM-DD string to date object, returns None on failure."""
    if not date_str:
        return None
    try:
        return datetime.datetime.strptime(date_str, '%Y-%m-%d').date()
    except (ValueError, TypeError):
        logger.warning(f"æ— æ³•è§£ææ—¥æœŸå­—ç¬¦ä¸²: '{date_str}'")
        return None

def allowed_file(filename):
    """æ£€æŸ¥æ–‡ä»¶æ‰©å±•åæ˜¯å¦å…è®¸"""
    return '.' in filename and \
           filename.rsplit('.', 1)[1].lower() in ALLOWED_EXTENSIONS

def load_data(filepath):
    """é€šç”¨åŠ è½½ JSON æ•°æ®å‡½æ•°"""
    try:
        with open(filepath, 'r', encoding='utf-8') as f:
            content = f.read()
            if not content: return {}
            return json.loads(content)
    except (FileNotFoundError, json.JSONDecodeError) as e:
        logger.error(f"æ— æ³•åŠ è½½æˆ–è§£ææ•°æ®æ–‡ä»¶ '{filepath}': {e}")
        return {}

def save_data(filepath, data):
    """é€šç”¨ä¿å­˜ JSON æ•°æ®å‡½æ•°"""
    try:
        with open(filepath, 'w', encoding='utf-8') as f:
            json.dump(data, f, ensure_ascii=False, indent=4)
    except IOError as e:
        logger.error(f"æ— æ³•å†™å…¥æ•°æ®æ–‡ä»¶ '{filepath}': {e}")

def load_honors_data():
    return load_data(HONORS_DATA_FILE)

def save_honors_data(data):
    save_data(HONORS_DATA_FILE, data)

def load_user_data():
    return load_data(USER_DATA_FILE)


# --- è£…é¥°å™¨ ---
def login_required(f):
    """ç™»å½•æ£€æŸ¥è£…é¥°å™¨"""
    @wraps(f)
    def decorated_function(*args, **kwargs):
        if 'logged_in' not in session or not session['logged_in']:
            flash("æ‚¨éœ€è¦å…ˆç™»å½•æ‰èƒ½è®¿é—®æ­¤é¡µé¢ã€‚", "warning")
            return redirect(url_for('login', next=request.url))
        return f(*args, **kwargs)
    return decorated_function

# --- è·¯ç”± ---

@app.after_request
def add_header(response):
    """æ·»åŠ é˜²ç¼“å­˜å¤´"""
    response.headers['Cache-Control'] = 'no-cache, no-store, must-revalidate'
    response.headers['Pragma'] = 'no-cache'
    response.headers['Expires'] = '0'
    return response

@app.context_processor
def inject_now():
    """å‘æ¨¡æ¿æ³¨å…¥å½“å‰æ—¶é—´ï¼Œç”¨äºé¡µè„š"""
    return {'now': datetime.datetime.utcnow}

# vvvvvvvvvv  ä¿®æ”¹éƒ¨åˆ†å¼€å§‹ vvvvvvvvvv
@app.route('/')
def index():
    """ä¸»é¡µæˆ–ç™»å½•é¡µ"""
    if session.get('logged_in'):
        return redirect(url_for('home'))

    # --- Removed README loading and processing logic ---
    # No need to read README.md or use markdown library here anymore
    # readme_content_html = None # Removed
    # try: ... except: block removed

    welcome = 'æ¬¢è¿æ¥åˆ°ä¸ªäººæˆå°±ç³»ç»Ÿ'
    # Render the template without the readme_html variable
    return render_template('index.html', msg=welcome)

@app.route('/home')
@login_required
def home():
    # ... (home è·¯ç”±ä¿æŒä¸å˜) ...
    username = session.get('username')
    users = load_user_data()

    user_info = users.get(username, {})
    current_motto = user_info.get('motto', '')

    response_data = {
        'username': username,
        'role': session.get('role'),
        'department': session.get('department'),
        'class': session.get('class'),
        'truename': session.get('truename'),
        'motto': current_motto,
        'honor_types': HONOR_TYPE,
        'honor_levels': LEVEL_TYPE
    }

    honors_data = load_honors_data()
    user_honors_raw = honors_data.get(username, [])

    total_honor_count_unfiltered = len(user_honors_raw)
    response_data['total_honor_count'] = total_honor_count_unfiltered

    all_possible_types = HONOR_TYPE
    honor_type_counts_unfiltered = {honor_type: 0 for honor_type in all_possible_types}
    for honor in user_honors_raw:
        honor_type = honor.get('type')
        if honor_type in honor_type_counts_unfiltered:
            honor_type_counts_unfiltered[honor_type] += 1
    response_data['honor_type_counts'] = honor_type_counts_unfiltered

    all_possible_levels = LEVEL_TYPE
    honor_level_counts_unfiltered = {level_type: 0 for level_type in all_possible_levels}
    for honor in user_honors_raw:
        honor_level = honor.get('honor_level') or honor.get('level')
        if honor_level in honor_level_counts_unfiltered:
            honor_level_counts_unfiltered[honor_level] += 1
    response_data['honor_level_counts'] = honor_level_counts_unfiltered

    selected_date_filter = request.args.get('filter_date', 'all')
    response_data['selected_date_filter'] = selected_date_filter
    today = datetime.date.today()
    cutoff_date = None
    try:
        if selected_date_filter == 'last_year':
            cutoff_date = today - relativedelta(years=1)
        elif selected_date_filter == 'last_3_years':
            cutoff_date = today - relativedelta(years=3)
        elif selected_date_filter == 'last_5_years':
            cutoff_date = today - relativedelta(years=5)
    except Exception as e:
        logger.error(f"è®¡ç®— cutoff_date æ—¶å‡ºé”™: {e}")
        cutoff_date = None

    filtered_honors = []
    if cutoff_date:
        for honor in user_honors_raw:
            honor_date = parse_date_safe(honor.get('date'))
            if honor_date and honor_date >= cutoff_date:
                filtered_honors.append(honor)
    else:
        filtered_honors = user_honors_raw

    user_honors_sorted_filtered = sorted(
        filtered_honors,
        key=lambda x: parse_date_safe(x.get('date')) or datetime.date.min,
        reverse=True
    )
    response_data['honors'] = user_honors_sorted_filtered

    return render_template('home.html', **response_data)


@app.route('/update_motto', methods=['POST'])
@login_required
def update_motto():
    # ... (update_motto è·¯ç”±ä¿æŒä¸å˜) ...
    username = session.get('username')
    if not username:
        return jsonify(success=False, error="ç”¨æˆ·æœªç™»å½•"), 401

    data = request.get_json()
    if data is None:
        return jsonify(success=False, error="æ— æ•ˆçš„è¯·æ±‚æ•°æ®æ ¼å¼ï¼Œè¯·å‘é€ JSON"), 400

    new_motto = data.get('motto', '')
    max_motto_length = 100
    if len(new_motto) > max_motto_length:
         return jsonify(success=False, error=f"ç­¾åè¿‡é•¿ï¼Œæœ€å¤š {max_motto_length} ä¸ªå­—ç¬¦"), 400

    users = load_user_data()
    if username in users:
        try:
            users[username]['motto'] = new_motto
            save_data(USER_DATA_FILE, users)
            logger.info(f"ç”¨æˆ· '{username}' æ›´æ–°ç­¾åä¸º: '{new_motto}'")
            return jsonify(success=True, message="ç­¾åæ›´æ–°æˆåŠŸï¼", new_motto=new_motto)
        except Exception as e:
            logger.error(f"ä¿å­˜ç”¨æˆ· '{username}' çš„æ–°ç­¾åæ—¶å‡ºé”™: {e}", exc_info=True)
            return jsonify(success=False, error="ä¿å­˜ç­¾åæ—¶å‘ç”ŸæœåŠ¡å™¨å†…éƒ¨é”™è¯¯"), 500
    else:
        logger.warning(f"å°è¯•æ›´æ–°ç­¾åçš„ç”¨æˆ· '{username}' ä¸å­˜åœ¨äºç”¨æˆ·æ•°æ®ä¸­")
        return jsonify(success=False, error="æ— æ³•æ‰¾åˆ°ç”¨æˆ·ä¿¡æ¯"), 404

@app.route('/logout')
@login_required
def logout():
    # ... (logout è·¯ç”±ä¿æŒä¸å˜) ...
    logger.info(f"ç”¨æˆ· '{session.get('username')}' é€€å‡ºç™»å½•")
    default_upload_folder = os.path.abspath('uploads')
    app.config['UPLOAD_FOLDER'] = default_upload_folder
    session.clear()
    flash("æ‚¨å·²æˆåŠŸé€€å‡ºç™»å½•ã€‚", "success")
    return redirect(url_for('index'))


@app.route('/login', methods=['POST', 'GET'])
def login():
    # Handle GET requests: If accessed directly, redirect to index page
    if request.method == 'GET':
        if session.get('logged_in'):
            return redirect(url_for('home')) # Already logged in, go home
        return redirect(url_for('index')) # Not logged in, show index page (which has the form)

    # Handle POST requests (form submission)
    if request.method == 'POST':
        username = request.form['name']
        password = request.form['password']
        users = load_user_data()

        # --- User loading error ---
        if not users:
             flash('ç™»å½•æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åå†è¯•ã€‚', 'error')
             # Render index page, passing back username if possible
             return render_template('index.html', username=username)

        # --- User found ---
        if username in users:
            # IMPORTANT: Use hashed password comparison in production!
            # Example: if check_password_hash(users[username]['password_hash'], password):
            if password == users[username]['password']: # Replace with secure check
                # --- Login Success ---
                session['logged_in'] = True
                session['username'] = users[username]['username']
                # Store other user details in session
                session['role'] = users[username].get('role', 'æœªçŸ¥è§’è‰²')
                session['department'] = users[username].get('department', '')
                session['class'] = users[username].get('class', '')
                session['truename'] = users[username].get('truename', username)
                session.permanent = True # Make session persistent if needed
                logger.info(f"ç”¨æˆ· '{username}' ç™»å½•æˆåŠŸ")

                flash(f"æ¬¢è¿å›æ¥, {session.get('truename', username)}ï¼", "success") # Use session value
                next_url = request.args.get('next')
                return redirect(next_url or url_for('home'))
            else:
                # --- Password Incorrect ---
                logger.warning(f"ç”¨æˆ· '{username}' å¯†ç é”™è¯¯")
                flash('ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯ã€‚', 'error')
                # Re-render index page with error, pass back username
                return render_template('index.html', username=username)
        else:
            # --- Username Not Found ---
            logger.warning(f"å°è¯•ä½¿ç”¨ä¸å­˜åœ¨çš„ç”¨æˆ·åç™»å½•: '{username}'")
            flash('ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯ã€‚', 'error')
            # Re-render index page with error, pass back username
            return render_template('index.html', username=username)

    # Fallback (shouldn't normally be reached for POST)
    return redirect(url_for('index'))


# ++++++++ æ–°å¢ï¼šæ³¨å†Œè·¯ç”±å ä½ç¬¦ ++++++++
@app.route('/register', methods=['GET'])
def register():
    """æ³¨å†Œé¡µé¢ (å ä½ç¬¦)"""
    # ç›®å‰åªæ˜¯æ˜¾ç¤ºä¸€ä¸ªä¿¡æ¯å¹¶é‡å®šå‘å›ä¸»é¡µ
    # æœªæ¥å¯ä»¥åœ¨è¿™é‡Œæ¸²æŸ“æ³¨å†Œè¡¨å•æ¨¡æ¿
    flash("æ³¨å†ŒåŠŸèƒ½æš‚æœªå¼€æ”¾ï¼Œæ•¬è¯·æœŸå¾…ï¼", "è¯·ä½ è€å¿ƒç­‰å¾…å“¦ï½")
    return redirect(url_for('index'))
# +++++++++++++++++++++++++++++++++++++++


@app.route('/add_honor', methods=['GET', 'POST'])
@login_required
def add_honor():
    # ... (add_honor è·¯ç”±ä¿æŒä¸å˜) ...
    username = session.get('username')
    honor_types = HONOR_TYPE
    honor_levels = LEVEL_TYPE
    current_upload_folder = os.path.join(UPLOAD_FOLDER, username)
    if not os.path.exists(current_upload_folder):
         try: os.makedirs(current_upload_folder)
         except OSError as e:
             logger.error(f"æ·»åŠ è£èª‰å‰æ— æ³•åˆ›å»ºç›®å½• '{current_upload_folder}': {e}")
             flash("æ— æ³•è®¿é—®å­˜å‚¨ç©ºé—´ï¼Œæ·»åŠ å¤±è´¥ã€‚", "error")
             return redirect(url_for('home'))

    if request.method == 'POST':
        honor_name = request.form.get('honor_name')
        honor_type = request.form.get('honor_type')
        honor_date = request.form.get('honor_date')
        honor_stamp = request.form.get('honor_stamp')
        honor_stamp_other = request.form.get('honor_stamp_other') or ""
        honor_image = request.files.get('honor_image')
        honor_level = request.form.get('honor_level')

        if not all([honor_name, honor_type, honor_level, honor_date, honor_stamp]):
            flash("è¯·å¡«å†™æ‰€æœ‰å¿…å¡«é¡¹ï¼ˆé™¤å›¾ç‰‡å¤–ï¼‰ã€‚", "error")
            form_data = request.form.to_dict()
            return render_template('add_honor.html', honor_types=honor_types, honor_levels=honor_levels, form_data=form_data)

        if not honor_image or honor_image.filename == '':
            flash("è¯·ä¸Šä¼ è£èª‰è¯æ˜å›¾ç‰‡ã€‚", "error")
            form_data = request.form.to_dict()
            return render_template('add_honor.html', honor_types=honor_types, honor_levels=honor_levels, form_data=form_data)
        if not allowed_file(honor_image.filename):
            flash("æ— æ•ˆçš„å›¾ç‰‡æ ¼å¼ï¼Œè¯·ä¸Šä¼  png, jpg, jpeg, gif æ–‡ä»¶ã€‚", "error")
            form_data = request.form.to_dict()
            return render_template('add_honor.html', honor_types=honor_types, honor_levels=honor_levels, form_data=form_data)

        try:
            # filename = secure_filename(honor_image.filename)
            # base, ext = os.path.splitext(filename)
            base, ext = os.path.splitext(honor_image.filename)
            ext = ext.lower()
            timestamp = int(time.time())
            rand_int = random.randint(100, 999)
            unique_filename = f"{username}_{timestamp}_{rand_int}{ext}"
            save_path = os.path.join(current_upload_folder, unique_filename)
            honor_image.save(save_path)
            logger.info(f"ç”¨æˆ· '{username}' ä¸Šä¼ åŸå§‹æ–‡ä»¶ '{unique_filename}' åˆ° '{current_upload_folder}' æˆåŠŸ")

            thumb_filename = None
            try:
                img = Image.open(save_path)
                # if img.mode in ('RGBA', 'P') and unique_filename.lower().endswith(('.jpg', '.jpeg')):
                #     img = img.convert('RGB')

                thumbnail_size = (400, 400)
                img.thumbnail(thumbnail_size, Image.Resampling.LANCZOS)

                # thumb_base, thumb_ext = os.path.splitext(unique_filename)
                thumb_base, thumb_ext = os.path.splitext(unique_filename)
                thumb_ext= thumb_ext.lower()
                thumb_filename = f"{thumb_base}_thumb{thumb_ext}"
                thumb_save_path = os.path.join(current_upload_folder, thumb_filename)
                img.save(thumb_save_path, quality=85, optimize=True)
                logger.info(f"ä¸º '{unique_filename}' ç”Ÿæˆç¼©ç•¥å›¾ '{thumb_filename}' æˆåŠŸ")
                img.close()
            except Exception as thumb_e:
                logger.error(f"ä¸º '{unique_filename}' ç”Ÿæˆç¼©ç•¥å›¾å¤±è´¥: {thumb_e}", exc_info=True)
                thumb_filename = None

        except Exception as e:
            logger.error(f"æ–‡ä»¶ä¸Šä¼ æˆ–å¤„ç†å¤±è´¥: {e}", exc_info=True)
            flash(f"æ–‡ä»¶ä¸Šä¼ æˆ–å¤„ç†å¤±è´¥: {e}", "error")
            form_data = request.form.to_dict()
            return render_template('add_honor.html', honor_types=honor_types, honor_levels=honor_levels, form_data=form_data)

        new_honor = {
            "id": f"honor_{timestamp}_{rand_int}",
            "name": honor_name,
            "type": honor_type,
            "date": honor_date,
            "stamp": honor_stamp,
            "stamp_other": honor_stamp_other,
            "image_filename": unique_filename,
            "honor_level": honor_level
            # "thumb_filename": thumb_filename # å¦‚æœéœ€è¦è®°å½•ç¼©ç•¥å›¾å
        }

        honors_data = load_honors_data()
        if username not in honors_data:
            honors_data[username] = []
        honors_data[username].append(new_honor)
        save_honors_data(honors_data)

        logger.info(f"ç”¨æˆ· '{username}' æ·»åŠ æ–°è£èª‰ '{honor_name}' (ID: {new_honor['id']}) æˆåŠŸ")
        flash(f"è£èª‰ '{honor_name}' æ·»åŠ æˆåŠŸï¼", "success")
        return redirect(url_for('home'))

    return render_template('add_honor.html', honor_types=honor_types, honor_levels=honor_levels)


@app.route('/edit_honor/<string:honor_id>', methods=['POST'])
@login_required
def edit_honor(honor_id):
    # ... (edit_honor è·¯ç”±ä¿æŒä¸å˜) ...
    username = session.get('username')
    honors_data = load_honors_data()
    current_upload_folder = os.path.join(UPLOAD_FOLDER, username)

    if username not in honors_data:
         return jsonify(success=False, error="æ— æ³•æ‰¾åˆ°ç”¨æˆ·æ•°æ®"), 404

    user_honors = honors_data[username]
    honor_to_edit = None
    honor_index = -1
    for i, honor in enumerate(user_honors):
        if honor.get('id') == honor_id:
            honor_to_edit = honor
            honor_index = i
            break

    if honor_to_edit is None:
        logger.warning(f"ç”¨æˆ· '{username}' å°è¯•ç¼–è¾‘ä¸å­˜åœ¨æˆ–ä¸å±äºè‡ªå·±çš„è£èª‰ ID: {honor_id}")
        return jsonify(success=False, error="æ— æ³•æ‰¾åˆ°æŒ‡å®šçš„è£èª‰è®°å½•ï¼Œæˆ–æ‚¨æ— æƒç¼–è¾‘ã€‚"), 404

    try:
        new_name = request.form.get('honor_name')
        new_type = request.form.get('honor_type')
        new_level = request.form.get('honor_level')
        new_date = request.form.get('honor_date')
        new_stamp = request.form.get('honor_stamp')
        new_stamp_other = request.form.get('honor_stamp_other', "")
        new_image_file = request.files.get('honor_image')

        if not all([new_name, new_type, new_level, new_date, new_stamp]):
             return jsonify(success=False, error="è¯·å¡«å†™æ‰€æœ‰å¿…å¡«é¡¹ã€‚"), 400

        old_filename = honor_to_edit.get('image_filename')
        updated_filename = old_filename

        if new_image_file and new_image_file.filename != '':
            if allowed_file(new_image_file.filename):
                try:
                    _, ext = os.path.splitext(new_image_file.filename)
                    ext = ext.lower()
                    timestamp = int(time.time())
                    rand_int = random.randint(100, 999)
                    updated_filename = f"{username}_{timestamp}_{rand_int}{ext}"
                    save_path = os.path.join(current_upload_folder, updated_filename)
                    new_image_file.save(save_path)
                    logger.info(f"ç”¨æˆ· '{username}' æ›´æ–°è£èª‰ '{honor_id}' çš„æ–°åŸå§‹å›¾ç‰‡ä¸º '{updated_filename}'")

                    try:
                        img = Image.open(save_path)
                        if img.mode in ('RGBA', 'P') and updated_filename.lower().endswith(('.jpg', '.jpeg')):
                           img = img.convert('RGB')
                        thumbnail_size = (400, 400)
                        img.thumbnail(thumbnail_size, Image.Resampling.LANCZOS)
                        thumb_base, thumb_ext = os.path.splitext(updated_filename)
                        thumb_filename_to_save = f"{thumb_base}_thumb{thumb_ext}"
                        thumb_save_path = os.path.join(current_upload_folder, thumb_filename_to_save)
                        img.save(thumb_save_path, quality=85, optimize=True)
                        logger.info(f"ä¸ºæ–°å›¾ç‰‡ '{updated_filename}' ç”Ÿæˆç¼©ç•¥å›¾ '{thumb_filename_to_save}' æˆåŠŸ")
                        img.close()
                    except Exception as thumb_e:
                        logger.error(f"ä¸ºæ–°å›¾ç‰‡ '{updated_filename}' ç”Ÿæˆç¼©ç•¥å›¾å¤±è´¥: {thumb_e}", exc_info=True)

                    if old_filename and old_filename != updated_filename:
                        old_path = os.path.join(current_upload_folder, old_filename)
                        if os.path.exists(old_path):
                            try: os.remove(old_path); logger.info(f"æˆåŠŸåˆ é™¤æ—§åŸå§‹å›¾ç‰‡: {old_filename}")
                            except OSError as e: logger.error(f"åˆ é™¤æ—§åŸå§‹å›¾ç‰‡å¤±è´¥ '{old_filename}': {e}")
                        old_base, old_ext = os.path.splitext(old_filename)
                        old_thumb_filename = f"{old_base}_thumb{old_ext}"
                        old_thumb_path = os.path.join(current_upload_folder, old_thumb_filename)
                        if os.path.exists(old_thumb_path):
                            try: os.remove(old_thumb_path); logger.info(f"æˆåŠŸåˆ é™¤æ—§ç¼©ç•¥å›¾: {old_thumb_filename}")
                            except OSError as e: logger.error(f"åˆ é™¤æ—§ç¼©ç•¥å›¾å¤±è´¥ '{old_thumb_filename}': {e}")

                except Exception as e:
                    logger.error(f"æ›´æ–°è£èª‰ '{honor_id}' çš„å›¾ç‰‡æ—¶å¤„ç†å¤±è´¥: {e}", exc_info=True)
                    return jsonify(success=False, error=f"å›¾ç‰‡å¤„ç†å¤±è´¥: {e}"), 500
            else:
                return jsonify(success=False, error="ä¸Šä¼ äº†æ— æ•ˆçš„å›¾ç‰‡æ ¼å¼ã€‚è¯·ä½¿ç”¨ png, jpg, jpeg, gifã€‚"), 400

        updated_honor_data = {
            "id": honor_id,
            "name": new_name,
            "type": new_type,
            "date": new_date,
            "stamp": new_stamp,
            "stamp_other": new_stamp_other,
            "image_filename": updated_filename,
            "honor_level": new_level
        }

        honors_data[username][honor_index] = updated_honor_data
        save_honors_data(honors_data)

        logger.info(f"ç”¨æˆ· '{username}' æˆåŠŸé€šè¿‡ API ç¼–è¾‘è£èª‰ ID: {honor_id}")
        return jsonify(
            success=True,
            message=f"è£èª‰ '{new_name}' æ›´æ–°æˆåŠŸï¼",
            updated_honor=updated_honor_data
        )

    except Exception as e:
        logger.error(f"ç¼–è¾‘è£èª‰ {honor_id} æ—¶å‘ç”ŸæœªçŸ¥é”™è¯¯: {e}", exc_info=True)
        return jsonify(success=False, error="æ›´æ–°è£èª‰æ—¶å‘ç”Ÿå†…éƒ¨é”™è¯¯ã€‚"), 500


@app.route('/uploads/<username>/<path:filename>')
@login_required
def uploaded_file_user(username, filename):
    # ... (uploaded_file_user è·¯ç”±ä¿æŒä¸å˜) ...
    if 'username' not in session or session['username'] != username:
         # if session.get('role') != 'admin': # Optional: Allow admins
         logger.warning(f"ç”¨æˆ· '{session.get('username')}' å°è¯•è®¿é—®ç”¨æˆ· '{username}' çš„æ–‡ä»¶: {filename}")
         abort(403)

    user_upload_folder = os.path.abspath(os.path.join(UPLOAD_FOLDER, username))
    safe_path = os.path.abspath(os.path.join(user_upload_folder, filename))
    if not safe_path.startswith(user_upload_folder):
        logger.warning(f"æ£€æµ‹åˆ°æ½œåœ¨çš„è·¯å¾„éå†å°è¯• (ç”¨æˆ·: {username}): {filename}")
        abort(404)

    if not os.path.isdir(user_upload_folder):
         logger.error(f"ç”¨æˆ· '{username}' çš„ä¸Šä¼ ç›®å½•ä¸å­˜åœ¨: {user_upload_folder}")
         abort(404)

    try:
        return send_from_directory(user_upload_folder, filename, as_attachment=False)
    except FileNotFoundError:
        logger.warning(f"å°è¯•è®¿é—®ç”¨æˆ· '{username}' ä¸å­˜åœ¨çš„æ–‡ä»¶: {filename} in {user_upload_folder}")
        abort(404)

@app.route('/delete_honor/<string:honor_id>', methods=['POST'])
@login_required
def delete_honor(honor_id):
    # ... (delete_honor è·¯ç”±ä¿æŒä¸å˜) ...
    username = session.get('username')
    honors_data = load_honors_data()
    current_upload_folder = os.path.join(UPLOAD_FOLDER, username)

    if username not in honors_data:
        flash("æ— æ³•æ‰¾åˆ°æ‚¨çš„è£èª‰æ•°æ®ã€‚", "error")
        return redirect(url_for('home'))

    user_honors = honors_data[username]
    honor_to_delete = None
    honor_index = -1

    for i, honor in enumerate(user_honors):
        if honor.get('id') == honor_id:
            honor_to_delete = honor
            honor_index = i
            break

    if honor_to_delete is None:
        logger.warning(f"ç”¨æˆ· '{username}' å°è¯•åˆ é™¤ä¸å­˜åœ¨æˆ–ä¸å±äºè‡ªå·±çš„è£èª‰ ID: {honor_id}")
        flash("æ— æ³•æ‰¾åˆ°è¦åˆ é™¤çš„è£èª‰è®°å½•ï¼Œæˆ–æ‚¨æ— æƒåˆ é™¤ã€‚", "error")
        return redirect(url_for('home'))

    deleted_honor_name = honor_to_delete.get('name', 'æœªçŸ¥è£èª‰')
    image_filename = honor_to_delete.get('image_filename')

    honors_data[username].pop(honor_index)
    save_honors_data(honors_data)

    if image_filename:
        original_path = os.path.join(current_upload_folder, image_filename)
        if os.path.exists(original_path):
            try:
                os.remove(original_path)
                logger.info(f"æˆåŠŸåˆ é™¤åŸå§‹å›¾ç‰‡: {image_filename} from {current_upload_folder}")
            except OSError as e:
                logger.error(f"åˆ é™¤åŸå§‹å›¾ç‰‡å¤±è´¥ '{image_filename}': {e}")
                flash(f"è®°å½•å·²åˆ é™¤ï¼Œä½†åˆ é™¤å›¾ç‰‡ '{image_filename}' æ—¶é‡åˆ°é—®é¢˜ã€‚", "warning")

        base, ext = os.path.splitext(image_filename)
        thumb_filename_to_delete = f"{base}_thumb{ext}"
        thumb_path = os.path.join(current_upload_folder, thumb_filename_to_delete)
        if os.path.exists(thumb_path):
            try:
                os.remove(thumb_path)
                logger.info(f"æˆåŠŸåˆ é™¤ç¼©ç•¥å›¾: {thumb_filename_to_delete} from {current_upload_folder}")
            except OSError as e:
                logger.error(f"åˆ é™¤ç¼©ç•¥å›¾å¤±è´¥ '{thumb_filename_to_delete}': {e}")
    else:
        logger.warning(f"è£èª‰è®°å½• '{honor_id}' æ²¡æœ‰å…³è”çš„ image_filename å­—æ®µï¼Œæ— æ³•åˆ é™¤æ–‡ä»¶ã€‚")

    logger.info(f"ç”¨æˆ· '{username}' æˆåŠŸåˆ é™¤è£èª‰ ID: {honor_id} (åç§°: {deleted_honor_name})")
    flash(f"è£èª‰ '{deleted_honor_name}' å·²æˆåŠŸåˆ é™¤ã€‚", "success")
    return redirect(url_for('home'))

# --- é”™è¯¯å¤„ç† ---
@app.errorhandler(404)
def page_not_found(e):
    return render_template('error.html', error_code=404, error_message="é¡µé¢æœªæ‰¾åˆ°"), 404

@app.errorhandler(500)
def internal_server_error(e):
    logger.error(f"æœåŠ¡å™¨å†…éƒ¨é”™è¯¯: {e}", exc_info=True)
    return render_template('error.html', error_code=500, error_message="æœåŠ¡å™¨å†…éƒ¨é”™è¯¯"), 500

# --- å…¶ä»–è·¯ç”± (honor_table, download_honor_image_jpg, download_honors_zip) ä¿æŒä¸å˜ ---
@app.route('/honor_table')
@login_required
def honor_table():
    """æ˜¾ç¤ºå½“å‰ç™»å½•ç”¨æˆ·è£èª‰çš„è¡¨æ ¼è§†å›¾, æ”¯æŒæ—¥æœŸç­›é€‰"""
    current_username = session.get('username')
    if not current_username:
        flash("ç”¨æˆ·æœªç™»å½•ã€‚", "error")
        return redirect(url_for('login'))

    logger.info(f"ç”¨æˆ· '{current_username}' æ­£åœ¨è®¿é—®è‡ªå·±çš„è£èª‰è¡¨æ ¼")
    try:
        honors_data = load_honors_data()
        user_data = load_user_data()
        user_honors_list_raw = honors_data.get(current_username, [])

        selected_date_filter = request.args.get('filter_date', 'all')
        logger.info(f"ç”¨æˆ· '{current_username}' ä½¿ç”¨æ—¥æœŸç­›é€‰: {selected_date_filter}")
        today = datetime.date.today()
        cutoff_date = None
        try:
            if selected_date_filter == 'last_year': cutoff_date = today - relativedelta(years=1)
            elif selected_date_filter == 'last_3_years': cutoff_date = today - relativedelta(years=3)
            elif selected_date_filter == 'last_5_years': cutoff_date = today - relativedelta(years=5)
        except Exception as e:
            logger.error(f"è®¡ç®— cutoff_date æ—¶å‡ºé”™: {e}")
            cutoff_date = None

        filtered_by_date_honors = []
        if cutoff_date:
            for honor in user_honors_list_raw:
                honor_date = parse_date_safe(honor.get('date'))
                if honor_date and honor_date >= cutoff_date:
                    filtered_by_date_honors.append(honor)
        else:
            filtered_by_date_honors = user_honors_list_raw

        processed_honors = []
        for honor in filtered_by_date_honors:
            honor_copy = honor.copy()
            honor_copy['display_level'] = honor.get('honor_level') or honor.get('level') or 'æœªæŒ‡å®š'
            processed_honors.append(honor_copy)

        processed_honors.sort(key=lambda x: parse_date_safe(x.get('date')) or datetime.date.min, reverse=True)
        logger.info(f"ä¸ºç”¨æˆ· '{current_username}' åŠ è½½äº† {len(processed_honors)} æ¡è£èª‰è®°å½• (æ—¥æœŸç­›é€‰: {selected_date_filter})")

        current_user_info = user_data.get(current_username, {})
        current_truename = current_user_info.get('truename', current_username)

        try: from config import HONOR_TYPE, LEVEL_TYPE
        except ImportError:
            logger.warning("æ— æ³•ä» config.py å¯¼å…¥ HONOR_TYPE æˆ– LEVEL_TYPEã€‚")
            HONOR_TYPE, LEVEL_TYPE = [], []

        response_data = {
            'honors': processed_honors, 'user_truename': current_truename,
            'selected_date_filter': selected_date_filter,
            'honor_types': HONOR_TYPE, 'honor_levels': LEVEL_TYPE
        }
        return render_template('honor_table.html', **response_data)

    except Exception as e:
        logger.error(f"ä¸ºç”¨æˆ· '{current_username}' ç”Ÿæˆè£èª‰è¡¨æ ¼æ—¶å‘ç”Ÿé”™è¯¯: {e}", exc_info=True)
        flash("åŠ è½½æ‚¨çš„è£èª‰åˆ—è¡¨æ—¶å‘ç”Ÿé”™è¯¯ï¼Œè¯·ç¨åå†è¯•ã€‚", "error")
        return redirect(url_for('home'))


def sanitize_filename(filename):
    """Removes or replaces characters invalid in filenames."""
    name = filename.strip('. ')
    name = re.sub(r'[\\/*?:"<>|]', '_', name)
    name = re.sub(r'_+', '_', name)
    return name[:200]


@app.route('/download_honor_image/<string:honor_id>/jpg')
@login_required
def download_honor_image_jpg(honor_id):
    """Downloads the image for a specific honor, converted to JPG."""
    current_username = session.get('username')
    logger.info(f"ç”¨æˆ· '{current_username}' è¯·æ±‚ä¸‹è½½è£èª‰ ID '{honor_id}' çš„ JPG å›¾ç‰‡")
    try:
        honors_data = load_honors_data()
        user_honors = honors_data.get(current_username, [])
        honor_to_download = next((h for h in user_honors if h.get('id') == honor_id), None)

        if not honor_to_download:
            logger.warning(f"ç”¨æˆ· '{current_username}' å°è¯•ä¸‹è½½æ— æ•ˆæˆ–ä¸å±äºè‡ªå·±çš„è£èª‰ ID: {honor_id}")
            abort(404, description="æ‰¾ä¸åˆ°æŒ‡å®šçš„è£èª‰è®°å½•æˆ–æ— æƒè®¿é—®ã€‚")

        image_filename = honor_to_download.get('image_filename')
        if not image_filename:
            logger.warning(f"è£èª‰ ID '{honor_id}' æ²¡æœ‰å…³è”çš„å›¾ç‰‡æ–‡ä»¶ã€‚")
            abort(404, description="è¯¥è£èª‰è®°å½•æ²¡æœ‰å…³è”çš„è¯æ˜æ–‡ä»¶ã€‚")

        user_upload_folder = os.path.abspath(os.path.join(UPLOAD_FOLDER, current_username))
        original_image_path = os.path.join(user_upload_folder, image_filename)

        if not os.path.exists(original_image_path):
            logger.error(f"ç”¨æˆ· '{current_username}' çš„å›¾ç‰‡æ–‡ä»¶ä¸å­˜åœ¨: {original_image_path}")
            abort(404, description="æ‰¾ä¸åˆ°å¯¹åº”çš„å›¾ç‰‡æ–‡ä»¶ã€‚")

        img = Image.open(original_image_path)
        output_buffer = io.BytesIO()
        original_mode = img.mode

        if img.mode in ('RGBA', 'P'):
            logger.debug(f"å›¾ç‰‡ '{image_filename}' (æ¨¡å¼: {img.mode}) æ­£åœ¨è½¬æ¢ä¸º RGB ç”¨äº JPG ä¿å­˜ã€‚")
            background = Image.new('RGB', img.size, (255, 255, 255))
            try: background.paste(img, mask=img.split()[3])
            except IndexError:
                 try: background.paste(img, mask=img.convert("RGBA").split()[3])
                 except Exception: background.paste(img)
            img.close()
            img = background
        elif img.mode != 'RGB':
             logger.debug(f"å›¾ç‰‡ '{image_filename}' (æ¨¡å¼: {img.mode}) æ­£åœ¨å°è¯•è½¬æ¢ä¸º RGBã€‚")
             try: img = img.convert('RGB')
             except Exception as conv_e:
                 logger.error(f"æ— æ³•å°†å›¾ç‰‡ '{image_filename}' (æ¨¡å¼: {original_mode}) è½¬æ¢ä¸º RGB: {conv_e}")
                 img.close()
                 abort(500, description="å›¾ç‰‡æ ¼å¼è½¬æ¢å¤±è´¥ã€‚")

        img.save(output_buffer, format='JPEG', quality=85, optimize=True)
        img.close()
        output_buffer.seek(0)

        honor_name = honor_to_download.get('name', 'honor')
        honor_date = honor_to_download.get('date', '')
        download_filename = sanitize_filename(f"{honor_name}_{honor_date}.jpg")
        logger.info(f"æˆåŠŸè½¬æ¢å›¾ç‰‡ '{image_filename}' ä¸º JPGï¼Œå‡†å¤‡å‘é€ä¸º '{download_filename}'")

        return send_file(output_buffer, mimetype='image/jpeg', as_attachment=True, download_name=download_filename)

    except FileNotFoundError:
         logger.error(f"æ–‡ä»¶æœªæ‰¾åˆ°é”™è¯¯å¤„ç†è£èª‰ID '{honor_id}' çš„ä¸‹è½½è¯·æ±‚ã€‚")
         abort(404, description="æ‰¾ä¸åˆ°å›¾ç‰‡æ–‡ä»¶ã€‚")
    except Exception as e:
        logger.error(f"ä¸‹è½½å¹¶è½¬æ¢è£èª‰å›¾ç‰‡ ID '{honor_id}' æ—¶å‘ç”Ÿé”™è¯¯: {e}", exc_info=True)
        abort(500, description="å¤„ç†å›¾ç‰‡ä¸‹è½½æ—¶å‘ç”ŸæœåŠ¡å™¨å†…éƒ¨é”™è¯¯ã€‚")


@app.route('/download_honors_zip', methods=['POST'])
@login_required
def download_honors_zip():
    """Creates a ZIP file containing JPGs for the requested honor IDs."""
    current_username = session.get('username')
    logger.info(f"ç”¨æˆ· '{current_username}' è¯·æ±‚æ‰¹é‡ä¸‹è½½è£èª‰å›¾ç‰‡ä¸º ZIP")

    if not request.is_json:
        logger.warning(f"ç”¨æˆ· '{current_username}' çš„æ‰¹é‡ä¸‹è½½è¯·æ±‚ä¸æ˜¯ JSON æ ¼å¼ã€‚")
        return jsonify(error="è¯·æ±‚å¿…é¡»æ˜¯ JSON æ ¼å¼"), 400

    data = request.get_json()
    honor_ids = data.get('honor_ids')

    if not isinstance(honor_ids, list) or not honor_ids:
        logger.warning(f"ç”¨æˆ· '{current_username}' çš„æ‰¹é‡ä¸‹è½½è¯·æ±‚ç¼ºå°‘æˆ–åŒ…å«æ— æ•ˆçš„ honor_ids åˆ—è¡¨ã€‚")
        return jsonify(error="è¯·æ±‚ä½“å¿…é¡»åŒ…å«ä¸€ä¸ªéç©ºçš„ 'honor_ids' åˆ—è¡¨"), 400

    logger.info(f"ç”¨æˆ· '{current_username}' è¯·æ±‚ä¸‹è½½çš„è£èª‰ IDs: {honor_ids}")

    try:
        honors_data = load_honors_data()
        user_honors_all = honors_data.get(current_username, [])
        user_upload_folder = os.path.abspath(os.path.join(UPLOAD_FOLDER, current_username))
        honors_to_zip_map = {h['id']: h for h in user_honors_all if h['id'] in honor_ids}

        if len(honors_to_zip_map) != len(honor_ids):
            missing_or_unowned = set(honor_ids) - set(honors_to_zip_map.keys())
            logger.warning(f"ç”¨æˆ· '{current_username}' è¯·æ±‚çš„ IDs åŒ…å«æ— æ•ˆæˆ–ä¸å±äºè‡ªå·±çš„è£èª‰: {missing_or_unowned}")
            return jsonify(error=f"éƒ¨åˆ†è¯·æ±‚çš„è£èª‰ ID æ— æ•ˆæˆ–ä¸å±äºæ‚¨: {', '.join(missing_or_unowned)}"), 403

        zip_buffer = io.BytesIO()
        processed_count, skipped_count = 0, 0
        processed_filenames = set()

        with zipfile.ZipFile(zip_buffer, 'w', zipfile.ZIP_DEFLATED) as zipf:
            for honor_id, honor in honors_to_zip_map.items():
                image_filename = honor.get('image_filename')
                if not image_filename:
                    logger.warning(f"è£èª‰ ID '{honor_id}' (åç§°: {honor.get('name')}) æ— å›¾ç‰‡æ–‡ä»¶ï¼Œè·³è¿‡ã€‚")
                    skipped_count += 1; continue

                original_image_path = os.path.join(user_upload_folder, image_filename)
                if not os.path.exists(original_image_path):
                    logger.warning(f"è£èª‰ ID '{honor_id}' çš„å›¾ç‰‡æ–‡ä»¶ '{original_image_path}' ä¸å­˜åœ¨ï¼Œè·³è¿‡ã€‚")
                    skipped_count += 1; continue

                img = None # Ensure img is defined for finally block
                try:
                    img = Image.open(original_image_path)
                    jpg_buffer = io.BytesIO()
                    original_mode = img.mode

                    if img.mode in ('RGBA', 'P'):
                         background = Image.new('RGB', img.size, (255, 255, 255))
                         try: background.paste(img, mask=img.split()[3])
                         except IndexError:
                             try: background.paste(img, mask=img.convert("RGBA").split()[3])
                             except Exception: background.paste(img)
                         img.close(); img = background
                    elif img.mode != 'RGB':
                         try: converted_img = img.convert('RGB'); img.close(); img = converted_img
                         except Exception as conv_e:
                            logger.error(f"ZIP: æ— æ³•å°†å›¾ç‰‡ '{image_filename}' (æ¨¡å¼: {original_mode}) è½¬ä¸º RGB: {conv_e}ï¼Œè·³è¿‡ã€‚")
                            skipped_count += 1; continue # Skip this image

                    img.save(jpg_buffer, format='JPEG', quality=85, optimize=True)
                    jpg_buffer.seek(0)

                    base_name = sanitize_filename(f"{honor.get('name', 'honor')}_{honor.get('date', '')}")
                    zip_entry_name = f"{base_name}.jpg"
                    counter = 1
                    while zip_entry_name in processed_filenames:
                        zip_entry_name = f"{base_name}_{counter}.jpg"; counter += 1
                    processed_filenames.add(zip_entry_name)

                    zipf.writestr(zip_entry_name, jpg_buffer.getvalue())
                    processed_count += 1
                    logger.debug(f"æˆåŠŸæ·»åŠ  '{zip_entry_name}' (æ¥è‡ª {image_filename}) åˆ° ZIP æ–‡ä»¶ã€‚")

                except Exception as img_proc_e:
                    logger.error(f"å¤„ç†è£èª‰ ID '{honor_id}' çš„å›¾ç‰‡ '{image_filename}' æ—¶å‡ºé”™: {img_proc_e}", exc_info=False)
                    skipped_count += 1
                finally:
                    if img and hasattr(img, 'close'): img.close() # Ensure image is closed


        zip_buffer.seek(0)
        zip_download_filename = f"{current_username}_honors_{datetime.date.today().strftime('%Y%m%d')}.zip"
        logger.info(f"ä¸ºç”¨æˆ· '{current_username}' åˆ›å»º ZIP æ–‡ä»¶å®Œæˆã€‚å¤„ç†: {processed_count}, è·³è¿‡: {skipped_count}ã€‚å‘é€ä¸º '{zip_download_filename}'")

        if processed_count == 0:
             return jsonify(error="æœªèƒ½æˆåŠŸå¤„ç†ä»»ä½•è¯·æ±‚çš„å›¾ç‰‡æ–‡ä»¶ã€‚"), 400

        flash(message='å·²ä¸ºä½ æˆåŠŸä¸‹è½½å½“å‰è§†å›¾çš„æ‰€æœ‰è£èª‰', category='è®°å¾—ä¸‹æ¬¡å†æ¥å‘€')
        return send_file(zip_buffer, mimetype='application/zip', as_attachment=True, download_name=zip_download_filename)

    except Exception as e:
        logger.error(f"åˆ›å»ºè£èª‰ ZIP æ–‡ä»¶æ—¶å‘ç”Ÿé”™è¯¯: {e}", exc_info=True)
        return jsonify(error="åˆ›å»º ZIP æ–‡ä»¶æ—¶å‘ç”ŸæœåŠ¡å™¨å†…éƒ¨é”™è¯¯ã€‚"), 500


# --- ä¸»ç¨‹åºå…¥å£ ---
if __name__ == '__main__':
    print(f"ä¸Šä¼ æ ¹ç›®å½•: {os.path.abspath(UPLOAD_FOLDER)}")
    print(f"è£èª‰æ•°æ®: {os.path.abspath(HONORS_DATA_FILE)}")
    print(f"ç”¨æˆ·æ•°æ®: {os.path.abspath(USER_DATA_FILE)}")
    print(f"å°†å°è¯•åŠ è½½READMEæ–‡ä»¶: {os.path.abspath(README_FILE)}") # <<< æ–°å¢ï¼šæç¤ºREADMEè·¯å¾„
    # ç¡®ä¿å®‰è£…äº† Markdown åº“: pip install Markdown
    app.run(debug=True, host='0.0.0.0', port=8888)

file_dir: utils/__init__.py

file_dir: utils/decorators.py

# å°†required_roleè£…é¥°å™¨ç§»åŠ¨åˆ° utils/decorators.py
from functools import wraps
from flask import abort, session, current_app, redirect, url_for
import redis

def required_role(roles):  # å¼ºåˆ¶è§’è‰²ä¸ºå­—ç¬¦ä¸²åˆ—è¡¨
    """
    æƒé™è£…é¥°å™¨ï¼Œæ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ‹¥æœ‰æŒ‡å®šçš„è§’è‰²ã€‚

    Args:
        roles: å…è®¸è®¿é—®çš„è§’è‰²åˆ—è¡¨ (å­—ç¬¦ä¸²åˆ—è¡¨)ã€‚

    Returns:
        è£…é¥°å™¨å‡½æ•°ã€‚
    """
    def decorator(f):
        @wraps(f)
        def decorated_function(*args, **kwargs):
            user_role = session.get('role')

            # 1. æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•ï¼ˆsessionä¸­æ˜¯å¦å­˜åœ¨roleï¼‰
            if not user_role:
                current_app.logger.warning("Unauthorized access: No role found in session.") # è®°å½•æ—¥å¿—
                abort(401)  # 401 Unauthorized æ›´åˆé€‚ï¼Œè¡¨ç¤ºéœ€è¦è®¤è¯

            # 2. æ£€æŸ¥ç”¨æˆ·è§’è‰²æ˜¯å¦åœ¨å…è®¸çš„è§’è‰²åˆ—è¡¨ä¸­
            if user_role not in roles:
                current_app.logger.warning(f"Unauthorized access: User role '{user_role}' not in allowed roles '{roles}'.") # è®°å½•æ—¥å¿—
                abort(403)  # 403 Forbiddenï¼Œè¡¨ç¤ºæ— æƒé™

            return f(*args, **kwargs)
        return decorated_function
    return decorator

def check_redis_session(f):
    @wraps(f)
    def decorated_function(*args, **kwargs):
        # å¦‚æœ session ä¸­æ²¡æœ‰ç”¨æˆ·æ ‡è¯†ï¼Œç›´æ¥è§†ä¸ºæœªç™»å½•
        if 'username' not in session:
            return redirect(url_for('index'))
        
        # è·å–æµè§ˆå™¨ä¸­çš„ session_id
        browser_session_id = session.sid  # Flask-Session æä¾›çš„ session ID
        
        # ä» Flask é…ç½®ä¸­è·å– Redis è¿æ¥
        redis_conn = current_app.config['SESSION_REDIS']
        
        # æ„é€  Redis ä¸­å­˜å‚¨ Session çš„é”®åï¼ˆéœ€ä¸ Flask-Session çš„å­˜å‚¨æ ¼å¼ä¸€è‡´ï¼‰
        redis_session_key = f"session:{browser_session_id}"
        
        # æ£€æŸ¥ Redis ä¸­æ˜¯å¦å­˜åœ¨æ­¤ Session
        if not redis_conn.exists(redis_session_key):
            # è‹¥ä¸å­˜åœ¨ï¼Œæ¸…ç©ºæµè§ˆå™¨ Session å¹¶é‡å®šå‘åˆ°ç™»å½•é¡µ
            session.clear()
            return redirect(url_for('index'))
        
        # å¦‚æœ Session æœ‰æ•ˆï¼Œæ­£å¸¸æ‰§è¡Œè·¯ç”±é€»è¾‘
        return f(*args, **kwargs)
    return decorated_function

file_dir: data/user_stats.json



file_dir: data/user_achievements.json



file_dir: data/user.json

{
    "lzy": {
        "username": "lzy",
        "truename": "åŠ³æŒ¯ç…œ",
        "password": "123456",
        "department": "ç»è‰ºç³»",
        "role": "super_admin",
        "class": 2221,
        "motto": "å‡†å¤‡å…¬å¼€è¯¾ã€è®ºæ–‡å’Œè¯¾é¢˜"
    },
    "tyy": {
        "username": "tyy",
        "truename": "é™¶äº‘äº‘",
        "password": "123456",
        "department": "ç»è‰ºç³»",
        "role": "super_admin",
        "class": -1,
        "motto": "åšæŒä¸æ‡ˆ"
    },
    "dh": {
        "username": "dh",
        "truename": "éƒ½èˆª",
        "password": "123456",
        "department": "ç»è‰ºç³»",
        "role": "super_admin",
        "class": 2430
    },
    "cyk": {
        "username": "cyk",
        "truename": "é™ˆå®‡å ƒ",
        "password": "123456",
        "department": "åˆ¶é€ ç³»",
        "role": "super_admin",
        "class": -1
    },
    "hm": {
        "username": "hm",
        "truename": "é»„æ˜",
        "password": "123456",
        "department": "åˆ¶é€ ç³»",
        "role": "super_admin",
        "class": -1
    }
}

file_dir: data/achievements.json

{
  "definitions": [
    {
      "id": "first_honor_added",
      "name": "åˆéœ²é”‹èŠ’",
      "description": "é¦–æ¬¡æˆåŠŸæ·»åŠ ä¸€é¡¹è£èª‰è®°å½•ã€‚",
      "icon": "â­"
    },
    {
      "id": "collect_all_types",
      "name": "è£èª‰æ”¶è—å®¶",
      "description": "æ”¶é›†åˆ°æ‰€æœ‰ç±»å‹çš„è£èª‰ã€‚",
      "icon": "ğŸ†"
    },
    {
      "id": "comp_guide_5",
      "name": "å›­ä¸åˆçº§",
      "description": "æŒ‡å¯¼å­¦ç”Ÿç«èµ›è·å¥–è¾¾åˆ° 5 é¡¹ã€‚",
      "icon": "ğŸŒ±"
    },
    {
      "id": "comp_guide_10",
      "name": "å›­ä¸ä¸­çº§",
      "description": "æŒ‡å¯¼å­¦ç”Ÿç«èµ›è·å¥–è¾¾åˆ° 10 é¡¹ã€‚",
      "icon": "ğŸŒ³"
    },
    {
      "id": "comp_guide_20",
      "name": "å›­ä¸é«˜çº§",
      "description": "æŒ‡å¯¼å­¦ç”Ÿç«èµ›è·å¥–è¾¾åˆ° 20 é¡¹ã€‚",
      "icon": "ğŸŒ²"
    },
    {
      "id": "comp_guide_100",
      "name": "å›­ä¸å¤§å¸ˆ",
      "description": "æŒ‡å¯¼å­¦ç”Ÿç«èµ›è·å¥–è¾¾åˆ° 100 é¡¹ã€‚",
      "icon": "ğŸ‘‘"
    },
    {
      "id": "first_download",
      "name": "æ‰“åŒ…èƒ½æ‰‹",
      "description": "é¦–æ¬¡æˆåŠŸæ‰“åŒ…ä¸‹è½½è£èª‰è¯æ˜ã€‚",
      "icon": "ğŸ“¦"
    },
    {
      "id": "frequent_downloader",
      "name": "ä¸‹è½½è¾¾äºº",
      "description": "ç´¯è®¡ä¸‹è½½è£èª‰è¯æ˜è¾¾åˆ° 10 æ¬¡ã€‚",
      "icon": "ğŸš€"
    }
  ]
}

file_dir: data/honors.json

{
    "lzy": [
        {
            "id": "honor_1745739221_3477",
            "name": "ç­ä¼šè¯¾è¯„æ¯”ä¸€ç­‰å¥–",
            "type": "æ•™å­¦æ¯”æ­¦",
            "date": "2025-04-27",
            "stamp": "å˜‰å–„æŠ€å¸ˆå­¦é™¢",
            "stamp_other": "",
            "image_filename": "lzy_1746751477_264.jpg",
            "honor_level": "æ ¡çº§"
        },
        {
            "id": "honor_1745739248_8855",
            "name": "åˆ›æ–°æ¯è¯´è¯¾çœä¸‰ç­‰å¥–",
            "type": "è¯´è¯¾",
            "date": "2024-06-04",
            "stamp": "çœèŒæˆæ•™åŠå…¬å®¤",
            "stamp_other": "",
            "image_filename": "lzy_1745758824_926_2024.jpeg",
            "honor_level": "çœçº§"
        },
        {
            "id": "honor_1746685247_521",
            "name": "2024é¢å‘äººäººè®¡ç®—æœºåº”ç”¨æ¯”èµ›ä¼˜ç§€æŒ‡å¯¼æ•™å¸ˆ",
            "type": "è£èª‰",
            "date": "2024-07-05",
            "stamp": "å˜‰å…´æ•™è‚²å­¦é™¢",
            "stamp_other": "",
            "image_filename": "lzy_1746751589_422.jpg",
            "honor_level": "å¸‚çº§"
        },
        {
            "id": "honor_1746685423_927",
            "name": "ç¬¬åå…«å±Šå¸‚æŠ€èƒ½èŠ‚å¤§æ•°æ®åº”ç”¨ä¸æœåŠ¡é¡¹ç›®ä¼˜ç§€æŒ‡å¯¼æ•™å¸ˆ",
            "type": "è£èª‰",
            "date": "2024-01-08",
            "stamp": "å˜‰å…´å¸‚æ•™è‚²å±€",
            "stamp_other": "",
            "image_filename": "lzy_1746751615_137.jpg",
            "honor_level": "å¸‚çº§"
        },
        {
            "id": "honor_1746685477_209",
            "name": "2023å¹´å˜‰å…´å¸‚èŒä¸šæ•™è‚²ä¼˜ç§€æ•™å­¦æ¡ˆä¾‹ä¸‰ç­‰å¥–",
            "type": "æŠ¥å‘Š",
            "date": "2023-12-21",
            "stamp": "å˜‰å…´æ•™è‚²å­¦é™¢",
            "stamp_other": "",
            "image_filename": "lzy_1746751634_952.png",
            "honor_level": "å¸‚çº§"
        },
        {
            "id": "honor_1746685541_985",
            "name": "å…¨å›½é’å°‘å¹´ä¿¡æ¯ç´ å…»å¤§èµ›æ€»å†³èµ›ä¼˜ç§€æŒ‡å¯¼æ•™å¸ˆ",
            "type": "è£èª‰",
            "date": "2024-08-01",
            "stamp": "å…¨å›½é’å°‘ä¿¡æ¯ç´ å…»å¤§èµ›ç»„å§”ä¼š",
            "stamp_other": "ä¸­å›½ç”µå­å­¦ä¼š",
            "image_filename": "lzy_1746751500_771.jpg",
            "honor_level": "å›½å®¶çº§"
        },
        {
            "id": "honor_1746685628_162",
            "name": "2024å¹´æµ™æ±ŸçœæŠ€èƒ½èŠ‚å¤§æ•°æ®åº”ç”¨ä¸æœåŠ¡é¡¹ç›®äºŒç­‰å¥–",
            "type": "å­¦ç”Ÿç«èµ›",
            "date": "2024-04-13",
            "stamp": "æµ™æ±Ÿçœä¸­ç­‰èŒä¸šå­¦æ ¡èŒä¸šèƒ½åŠ›å¤§èµ›ç»„å§”ä¼š",
            "stamp_other": "",
            "image_filename": "lzy_1746751606_833.jpg",
            "honor_level": "çœçº§"
        },
        {
            "id": "honor_1746685724_540",
            "name": "ç¬¬åå…«å±ŠæŠ€èƒ½èŠ‚Pythoné¡¹ç›®ä¼˜ç§€æŒ‡å¯¼æ•™å¸ˆ",
            "type": "è£èª‰",
            "date": "2024-01-08",
            "stamp": "å˜‰å…´å¸‚æ•™è‚²å±€",
            "stamp_other": "å˜‰å…´å¸‚äººåŠ›èµ„æºå’Œç¤¾ä¼šä¿éšœå±€",
            "image_filename": "lzy_1746751906_190.jpg",
            "honor_level": "å¸‚çº§"
        },
        {
            "id": "honor_1746685853_900",
            "name": "2023å¹´å¿æŠ€èƒ½èŠ‚Pythoné¡¹ç›®ä¼˜ç§€æŒ‡å¯¼æ•™å¸ˆ",
            "type": "è£èª‰",
            "date": "2023-06-01",
            "stamp": "å˜‰å–„å¿æ•™è‚²å±€",
            "stamp_other": "å˜‰å–„å¿ä¸­ç­‰ä¸“ä¸šå­¦æ ¡",
            "image_filename": "lzy_1746751644_602.jpg",
            "honor_level": "å¿çº§"
        },
        {
            "id": "honor_1746685908_723",
            "name": "2024å¹´å¿æŠ€èƒ½èŠ‚Pythoné¡¹ç›®ä¼˜ç§€æŒ‡å¯¼æ•™å¸ˆ",
            "type": "è£èª‰",
            "date": "2024-05-01",
            "stamp": "å˜‰å–„å¿æ•™è‚²å±€",
            "stamp_other": "å˜‰å–„å¿ä¸­ç­‰èŒä¸šå­¦æ ¡",
            "image_filename": "lzy_1746685908_723.jpg",
            "honor_level": "å¿çº§"
        },
        {
            "id": "honor_1746685962_220",
            "name": "2024å¹´å¿èŒä¸šé™¢æ ¡å¸ˆç”ŸèŒä¸šèƒ½åŠ›å¤§èµ›PythonäºŒç­‰å¥–",
            "type": "æŠ€èƒ½æ¯”æ­¦",
            "date": "2024-05-31",
            "stamp": "å˜‰å–„å¿æ•™è‚²å±€",
            "stamp_other": "å˜‰å–„å¿äººåŠ›èµ„æºå’Œç¤¾ä¼šä¿éšœå±€",
            "image_filename": "lzy_1746685962_220.jpg",
            "honor_level": "å¿çº§"
        },
        {
            "id": "honor_1746686005_472",
            "name": "ç¬¬åå…«å±Šå¸‚æŠ€èƒ½èŠ‚Pythoné¡¹ç›®ä¼˜ç§€æŒ‡å¯¼æ•™å¸ˆ",
            "type": "è£èª‰",
            "date": "2024-01-08",
            "stamp": "å˜‰å…´å¸‚æ•™è‚²å±€",
            "stamp_other": "å˜‰å…´å¸‚äººåŠ›èµ„æºå’Œç¤¾ä¼šä¿éšœå±€",
            "image_filename": "lzy_1746686005_472.jpg",
            "honor_level": "å¸‚çº§"
        },
        {
            "id": "honor_1746686040_541",
            "name": "2022å¹´å˜‰å…´å¸‚èŒä¸šå­¦æ ¡è®¡ç®—æœºä¸“ä¸šæ•™å¸ˆPythonä¸€ç­‰å¥–",
            "type": "æŠ€èƒ½æ¯”æ­¦",
            "date": "2022-11-01",
            "stamp": "å˜‰å…´æ•™è‚²å­¦é™¢",
            "stamp_other": "",
            "image_filename": "lzy_1746751658_524.jpg",
            "honor_level": "å¸‚çº§"
        },
        {
            "id": "honor_1746688630_756",
            "name": "åˆçº§èŒç§°",
            "type": "å…¶ä»–",
            "date": "2024-11-08",
            "stamp": "å˜‰å…´å¸‚äººåŠ›èµ„æºå’Œç¤¾ä¼šä¿éšœå±€",
            "stamp_other": "",
            "image_filename": "lzy_1746751460_652.jpeg",
            "honor_level": "å¸‚çº§"
        },
        {
            "id": "honor_1746688685_171",
            "name": "å…¨å›½é’å°‘å¹´ä¿¡æ¯ç´ å…»å¤§èµ›çœäºŒç­‰å¥– - æç²¢ç¿",
            "type": "å­¦ç”Ÿç«èµ›",
            "date": "2024-07-01",
            "stamp": "å…¨å›½é’å°‘å¹´ä¿¡æ¯ç´ å…»å¤§èµ›ç»„å§”ä¼š",
            "stamp_other": "ä¸­å›½ç”µå­å­¦ä¼š",
            "image_filename": "lzy_1746688685_171.jpeg",
            "honor_level": "çœçº§"
        },
        {
            "id": "honor_1746688728_640",
            "name": "å…¨å›½é’å°‘å¹´ä¿¡æ¯ç´ å…»å¤§èµ›å›½äºŒç­‰å¥– - æç²¢ç¿",
            "type": "å­¦ç”Ÿç«èµ›",
            "date": "2024-08-01",
            "stamp": "å…¨å›½é’å°‘å¹´ä¿¡æ¯ç´ å…»å¤§èµ›ç»„å§”ä¼š",
            "stamp_other": "ä¸­å›½ç”µå­å­¦ä¼š",
            "image_filename": "lzy_1746751953_213.jpeg",
            "honor_level": "å›½å®¶çº§"
        },
        {
            "id": "honor_1746688755_654",
            "name": "å…¨å›½é’å°‘å¹´ä¿¡æ¯ç´ å…»å¤§èµ›çœäºŒç­‰å¥– - åˆ˜æµ·",
            "type": "å­¦ç”Ÿç«èµ›",
            "date": "2024-07-01",
            "stamp": "å…¨å›½é’å°‘å¹´ä¿¡æ¯ç´ å…»å¤§èµ›ç»„å§”ä¼š",
            "stamp_other": "ä¸­å›½ç”µå­å­¦ä¼š",
            "image_filename": "lzy_1746688755_654.jpeg",
            "honor_level": "çœçº§"
        },
        {
            "id": "honor_1746688800_163",
            "name": "å…¨å›½é’å°‘å¹´ä¿¡æ¯ç´ å…»å¤§èµ›å›½äºŒç­‰å¥– - åˆ˜æµ·",
            "type": "å­¦ç”Ÿç«èµ›",
            "date": "2024-08-01",
            "stamp": "å…¨å›½é’å°‘å¹´ä¿¡æ¯ç´ å…»å¤§èµ›ç»„å§”ä¼š",
            "stamp_other": "ä¸­å›½ç”µå­å­¦ä¼š",
            "image_filename": "lzy_1746751546_410.jpeg",
            "honor_level": "å›½å®¶çº§"
        },
        {
            "id": "honor_1746688828_224",
            "name": "å…¨å›½é’å°‘å¹´ä¿¡æ¯ç´ å…»å¤§èµ›çœäºŒç­‰å¥– - å­™ç¿",
            "type": "å­¦ç”Ÿç«èµ›",
            "date": "2024-07-01",
            "stamp": "å…¨å›½é’å°‘å¹´ä¿¡æ¯ç´ å…»å¤§èµ›ç»„å§”ä¼š",
            "stamp_other": "ä¸­å›½ç”µå­å­¦ä¼š",
            "image_filename": "lzy_1746688828_224.jpeg",
            "honor_level": "çœçº§"
        },
        {
            "id": "honor_1746688892_875",
            "name": "å…¨å›½é’å°‘å¹´ä¿¡æ¯ç´ å…»å¤§èµ›å›½äºŒç­‰å¥– - å­™ç¿",
            "type": "å­¦ç”Ÿç«èµ›",
            "date": "2024-08-01",
            "stamp": "å…¨å›½é’å°‘å¹´ä¿¡æ¯ç´ å…»å¤§èµ›ç»„å§”ä¼š",
            "stamp_other": "ä¸­å›½ç”µå­å­¦ä¼š",
            "image_filename": "lzy_1746751556_976.jpeg",
            "honor_level": "å›½å®¶çº§"
        },
        {
            "id": "honor_1746688972_779",
            "name": "å…¨å›½é’å°‘å¹´ä¿¡æ¯ç´ å…»å¤§èµ›çœä¸€ç­‰å¥– - å¾å¤©æ™¨",
            "type": "å­¦ç”Ÿç«èµ›",
            "date": "2024-07-01",
            "stamp": "å…¨å›½é’å°‘å¹´ä¿¡æ¯ç´ å…»å¤§èµ›ç»„å§”ä¼š",
            "stamp_other": "ä¸­å›½ç”µå­å­¦ä¼š",
            "image_filename": "lzy_1746688972_779.jpeg",
            "honor_level": "çœçº§"
        },
        {
            "id": "honor_1746689004_907",
            "name": "å…¨å›½é’å°‘å¹´ä¿¡æ¯ç´ å…»å¤§èµ›å›½ä¸€ç­‰å¥– - å¾å¤©æ™¨",
            "type": "å­¦ç”Ÿç«èµ›",
            "date": "2024-08-01",
            "stamp": "å…¨å›½é’å°‘å¹´ä¿¡æ¯ç´ å…»å¤§èµ›ç»„å§”ä¼š",
            "stamp_other": "ä¸­å›½ç”µå­å­¦ä¼š",
            "image_filename": "lzy_1746751571_421.jpeg",
            "honor_level": "å›½å®¶çº§"
        }
    ],
    "dh": [
        {
            "id": "honor_1745761078_7535",
            "name": "123",
            "type": "è®ºæ–‡",
            "date": "2025-04-27",
            "stamp": "123",
            "stamp_other": "2345",
            "image_filename": "dh_1745761078_427_jpg",
            "honor_level": "æ ¡çº§"
        },
        {
            "id": "honor_1745761119_4679",
            "name": "åˆ›æ–°æ¯è¯´è¯¾çœä¸‰ç­‰å¥–",
            "type": "è¯´è¯¾",
            "date": "2021-02-09",
            "stamp": "çœèŒæˆæ•™åŠå…¬å®¤",
            "image_filename": "dh_1745761137_898_JPG",
            "honor_level": "çœçº§"
        },
        {
            "id": "honor_1745812123_7655",
            "name": "1",
            "type": "æˆæœ",
            "date": "2025-04-28",
            "stamp": "1",
            "stamp_other": "",
            "image_filename": "dh_1745812123_419_JPG",
            "honor_level": "æ ¡çº§"
        },
        {
            "id": "honor_1745812415_3470",
            "name": "1",
            "type": "æ•™å­¦æ¯”æ­¦",
            "date": "2025-04-22",
            "stamp": "12",
            "stamp_other": "12",
            "image_filename": "dh_1745812415_125_jpg",
            "honor_level": "å¿çº§"
        },
        {
            "id": "honor_1745813270_4855",
            "name": "112",
            "type": "æŠ¥å‘Š",
            "date": "2021-02-28",
            "stamp": "12",
            "stamp_other": "",
            "image_filename": "dh_1745813270_642_IMG_20240618_163506.jpg",
            "honor_level": "çœçº§"
        }
    ],
    "tyy": [
        {
            "id": "honor_1745824221_4269",
            "name": "123",
            "type": "æŠ¥å‘Š",
            "date": "2025-04-22",
            "stamp": "123",
            "stamp_other": "",
            "image_filename": "tyy_1745824221_151_1147.jpg",
            "honor_level": "å¿çº§"
        },
        {
            "id": "honor_1745824401_6823",
            "name": "123",
            "type": "è£èª‰",
            "date": "2000-02-12",
            "stamp": "12313",
            "stamp_other": "",
            "image_filename": "tyy_1745909087_842",
            "honor_level": "å¸‚çº§"
        },
        {
            "id": "honor_1745824451_5012",
            "name": "1231",
            "type": "è£èª‰",
            "date": "2022-01-21",
            "stamp": "12313",
            "image_filename": "tyy_1745824451_750_1191.jpg",
            "honor_level": "å¿çº§"
        }
    ]
}

