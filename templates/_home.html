<!DOCTYPE html>
{% extends "layout.html" %}

{% block title %}我的看板{% endblock %}

{% block head_extra %}
<link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.css" rel="stylesheet">

<style>
    /* --- 布局与通用样式 --- */
    .honor-section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem; /* 增加与下方内容的间距 */
        flex-wrap: wrap;
        gap: 1rem; /* 标题和筛选器之间的间距 */
    }

    .honor-filters-container {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 0.75rem; /* 筛选器之间的间距 */
    }

    .honor-filter-container .ts-control {
    flex-wrap: nowrap;
    overflow-x: auto; /* 当内容超出时，出现横向滚动条 */
    }

    /* 2. (可选) 美化滚动条，让其在大部分浏览器中隐藏，但保留滚动功能 */
    .honor-filter-container .ts-control {
        -ms-overflow-style: none;  /* IE and Edge */
        scrollbar-width: none;  /* Firefox */
    }
    .honor-filter-container .ts-control::-webkit-scrollbar {
        display: none; /* Chrome, Safari, Opera */
    }

    .honor-filter-container {
        /* 为筛选器容器设定一个最大宽度，防止被无限撑开 */
        max-width: 220px; 
        flex-grow: 1; /* 允许它在有空间时增长到最大宽度 */
    }

    /* 【新增】关键词搜索框样式 */
    .keyword-search-container {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex-grow: 1; /* 在小屏幕上允许其增长 */
        max-width: 250px;
    }

    .keyword-search-container input {
        width: 100%;
    }


    /* --- 个性签名编辑区域样式 --- */
    #motto-display-area {
        cursor: pointer;
        min-height: 2.5rem; /* 预留高度防止编辑按钮出现时布局跳动 */
    }
    #motto-display-area .btn {
        opacity: 0;
        transition: opacity 0.2s ease-in-out;
    }
    #motto-display-area:hover .btn {
        opacity: 0.7;
    }
    #motto-display-area .btn:hover {
        opacity: 1;
    }
    #motto-text {
        transition: color 0.2s;
    }
    #motto-display-area:hover #motto-text {
        color: hsl(var(--p)); /* 悬停时文本高亮 */
    }


    /* --- 编辑荣誉模态框样式 --- */
    #edit_honor_modal .modal-box { max-width: 48rem; width: 100%; }
    #edit_honor_modal .modal-content-grid { display: grid; grid-template-columns: 1fr 2fr; gap: 1.5rem; align-items: start; width: 100%; }
    #edit_honor_modal .modal-image-container { display: flex; flex-direction: column; align-items: center; }
    #edit_honor_modal .modal-image-container img { max-width: 100%; max-height: 300px; object-fit: contain; margin-bottom: 1rem; border-radius: 0.375rem; box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1); }

    /* 加载遮罩层 */
    .loading-overlay { position: absolute; inset: 0; background-color: rgba(255, 255, 255, 0.7); display: flex; align-items: center; justify-content: center; z-index: 10; border-radius: inherit; }

    /* 响应式调整 */
    @media (max-width: 768px) {
        #edit_honor_modal .modal-box { max-width: 95%; padding: 1.5rem 1rem; }
        #edit_honor_modal .modal-content-grid { grid-template-columns: 1fr; gap: 1rem; }
        #edit_honor_modal .modal-image-container { order: -1; }
        #edit_honor_modal .modal-image-container img { max-height: 200px; }
        .keyword-search-container { max-width: none; } /* 在移动端允许搜索框占满宽度 */
    }

    /* --- 其他微调 --- */
    .card figure img { will-change: transform; } /* 优化动画性能 */
    .toast { z-index: 9999 !important; } /* 确保 Toast 在最上层 */

            /* --- 【新增/修改】Tom Select 与 DaisyUI 融合样式 --- */
    :root {
        --ts-border-radius: var(--rounded-btn, 0.5rem);
        --ts-font-size: 0.875rem; /* 对应 input-sm */
        --ts-line-height: 1.25rem;
    }
    .ts-control {
        background-color: hsl(var(--b1)) !important;
        min-height: 2rem; /* 对应 DaisyUI 的 input-sm 高度 */
        max-height: 2rem;
        border-radius: 30px;
        box-shadow: none !important;
    }
    .ts-control:hover { border-color: hsl(var(--bc) / 0.3) !important; }
    .ts-control.focus {
        border-color: hsl(var(--p)) !important;
        box-shadow: 0 0 0 1px hsl(var(--p)) !important;
    }

    .ts-wrapper.is-filtered .ts-control {
        /* 将边框颜色变为主题的主色 */
        border-color: hsl(var(--p) / 0.8) !important;
        box-shadow: 0 0 0 1px hsl(var(--p) / 0.6) !important;
    }

    .ts-wrapper.is-filtered .ts-control input::placeholder {
        /* 将占位符文本颜色也变为主题的主色 */
        color: hsl(var(--p)) !important;
        opacity: 1; /* 确保颜色完全不透明 */
        font-weight: 500; /* 可以适当加粗，以示区别 */
    }

</style>
{% endblock %}

{% block content %}
<div class="space-y-8">

    {# --- 1. 个人信息与个性签名 Section --- #}
    <section>
    <h2 class="text-2xl font-semibold mb-4 divider divider-start">个人信息</h2>
    <div class="flex flex-col md:flex-row gap-6 bg-base-200 p-6 rounded-lg shadow">

        {# === 左侧：基本信息 (响应式横向排列) === #}
        <div class="flex-1 flex flex-col sm:flex-row sm:items-baseline gap-6">
            {# --- 姓名 --- #}
            <div>
                <div class="text-sm font-medium text-base-content/70 mb-1">姓名</div>
                <div class="text-2xl font-bold text-primary">{{ truename or username }}</div>
            </div>

            {# --- 专业 (带响应式分隔线) --- #}
            {% if major %}
            <div class="pt-2 sm:pt-0 sm:pl-6 sm:border-l sm:border-base-300">
                <div class="text-sm font-medium text-base-content/70 mb-1">专业</div>
                <div class="text-2xl font-bold text-secondary">{{ major }}</div>
            </div>
            {% endif %}

            {# --- 入职时长 (带响应式分隔线) --- #}
            {% if employment_duration %}
            <div class="pt-2 sm:pt-0 sm:pl-6 sm:border-l sm:border-base-300">
                <div class="text-sm font-medium text-base-content/70 mb-1">入职时长</div>
                <div class="text-2xl font-bold text-accent">{{ employment_duration }}</div>
            </div>
            {% endif %}
        </div>

        {# === 右侧：个性签名 === #}
        <div class="flex-1 md:border-l md:border-base-300 md:pl-6">
            <div class="text-sm font-medium text-base-content/70 mb-2">个性签名</div>
            {# --- 签名显示区域 --- #}
            <div id="motto-display-area" class="flex items-center group py-1">
                <span id="motto-text" class="text-base-content/90 mr-2 flex-grow italic" title="点击编辑签名">"{{ motto or '编辑您的个性签名...' }}"</span>
                <button id="edit-motto-btn" type="button" class="btn btn-ghost btn-xs p-1 focus:opacity-70" title="编辑签名">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" /></svg>
                </button>
            </div>
            {# --- 签名编辑区域 (默认隐藏) --- #}
            <div id="motto-edit-area" class="hidden">
                <div class="flex items-center gap-2">
                    <input type="text" id="motto-input" class="input input-bordered input-sm w-full flex-grow" placeholder="输入签名 (最多100字)" maxlength="100">
                    <button id="save-motto-btn" type="button" class="btn btn-primary btn-sm">
                        <span class="loading loading-spinner loading-xs hidden"></span>
                        保存
                    </button>
                    <button id="cancel-motto-btn" type="button" class="btn btn-ghost btn-sm">取消</button>
                </div>
                <div id="motto-error" class="text-error text-xs mt-1 h-4"></div>
            </div>
        </div>
    </div>
</section>

    {# --- 2. 荣誉统计 Section (显示全部时间的统计数据) --- #}
    <section>
    <div class="flex flex-wrap items-center justify-between gap-4 mb-3">
        <h2 class="text-xl font-semibold divider divider-start my-0 flex-shrink-0">荣誉统计</h2>
        {# 仅在有统计数据时显示切换按钮 #}

        <div class="btn-group">
            <button id="stats-toggle-type" class="btn btn-sm btn-active" onclick="switchStatsView('type')">按类型</button>
            <button id="stats-toggle-level" class="btn btn-sm" onclick="switchStatsView('level')">按等级</button>
        </div>

    </div>

    {# --- 统计数据展示区 --- #}
    {# 如果根据时间筛选后没有任何荣誉，显示统一的提示信息 #}

        {# 按类型统计 (默认显示) #}
        <div id="stats-by-type">
            <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 xl:grid-cols-6 gap-4 w-full">
                {# --- 总计卡片 (按类型) --- #}
                <div class="bg-base-200 shadow rounded-lg p-4 flex flex-col justify-center items-center text-center h-full">
                    <div class="text-sm font-medium text-base-content/70 mb-1">当前总计</div>
                    <div id="stats-total-count-type" class="text-3xl font-bold text-primary">{{ honors | length }}</div>
                    <div class="text-xs text-base-content/50 mt-1">项荣誉</div>
                </div>
                {# --- 各类型卡片 --- #}
                {% for type_name in honor_types %}
                <div class="bg-base-200 shadow rounded-lg p-4 flex flex-col justify-center items-center text-center h-full" data-stat-type="{{ type_name | escape }}">
                    <div class="text-sm font-medium text-base-content/70 mb-1">{{ type_name | escape }}</div>
                    <div class="stat-count text-3xl font-bold text-accent">0</div> {# 初始值由JS计算 #}
                    <div class="text-xs text-base-content/50 mt-1">项记录</div>
                </div>
                {% endfor %}
            </div>
        </div>
        {# 按等级统计 (默认隐藏) #}
        <div id="stats-by-level" class="hidden">
             <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 xl:grid-cols-6 gap-4 w-full">
                {# --- 总计卡片 (按等级) --- #}
                <div class="bg-base-200 shadow rounded-lg p-4 flex flex-col justify-center items-center text-center h-full">
                    <div class="text-sm font-medium text-base-content/70 mb-1">当前总计</div>
                    <div id="stats-total-count-level" class="text-3xl font-bold text-primary">{{ honors | length }}</div>
                    <div class="text-xs text-base-content/50 mt-1">项荣誉</div>
                </div>
                {# --- 各等级卡片 --- #}
                {% for level_name in honor_levels %}
                <div class="bg-base-200 shadow rounded-lg p-4 flex flex-col justify-center items-center text-center h-full" data-stat-level="{{ level_name | escape }}">
                    <div class="text-sm font-medium text-base-content/70 mb-1">{{ level_name | escape }}</div>
                    <div class="stat-count text-3xl font-bold text-accent">0</div> {# 初始值由JS计算 #}
                    <div class="text-xs text-base-content/50 mt-1">项记录</div>
                </div>
                {% endfor %}
            </div>
        </div>

</section>

    {# --- 3. 荣誉列表与筛选 Section --- #}
    <section>
        <div class="honor-section-header">
            {# 动态标题，显示当前时间范围 #}
            {% set filter_map = {'last_year': '一年内', 'last_3_years': '三年内', 'last_5_years': '五年内'} %}
            {% set filter_text = filter_map.get(selected_date_filter, '全部时间') %}
            {# 【新增】判断是否为自选时间段，并更新标题文本 #}
            {% if selected_date_filter == 'custom' and request.args.get('start_date') and request.args.get('end_date') %}
                {% set filter_text = request.args.get('start_date') + ' 至 ' + request.args.get('end_date') %}
            {% elif selected_date_filter == 'custom' %}
                {% set filter_text = '自选时间段' %}
            {% endif %}
            <h2 class="text-xl font-semibold divider divider-start my-0 flex-shrink-0">
                我的荣誉记录 <span class="text-base-content/70 font-normal">({{ filter_text }})</span>
            </h2>

            {# 筛选器容器 #}
            <div class="honor-filters-container">
                {# 【新增】关键词搜索框 #}
                <div class="keyword-search-container" title="按荣誉名称搜索当前列表">
                     <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4 opacity-70"><path fill-rule="evenodd" d="M9.965 11.026a5 5 0 1 1 1.06-1.06l2.755 2.754a.75.75 0 1 1-1.06 1.06l-2.755-2.754ZM10.5 7a3.5 3.5 0 1 1-7 0 3.5 3.5 0 0 1 7 0Z" clip-rule="evenodd" /></svg>
                    <input type="text" id="keyword-search-input" class="input input-bordered input-sm w-full" placeholder="搜索荣誉名称..."/>
                </div>

{# 【全新】使用 DaisyUI Dropdown 组件实现紧凑的时间筛选 #}
                <div class="dropdown dropdown-end">
                    {# 1. 这是下拉菜单的触发按钮，显示当前筛选状态 #}
                    <label tabindex="0" class="btn btn-sm btn-outline m-1 font-normal">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" /></svg>
                        <span>{{ filter_text }}</span> {# filter_text 变量来自页面顶部的标题逻辑，可复用 #}
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                    </label>

                    {# 2. 这是下拉菜单的内容区域 #}
                    <div tabindex="0" class="dropdown-content z-[10] menu p-4 shadow bg-base-200 rounded-box w-80 space-y-3">
                        <h4 class="font-bold px-4">按时间筛选</h4>
                        {# 预设的时间范围 #}
                        <ul class="menu p-0">
                            <li><a href="{{ url_for('home', filter_date='all') }}">全部时间</a></li>
                            <li><a href="{{ url_for('home', filter_date='last_year') }}">一年内</a></li>
                            <li><a href="{{ url_for('home', filter_date='last_3_years') }}">三年内</a></li>
                            <li><a href="{{ url_for('home', filter_date='last_5_years') }}">五年内</a></li>
                        </ul>
                        <div class="divider my-1">或自选范围</div>
                        {# 自选日期的表单 #}
                        <div class="space-y-2 px-2">
                            <div class="form-control">
                                <label class="label py-0"><span class="label-text-alt">开始日期</span></label>
                                <input type="date" id="start-date-input" name="start_date" class="input input-bordered input-sm"
                                       value="{{ request.args.get('start_date', '') }}" title="开始日期">
                            </div>
                            <div class="form-control">
                                 <label class="label py-0"><span class="label-text-alt">结束日期</span></label>
                                <input type="date" id="end-date-input" name="end_date" class="input input-bordered input-sm"
                                       value="{{ request.args.get('end_date', '') }}" title="结束日期" max="{{ now().strftime('%Y-%m-%d') }}">
                            </div>
                        </div>
                        <button id="apply-custom-date-btn" class="btn btn-secondary btn-sm w-full">应用自选范围</button>
                    </div>
                </div>
                {# 仅当当前列表有数据时，才显示客户端筛选器 #}
                {# 【全新】类型筛选 Dropdown #}
                <div class="dropdown dropdown-end">
                    <label tabindex="0" class="btn btn-sm btn-outline m-1 font-normal" id="type-filter-btn">
                        <span id="type-filter-label">筛选类型</span>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                    </label>
                    <div tabindex="0" id="type-filter-dropdown" class="dropdown-content z-[10] menu p-4 shadow bg-base-200 rounded-box w-60 space-y-1">
                        <h4 class="font-bold px-4 mb-2">选择类型</h4>
                        <div class="max-h-60 overflow-y-auto">
                        {% for type_option in honor_types %}
                            <div class="form-control">
                                <label class="label py-1 cursor-pointer">
                                    <span class="label-text">{{ type_option }}</span>
                                    <input type="checkbox" value="{{ type_option | escape }}" class="checkbox checkbox-sm checkbox-primary honor-type-cb"/>
                                </label>
                            </div>
                        {% endfor %}
                        </div>
                    </div>
                </div>
                {# 【全新】等级筛选 Dropdown #}
                <div class="dropdown dropdown-end">
                    <label tabindex="0" class="btn btn-sm btn-outline m-1 font-normal" id="level-filter-btn">
                        <span id="level-filter-label">筛选等级</span>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                    </label>
                    <div tabindex="0" id="level-filter-dropdown" class="dropdown-content z-[10] menu p-4 shadow bg-base-200 rounded-box w-60 space-y-1">
                         <h4 class="font-bold px-4 mb-2">选择等级</h4>
                         <div class="max-h-60 overflow-y-auto">
                        {% for level_option in honor_levels %}
                            <div class="form-control">
                                <label class="label py-1 cursor-pointer">
                                    <span class="label-text">{{ level_option }}</span>
                                    <input type="checkbox" value="{{ level_option | escape }}" class="checkbox checkbox-sm checkbox-primary honor-level-cb"/>
                                </label>
                            </div>
                        {% endfor %}
                        </div>
                    </div>
                </div>

                <button id="reset-filters-btn" class="btn btn-primary btn-sm" title="重置全部筛选">重置筛选
                </button>

            </div>
        </div>

        {# 荣誉卡片网格 #}
        {% if honors %}
            <div id="honors-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-4 gap-6 mt-4">
                {% for honor in honors %}
                    {# *** 关键：统一处理 level / honor_level 兼容问题 *** #}
                    {% set current_level = honor.honor_level or honor.level %}
                    <div id="card-{{ honor.id }}"
                         class="card bg-base-100 shadow-xl transition-shadow duration-300 hover:shadow-2xl group overflow-hidden"
                         data-type="{{ honor.type | escape }}"
                         data-level="{{ current_level | default('', true) | escape }}"
                         data-name="{{ honor.name | escape }}"
                         onmouseenter="preloadImage('{{ url_for('uploaded_file_user', username=username, filename=honor.image_filename) }}')">
                        {# 设定图片容器，防止图片加载时布局跳动 #}
                        <figure class="relative cursor-pointer overflow-hidden h-64 w-full bg-base-200" onclick="showImageModal('{{ url_for('uploaded_file_user', username=username, filename=honor.image_filename) }}', '{{ honor.name | escape | replace("'", "\\'") }}')">
                            {% set parts = honor.image_filename.rsplit('.', 1) %}
                            {% set thumb_filename = parts[0] + '_thumb.' + parts[1] if parts|length == 2 else honor.image_filename %}
                            <img id="img-thumb-{{ honor.id }}"
                                 src="{{ url_for('uploaded_file_user', username=username, filename=thumb_filename) }}"
                                 loading="lazy"
                                 alt="{{ honor.name }} 缩略图" loading="lazy"
                                 class="object-cover h-full w-full"
                                 onerror="this.onerror=null; this.src='{{ url_for('uploaded_file_user', username=username, filename=honor.image_filename) }}';" />
                        </figure>
                        <div class="card-body p-4">
                            <h3 id="card-title-{{ honor.id }}" class="card-title text-base lg:text-lg font-semibold truncate" title="{{ honor.name }}">{{ honor.name }}</h3>
                            <div class="text-sm text-base-content/80 space-y-1 mt-2">
                                <p><span class="font-medium text-base-content/60">类型:</span> <span id="card-type-{{ honor.id }}">{{ honor.type }}</span></p>
                                {% if current_level %}
                                <p><span class="font-medium text-base-content/60">等级:</span> <span id="card-level-{{ honor.id }}">{{ current_level }}</span></p>
                                {% endif %}
                                <p><span class="font-medium text-base-content/60">时间:</span> <span id="card-date-{{ honor.id }}">{{ honor.date }}</span></p>
                                <p><span class="font-medium text-base-content/60">单位:</span> <span id="card-stamp-{{ honor.id }}" title="{{ honor.stamp }}">{{ honor.stamp | truncate(20) }}</span></p>
                            </div>
                            <div class="card-actions justify-end mt-3 items-center space-x-2">
                                {# 编辑按钮：通过 data-* 属性传递所有需要的数据 #}
                                <button type="button" id="edit-btn-{{ honor.id }}" class="btn btn-xs sm:btn-sm btn-outline btn-primary" title="编辑"
                                        onclick="openEditModal(this)"
                                        data-id="{{ honor.id }}"
                                        data-name="{{ honor.name | escape }}"
                                        data-type="{{ honor.type | escape }}"
                                        data-level="{{ current_level | default('', true) | escape }}"
                                        data-date="{{ honor.date }}"
                                        data-stamp="{{ honor.stamp | escape }}"
                                        data-stamp-other="{{ honor.stamp_other | default('', true) | escape }}"
                                        data-image-url="{{ url_for('uploaded_file_user', username=username, filename=honor.image_filename) }}">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" /></svg>
                                    <span class="hidden sm:inline ml-1">编辑</span>
                                </button>
                                {# 删除按钮：使用表单提交，并添加二次确认 #}
                                <form method="post" action="{{ url_for('delete_honor', honor_id=honor.id) }}" onsubmit="return confirm('警告：您确定要永久删除 “{{ honor.name | escape | replace("'", "\\'") }}” 这条荣誉记录吗？\n\n此操作将同时删除关联的图片文件，且无法撤销！');" style="display: inline;">
                                    <button type="submit" class="btn btn-xs sm:btn-sm btn-outline btn-secondary" title="删除">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" /></svg>
                                        <span class="hidden sm:inline ml-1">删除</span>
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
            {# 当客户端筛选后无结果时显示的消息 #}
            <div id="no-honors-message" class="alert alert-warning mt-6 shadow-md hidden" role="alert">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 3.75h.008v.008H12v-.008Z" /></svg>
                <span>在当前列表（{{ filter_text }}）中，未找到符合所选条件的荣誉记录。</span>
                <button class="btn btn-sm btn-ghost" onclick="resetClientFilters()">重置筛选</button>
            </div>

        {% else %}
             <div class="alert alert-info mt-6 shadow-md">
                 <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                 {% if selected_date_filter != 'all' %}
                    <span>在选定的时间范围（{{ filter_text }}）内没有荣誉记录。请尝试选择 <a href="{{ url_for('home', filter_date='all') }}" class="link link-primary">全部时间</a> 或 <a href="{{ url_for('add_honor') }}" class="link link-secondary">添加一条新荣誉</a>。</span>
                 {% else %}
                    <span>您还没有添加任何荣誉记录。现在就去 <a href="{{ url_for('add_honor') }}" class="link link-primary">添加第一条</a> 吧！</span>
                 {% endif %}
            </div>
        {% endif %}
    </section>

</div>

{# ====================================================== #}
{# ================= MODAL DEFINITIONS ================== #}
{# ====================================================== #}

{# --- 编辑荣誉 Modal --- #}
<dialog id="edit_honor_modal" class="modal modal-bottom sm:modal-middle">
    <div class="modal-box relative">
        {# Loading 遮罩层 #}
        <div id="edit_modal_loading" class="loading-overlay hidden">
            <span class="loading loading-spinner loading-lg text-primary"></span>
        </div>

        <div class="modal-content-grid">
            {# 左侧图片展示 #}
            <div class="modal-image-container">
                <img id="edit_modal_image" src="" alt="当前荣誉图片" />
                <span class="text-xs text-base-content/60 mt-2">当前图片</span>
            </div>
            {# 右侧编辑表单 #}
            <div class="modal-form-container">
                <form id="edit_honor_form" class="space-y-3">
                    <h3 class="font-bold text-lg mb-3 text-center md:text-left">编辑荣誉信息</h3>
                    <input type="hidden" id="edit_honor_id" name="honor_id">

                    {# 各个表单字段 #}
                    <div class="form-control w-full">
                        <label class="label py-1" for="edit_honor_name"><span class="label-text font-medium">荣誉名称 <span class="text-error">*</span></span></label>
                        <input type="text" id="edit_honor_name" name="honor_name" class="input input-sm input-bordered w-full" required />
                    </div>
                    <div class="form-control w-full">
                        <label class="label py-1" for="edit_honor_type"><span class="label-text font-medium">荣誉类型 <span class="text-error">*</span></span></label>
                        <select id="edit_honor_type" name="honor_type" class="select select-sm select-bordered w-full" required>
                            <option value="" disabled>请选择类型</option>
                            {% for type_option in honor_types %}<option value="{{ type_option | escape }}">{{ type_option }}</option>{% endfor %}
                        </select>
                    </div>
                    <div class="form-control w-full">
                        <label class="label py-1" for="edit_honor_level"><span class="label-text font-medium">荣誉等级 <span class="text-error">*</span></span></label>
                        <select id="edit_honor_level" name="honor_level" class="select select-sm select-bordered w-full" required>
                            <option value="" disabled>请选择等级</option>
                            {% for level_option in honor_levels %}<option value="{{ level_option | escape }}">{{ level_option }}</option>{% endfor %}
                        </select>
                    </div>
                    <div class="form-control w-full">
                        <label class="label py-1" for="edit_honor_date"><span class="label-text font-medium">获得时间 <span class="text-error">*</span></span></label>
                        <input type="date" id="edit_honor_date" name="honor_date" class="input input-sm input-bordered w-full" required max="{{ now().strftime('%Y-%m-%d') }}"/>
                    </div>
                    <div class="form-control w-full">
                        <label class="label py-1" for="edit_honor_stamp"><span class="label-text font-medium">颁发单位 <span class="text-error">*</span></span></label>
                        <input type="text" id="edit_honor_stamp" name="honor_stamp" class="input input-sm input-bordered w-full" required />
                    </div>
                    <div class="form-control w-full">
                        <label class="label py-1" for="edit_honor_stamp_other"><span class="label-text font-medium">颁发单位2 (可选)</span></label>
                        <input type="text" id="edit_honor_stamp_other" name="honor_stamp_other" class="input input-sm input-bordered w-full" />
                    </div>
                    <div class="form-control w-full">
                        <label class="label py-1" for="edit_honor_image_file"><span class="label-text font-medium">替换证明文件 (可选, 支持PDF)</span></label>
                        <input type="file" id="edit_honor_image_file" name="honor_image" class="file-input file-input-sm file-input-bordered file-input-secondary w-full" accept=".png,.jpg,.jpeg,.gif,.pdf" />
                        <div id="edit-upload-status" class="label-text-alt text-xs mt-1 min-h-[1rem]"></div>
                        <label class="label py-0"><span class="label-text-alt text-xs">不选则保留原图。PDF文件将被自动转换为图片。</span></label>
                    </div>

                    {# 错误信息显示区域 #}
                    <div id="edit_modal_error" class="text-error text-sm mt-2 hidden min-h-[1.25rem]"></div>
                    {# 操作按钮 #}
                    <div class="modal-action mt-4 justify-end space-x-2">
                        <button type="button" class="btn btn-sm btn-ghost" onclick="closeEditModal()">取消</button>
                        <button type="submit" class="btn btn-sm btn-primary">确认修改</button>
                    </div>
                </form>
            </div>
        </div>
        <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2" onclick="closeEditModal()">✕</button>
    </div>
    {# 点击背景关闭 Modal #}
    <form method="dialog" class="modal-backdrop">
        <button type="button" onclick="closeEditModal()">close</button>
    </form>
</dialog>




{# --- 全局成功提示 Toast --- #}
<div id="toast-success" class="toast toast-top toast-center hidden">
    <div class="alert alert-success shadow-lg">
        <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
        <span id="toast-success-message">操作成功！</span>
    </div>
</div>

{% endblock %}


{# ====================================================== #}
{# ================ JAVASCRIPT SECTION ================== #}
{# ====================================================== #}
{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>
<script src="https://mozilla.github.io/pdf.js/build/pdf.js"></script>
<script>
    // 设置 workerSrc 以确保 pdf.js 能正常工作
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://mozilla.github.io/pdf.js/build/pdf.worker.js';
</script>

<script>

// 鼠标悬停预加载
    const preloadedImages = new Set();

    function preloadImage(url) {
        // 如果这个URL的图片还没开始加载
        if (!preloadedImages.has(url)) {
            // 创建一个新的Image对象，把它当成一个看不见的<img>标签
            const img = new Image();
            // 将它的src指向我们的大图URL，浏览器就会开始下载
            img.src = url;
            // 将URL添加到集合中，标记为已开始加载
            preloadedImages.add(url);
            // console.log('Preloading image:', url); // (调试用，可以删除)
        }
    }

// === 【新增】PDF处理的核心函数 (可复用) ===
/**
 * 处理文件输入事件，如果是PDF则进行转换
 * @param {Event} event - 文件选择事件
 * @param {HTMLInputElement} fileInputElement - 文件输入元素
 * @param {HTMLElement} statusElement - 用于显示状态的元素
 */
async function handleFileSelect(event, fileInputElement, statusElement) {
    statusElement.textContent = ''; // 清空旧状态
    const file = event.target.files[0];

    if (!file) {
        return;
    }

    // 如果文件类型是PDF，则启动转换流程
    if (file.type === 'application/pdf') {
        statusElement.textContent = '正在处理PDF文件，请稍候...';
        statusElement.className = 'label-text-alt text-xs mt-1 text-primary';

        try {
            // 将PDF转换为JPG文件对象
            const imageFile = await convertPdfToImage(file);
            
            // 使用 DataTransfer API 来创建一个新的 FileList
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(imageFile);

            // 将输入框中的文件替换为新生成的图片文件
            fileInputElement.files = dataTransfer.files;

            statusElement.textContent = '✅ PDF已成功转换为图片，您可以提交了。';
            statusElement.className = 'label-text-alt text-xs mt-1 text-success';

        } catch (error) {
            console.error('PDF conversion failed:', error);
            statusElement.textContent = `❌ PDF处理失败: ${error.message}. 请尝试上传图片文件。`;
            statusElement.className = 'label-text-alt text-xs mt-1 text-danger';
            // 清空文件选择，防止提交损坏的数据
            fileInputElement.value = ''; 
        }
    }
}

/**
 * 使用 pdf.js 将 PDF 文件的第一页转换为一个图片 File 对象
 * @param {File} pdfFile - 用户选择的PDF文件
 * @returns {Promise<File>} - 返回一个解析为JPG图片文件的Promise
 */
function convertPdfToImage(pdfFile) {
    return new Promise((resolve, reject) => {
        const fileReader = new FileReader();

        fileReader.onload = function() {
            const typedarray = new Uint8Array(this.result);
            
            pdfjsLib.getDocument(typedarray).promise.then(pdf => {
                // 获取第一页
                return pdf.getPage(1);
            }).then(page => {
                const scale = 1.5; // 可以调整缩放比例以控制图片清晰度
                const viewport = page.getViewport({ scale: scale });

                // 创建一个 Canvas 元素
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.height = viewport.height;
                canvas.width = viewport.width;

                // 将PDF页面渲染到Canvas上
                const renderContext = {
                    canvasContext: context,
                    viewport: viewport
                };

                page.render(renderContext).promise.then(() => {
                    // 将Canvas内容转换为Blob对象 (JPG格式)
                    canvas.toBlob(blob => {
                        // 从Blob创建一个新的File对象
                        const newFileName = pdfFile.name.replace(/\.pdf$/i, '.jpg');
                        const imageFile = new File([blob], newFileName, {
                            type: 'image/jpeg',
                            lastModified: Date.now()
                        });
                        resolve(imageFile);
                    }, 'image/jpeg', 0.9); // 0.9 是图片质量
                });
            }).catch(error => {
                reject(error);
            });
        };

        fileReader.onerror = (error) => reject(error);
        fileReader.readAsArrayBuffer(pdfFile);
    });
}


document.addEventListener('DOMContentLoaded', () => {
    console.log("DOM fully loaded and parsed. Initializing scripts.");
    // 【修改后的最终代码】
    const tomSelectSettings = {
        plugins: {
            'checkbox_options': {}
        },
        create: false,
        maxItems: null,
        closeAfterSelect: false,
        render: {
            /**
            * 【终极解决方案】
            * 1. 我们返回一个真实的 <div> 元素，来满足 checkbox_options 插件的内部依赖。
            * 2. 我们给这个 <div> 加上 style="display: none;" 的内联样式。
            * 3. 这使得该元素虽然存在于DOM中，但浏览器在渲染时会完全忽略它，
            * 它既不可见，也不占据任何宽度、高度或边距。
            * 这样就同时满足了“插件能正常工作”和“UI上看不出任何东西”两个条件。
            */
            item: function(data, escape) {
                return '<div style="display: none;"></div>';
            }
        },
        onInitialize: function() {
            // 解决 daisyUI 主题切换后样式丢失问题
            this.wrapper.style.color = 'hsl(var(--bc))';
        }
    };
    const typeSelect = document.getElementById('honor-type-filter');
    const levelSelect = document.getElementById('honor-level-filter');
    let tomTypeInstance, tomLevelInstance;
    if (typeSelect) {
        tomTypeInstance = new TomSelect(typeSelect, tomSelectSettings);
        tomTypeInstance.originalPlaceholder = typeSelect.getAttribute('placeholder');
    }
    if (levelSelect) {
        tomLevelInstance = new TomSelect(levelSelect, tomSelectSettings);
        tomLevelInstance.originalPlaceholder = levelSelect.getAttribute('placeholder');
    }
    if (tomTypeInstance) {
        updateTomSelectPlaceholder(tomTypeInstance, tomTypeInstance.getValue());
    }
    if (tomLevelInstance) {
        updateTomSelectPlaceholder(tomLevelInstance, tomLevelInstance.getValue());
    }


    // ==========================================================
    // --- 全局 DOM 元素引用 (移到最前面以避免初始化错误) ---
    // ==========================================================
    // 个性签名
    const mottoDisplayArea = document.getElementById('motto-display-area');
    const mottoTextSpan = document.getElementById('motto-text');
    const mottoEditArea = document.getElementById('motto-edit-area');
    const mottoInput = document.getElementById('motto-input');
    const saveMottoBtn = document.getElementById('save-motto-btn');
    const cancelMottoBtn = document.getElementById('cancel-motto-btn');
    const mottoErrorDiv = document.getElementById('motto-error');
    const saveMottoLoading = saveMottoBtn ? saveMottoBtn.querySelector('.loading') : null;

    // 荣誉统计
    const statsByTypeDiv = document.getElementById('stats-by-type');
    const statsByLevelDiv = document.getElementById('stats-by-level');
    const statsToggleTypeBtn = document.getElementById('stats-toggle-type');
    const statsToggleLevelBtn = document.getElementById('stats-toggle-level');
    const statsTotalCountType = document.getElementById('stats-total-count-type');
    const statsTotalCountLevel = document.getElementById('stats-total-count-level');

    // 荣誉列表筛选
    const dateFilterSelect = document.getElementById('date-filter-select');
    const keywordSearchInput = document.getElementById('keyword-search-input'); // 【新增】
    const honorsGrid = document.getElementById('honors-grid');
    const noHonorsMessage = document.getElementById('no-honors-message');

    // 编辑荣誉 Modal
    const editModal = document.getElementById('edit_honor_modal');
    const editForm = document.getElementById('edit_honor_form');
    const editModalError = document.getElementById('edit_modal_error');
    const editModalLoading = document.getElementById('edit_modal_loading');
    const editHonorIdInput = document.getElementById('edit_honor_id');
    const editHonorNameInput = document.getElementById('edit_honor_name');
    const editHonorTypeSelect = document.getElementById('edit_honor_type');
    const editHonorLevelSelect = document.getElementById('edit_honor_level');
    const editHonorDateInput = document.getElementById('edit_honor_date');
    const editHonorStampInput = document.getElementById('edit_honor_stamp');
    const editHonorStampOtherInput = document.getElementById('edit_honor_stamp_other');
    const editHonorImageInput = document.getElementById('edit_honor_image_file');
    const editModalImage = document.getElementById('edit_modal_image');
    // 【新增】获取编辑模态框中的状态显示元素
    const editUploadStatus = document.getElementById('edit-upload-status');


    // 图片放大 Modal 和 Toast
    const imageModal = document.getElementById('image_modal');
    const modalImage = document.getElementById('modal_image');
    const modalTitle = document.getElementById('modal_title');
    const successToast = document.getElementById('toast-success');
    const successToastMessage = document.getElementById('toast-success-message');

    // ==========================================================
    // --- 函数定义部分 ---
    // ==========================================================

    /**
    * 根据 Tom Select 的选中项，动态更新其占位符文本和样式
    * @param {object} tomSelectInstance - Tom Select 的实例对象 (e.g., tomTypeInstance)
    * @param {Array} selectedValues - 当前选中的值的数组
    */
    function updateTomSelectPlaceholder(tomSelectInstance, selectedValues) {
        // 确保实例和其核心组件存在
        if (!tomSelectInstance || !tomSelectInstance.control_input || !tomSelectInstance.wrapper) {
            return;
        }

        const input = tomSelectInstance.control_input; // 获取内部的 <input> 元素
        const wrapper = tomSelectInstance.wrapper;     // 获取最外层的 .ts-wrapper 容器
        const count = selectedValues.length;           // 获取选中项的数量

        if (count > 0) {
            // 如果有选中项
            // 从实例上获取原始 placeholder 的后半部分 (例如 "类型" 或 "等级")
            const placeholderSuffix = tomSelectInstance.originalPlaceholder.replace('筛选', '').replace('...', '');
            input.placeholder = `已筛选 ${count} 个${placeholderSuffix}`; // 设置新的 placeholder
            wrapper.classList.add('is-filtered'); // 添加一个特殊类，用于CSS样式控制
        } else {
            // 如果没有选中项 (即清空了筛选)
            input.placeholder = tomSelectInstance.originalPlaceholder; // 恢复原始 placeholder
            wrapper.classList.remove('is-filtered'); // 移除特殊类
        }
    }

    // --- 1. 个性签名 (Motto) 功能 ---
    const enterEditMottoMode = () => {
        if (!mottoDisplayArea || !mottoEditArea || !mottoInput) return;
        mottoDisplayArea.classList.add('hidden');
        mottoEditArea.classList.remove('hidden');
        const currentText = mottoTextSpan.textContent.replace(/"/g, '').trim();
        mottoInput.value = currentText === '编辑您的个性签名...' ? '' : currentText;
        mottoInput.focus();
        if(mottoErrorDiv) mottoErrorDiv.textContent = '';
    };

    const exitEditMottoMode = () => {
        if (!mottoDisplayArea || !mottoEditArea) return;
        mottoEditArea.classList.add('hidden');
        mottoDisplayArea.classList.remove('hidden');
        if(mottoErrorDiv) mottoErrorDiv.textContent = '';
        if (saveMottoLoading) saveMottoLoading.classList.add('hidden');
        if (saveMottoBtn) saveMottoBtn.disabled = false;
    };

    const saveMotto = async () => {
        if (!mottoInput || !saveMottoBtn || !mottoErrorDiv) return;
        const newMotto = mottoInput.value.trim();
        if (saveMottoLoading) saveMottoLoading.classList.remove('hidden');
        saveMottoBtn.disabled = true;
        mottoErrorDiv.textContent = '';
        try {
            const response = await fetch('/update_motto', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                body: JSON.stringify({ motto: newMotto })
            });
            const result = await response.json();
            if (response.ok && result.success) {
                if (mottoTextSpan) {
                    mottoTextSpan.textContent = `"${result.new_motto || '编辑您的个性签名...'}"`;
                }
                exitEditMottoMode();
                showSuccessToast(result.message || '签名更新成功！');
            } else {
                const errorMsg = result.error || `保存失败 (${response.status})。`;
                mottoErrorDiv.textContent = errorMsg;
            }
        } catch (error) {
            console.error('Save motto error:', error);
            mottoErrorDiv.textContent = '网络错误，请稍后重试。';
        } finally {
            if (saveMottoLoading) saveMottoLoading.classList.add('hidden');
            if (saveMottoBtn) saveMottoBtn.disabled = false;
        }
    };

    // --- 2. 荣誉统计与列表筛选 ---
    window.switchStatsView = (viewType) => {
        localStorage.setItem('statsView', viewType);
        if (!statsByTypeDiv || !statsByLevelDiv || !statsToggleTypeBtn || !statsToggleLevelBtn) return;
        const isTypeView = viewType === 'type';
        statsByTypeDiv.classList.toggle('hidden', !isTypeView);
        statsByLevelDiv.classList.toggle('hidden', isTypeView);
        statsToggleTypeBtn.classList.toggle('btn-active', isTypeView);
        statsToggleLevelBtn.classList.toggle('btn-active', !isTypeView);
    };

    function applySavedStatsView() {
        const savedView = localStorage.getItem('statsView');
        if (savedView === 'level') {
            switchStatsView('level');
        } else {
            switchStatsView('type');
        }
    }

    const applySavedFilters = () => {
        const savedKeyword = localStorage.getItem('honorFilterKeyword');
        if (keywordSearchInput && savedKeyword) {
            keywordSearchInput.value = savedKeyword;
        }
        // 恢复 Tom Select 的值
        try {
            const savedType = JSON.parse(localStorage.getItem('honorFilterType'));
            if (tomTypeInstance && savedType) {
                tomTypeInstance.setValue(savedType);
                // 【在这里新增下面这行代码】
                updateTomSelectPlaceholder(tomTypeInstance, savedType); 
            }
            const savedLevel = JSON.parse(localStorage.getItem('honorFilterLevel'));
            if (tomLevelInstance && savedLevel) {
                tomLevelInstance.setValue(savedLevel);
                // 【在这里也新增下面这行代码】
                updateTomSelectPlaceholder(tomLevelInstance, savedLevel);
            }
        } catch(e) {
            console.warn("Could not parse saved filters from localStorage", e);
            localStorage.removeItem('honorFilterType');
            localStorage.removeItem('honorFilterLevel');
        }
    };

    const updateDynamicStats = (typeCounts, levelCounts, totalCount) => {
        if (statsTotalCountType) statsTotalCountType.textContent = totalCount;
        if (statsTotalCountLevel) statsTotalCountLevel.textContent = totalCount;

        if (statsByTypeDiv) {
            document.querySelectorAll('#stats-by-type [data-stat-type]').forEach(statCard => {
                const typeName = statCard.dataset.statType;
                const countEl = statCard.querySelector('.stat-count');
                const count = typeCounts[typeName] || 0;
                if (countEl) {
                    countEl.textContent = count;
                    countEl.classList.toggle('text-accent', count > 0);
                    countEl.classList.toggle('text-base-content/30', count === 0);
                }
            });
        }

        if (statsByLevelDiv) {
            document.querySelectorAll('#stats-by-level [data-stat-level]').forEach(statCard => {
                const levelName = statCard.dataset.statLevel;
                const countEl = statCard.querySelector('.stat-count');
                const count = levelCounts[levelName] || 0;
                 if (countEl) {
                    countEl.textContent = count;
                    countEl.classList.toggle('text-accent', count > 0);
                    countEl.classList.toggle('text-base-content/30', count === 0);
                }
            });
        }
    };


    /**
     * 【修改】核心函数：应用客户端筛选，并触发统计更新
     */
    const applyClientFilters = () => {
    if (!honorsGrid) return;

    const keyword = keywordSearchInput ? keywordSearchInput.value.trim().toLowerCase() : "";
    // 从 Tom Select 获取选中的值，它们会是数组
    const selectedTypes = tomTypeInstance ? tomTypeInstance.getValue() : [];
    const selectedLevels = tomLevelInstance ? tomLevelInstance.getValue() : [];

    const honorCards = honorsGrid.querySelectorAll('.card');

    let visibleCount = 0;
    const typeCounts = {};
    const levelCounts = {};

    // 遍历卡片，进行筛选和计数
    honorCards.forEach(card => {
        const honorName = card.dataset.name.toLowerCase();
        const cardType = card.dataset.type;
        const cardLevel = card.dataset.level;

        const nameMatch = !keyword || honorName.includes(keyword);
        // 如果没有选择任何类型，则视为匹配；否则检查卡片类型是否在选中数组中
        const typeMatch = selectedTypes.length === 0 || selectedTypes.includes(cardType);
        // 如果没有选择任何等级，则视为匹配；否则检查卡片等级是否在选中数组中
        const levelMatch = selectedLevels.length === 0 || selectedLevels.includes(cardLevel);

        if (nameMatch && typeMatch && levelMatch) {
            card.style.display = '';
            visibleCount++;
            if(cardType) typeCounts[cardType] = (typeCounts[cardType] || 0) + 1;
            if(cardLevel) levelCounts[cardLevel] = (levelCounts[cardLevel] || 0) + 1;
        } else {
            card.style.display = 'none';
        }
    });

    // 更新“无结果”提示信息
    if (noHonorsMessage) {
        const isFiltering = keyword || selectedTypes.length > 0 || selectedLevels.length > 0;
        noHonorsMessage.classList.toggle('hidden', !(visibleCount === 0 && isFiltering));
    }

    // 调用函数更新统计面板
    updateDynamicStats(typeCounts, levelCounts, visibleCount);
};

    // 【修改】此函数只重置客户端筛选器
    window.resetClientFilters = () => {
        if (keywordSearchInput) keywordSearchInput.value = "";
        // 使用 Tom Select API 清空
        if (tomTypeInstance) tomTypeInstance.clear();
        if (tomLevelInstance) tomLevelInstance.clear();

        localStorage.removeItem('honorFilterKeyword');
        localStorage.removeItem('honorFilterType');
        localStorage.removeItem('honorFilterLevel');
        applyClientFilters(); // 重置后也要重新计算和应用
    };

    // --- 3. 编辑荣誉 Modal 功能 ---
    window.openEditModal = (button) => {
        if (!editModal || !editForm) return alert("编辑窗口加载失败！");
        editForm.reset();
        
        // 【新增】重置PDF处理状态
        if (editUploadStatus) {
            editUploadStatus.textContent = '';
            editUploadStatus.className = 'label-text-alt text-xs mt-1 min-h-[1rem]';
        }

        if (editModalError) { editModalError.textContent = ''; editModalError.classList.add('hidden'); }
        if (editModalLoading) editModalLoading.classList.add('hidden');
        const data = button.dataset;
        if(editHonorIdInput) editHonorIdInput.value = data.id;
        if(editHonorNameInput) editHonorNameInput.value = data.name;
        if(editHonorTypeSelect) editHonorTypeSelect.value = data.type;
        if(editHonorLevelSelect) editHonorLevelSelect.value = data.level;
        if(editHonorDateInput) editHonorDateInput.value = data.date;
        if(editHonorStampInput) editHonorStampInput.value = data.stamp;
        if(editHonorStampOtherInput) editHonorStampOtherInput.value = data.stampOther;
        if(editModalImage) {
            editModalImage.src = data.imageUrl;
            editModalImage.alt = `当前 ${data.name} 的图片`;
        }
        editModal.showModal();
    };

    window.closeEditModal = () => {
        if (editModal) editModal.close();
    };

    // --- 4. 全局功能函数 (Toast, 图片放大) ---
    const showSuccessToast = (message) => {
        if (!successToast || !successToastMessage) return;
        successToastMessage.textContent = message;
        successToast.classList.remove('hidden');
        setTimeout(() => successToast.classList.add('hidden'), 3000);
    };

    window.showImageModal = (imageUrl, imageTitle) => {
        // Fallback for missing elements, just open the image in a new tab
        if (typeof image_modal === 'undefined' || !image_modal) {
             window.open(imageUrl, '_blank');
             return;
        }
        const modalImgEl = document.getElementById('modal_image');
        const modalTitleEl = document.getElementById('modal_title');
        if (modalImgEl) modalImgEl.src = imageUrl;
        if (modalTitleEl) modalTitleEl.textContent = imageTitle || '图片详情';
        image_modal.showModal();
    };


    // ==========================================================
    // --- 页面加载后的初始化调用和事件绑定 ---
    // ==========================================================

    // 1. 应用保存的视图和筛选器状态
    applySavedStatsView();
    applySavedFilters();

    // 2. 根据当前(可能已恢复的)筛选器值，执行一次客户端筛选和动态统计（关键！）
    applyClientFilters();

    if (tomTypeInstance) {
        console.log('--- 脚本初始化：正在绑定“类型筛选”事件 ---');
        
        tomTypeInstance.on('change', (value) => {
            console.log(`[CHANGE event - 类型] 触发，选中的值:`, value);
            localStorage.setItem('honorFilterType', JSON.stringify(value));
            applyClientFilters();
            updateTomSelectPlaceholder(tomTypeInstance, value);
        });
    }

    if (tomLevelInstance) {
        console.log('--- 脚本初始化：正在绑定“等级筛选”事件 ---');

        tomLevelInstance.on('change', (value) => {
            console.log(`[CHANGE event - 等级] 触发，选中的值:`, value);
            localStorage.setItem('honorFilterLevel', JSON.stringify(value));
            applyClientFilters();
            updateTomSelectPlaceholder(tomLevelInstance, value);
        });
    }

    // --- 事件绑定 ---
    // 个性签名事件
    if (mottoDisplayArea) mottoDisplayArea.addEventListener('click', enterEditMottoMode);
    if (cancelMottoBtn) cancelMottoBtn.addEventListener('click', exitEditMottoMode);
    if (saveMottoBtn) saveMottoBtn.addEventListener('click', saveMotto);
    if (mottoInput) {
        mottoInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') { e.preventDefault(); saveMotto(); }
            if (e.key === 'Escape') exitEditMottoMode();
        });
    }

    const customDateContainer = document.getElementById('custom-date-range-container');
    const startDateInput = document.getElementById('start-date-input');
    const endDateInput = document.getElementById('end-date-input');
    const applyCustomDateBtn = document.getElementById('apply-custom-date-btn');

    // 用于根据下拉菜单的值，显示或隐藏自选日期控件
    function toggleCustomDateControls() {
        if (!dateFilterSelect || !customDateContainer) return;
        if (dateFilterSelect.value === 'custom') {
            customDateContainer.style.display = 'flex';
        } else {
            customDateContainer.style.display = 'none';
        }
    }

    if (dateFilterSelect) {
        dateFilterSelect.addEventListener('change', (e) => {
            const selectedValue = e.target.value;
            // 如果选择“自选时间段”，仅显示控件，不跳转
            if (selectedValue === 'custom') {
                toggleCustomDateControls();
            } else {
                // 对于其他预设选项，直接构建URL并跳转
                const currentUrl = new URL(window.location.href);
                currentUrl.searchParams.set('filter_date', selectedValue);
                // 确保移除可能存在的自选日期参数
                currentUrl.searchParams.delete('start_date');
                currentUrl.searchParams.delete('end_date');
                window.location.href = currentUrl.toString();
            }
        });
    }

    // 【新增】为“应用”按钮绑定点击事件
    if (applyCustomDateBtn) {
        applyCustomDateBtn.addEventListener('click', () => {
            const startDate = startDateInput.value;
            const endDate = endDateInput.value;

            if (!startDate || !endDate) {
                alert('请同时选择开始日期和结束日期。');
                return;
            }
            if (new Date(startDate) > new Date(endDate)) {
                alert('开始日期不能晚于结束日期。');
                return;
            }

            const currentUrl = new URL(window.location.href);
            currentUrl.searchParams.set('filter_date', 'custom');
            currentUrl.searchParams.set('start_date', startDate);
            currentUrl.searchParams.set('end_date', endDate);
            window.location.href = currentUrl.toString();
        });
    }

    // 在页面加载时，调用一次此函数来设置控件的初始显示状态
    toggleCustomDateControls();

    // 【新增】关键词搜索事件
    if (keywordSearchInput) {
        keywordSearchInput.addEventListener('input', () => {
             localStorage.setItem('honorFilterKeyword', keywordSearchInput.value);
             applyClientFilters();
        });
    }


    const resetFiltersBtn = document.getElementById('reset-filters-btn');
    if (resetFiltersBtn) {
        // 【修改】重置按钮行为：现在重置所有筛选（包括客户端和服务器端）
        resetFiltersBtn.addEventListener('click', () => {
            localStorage.removeItem('honorFilterKeyword');
            localStorage.removeItem('honorFilterType');
            localStorage.removeItem('honorFilterLevel');
            const currentUrl = new URL(window.location.href);
            currentUrl.searchParams.set('filter_date', 'all');
            // 跳转到完全重置的URL
            window.location.href = currentUrl.toString();
        });
    }

    // 【新增】为编辑模态框的文件输入框绑定PDF处理事件
    if (editHonorImageInput && editUploadStatus) {
        editHonorImageInput.addEventListener('change', (event) => {
            handleFileSelect(event, editHonorImageInput, editUploadStatus);
        });
    }


    // 编辑表单提交事件
    if (editForm) {
        editForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const honorId = editHonorIdInput.value;
            if (!honorId) return;
            if (editModalLoading) editModalLoading.classList.remove('hidden');
            if (editModalError) { editModalError.textContent = ''; editModalError.classList.add('hidden'); }
            const formData = new FormData(editForm);
            try {
                const response = await fetch(`/edit_honor/${honorId}`, {
                    method: 'POST',
                    body: formData,
                    headers: { 'Accept': 'application/json' }
                });
                const result = await response.json();
                if (response.ok && result.success) {
                    closeEditModal();
                    showSuccessToast(result.message || '更新成功！页面即将刷新...');
                    setTimeout(() => window.location.reload(), 1500);
                } else {
                    const errorMsg = result.error || `更新失败 (${response.status})。请检查输入内容。`;
                    if(editModalError) {
                        editModalError.textContent = errorMsg;
                        editModalError.classList.remove('hidden');
                    }
                }
            } catch (error) {
                console.error('Submit edit form error:', error);
                if(editModalError) {
                    editModalError.textContent = '请求失败，请检查网络连接。';
                    editModalError.classList.remove('hidden');
                }
            } finally {
                if(editModalLoading) editModalLoading.classList.add('hidden');
            }
        });
    }
});
</script>
{% endblock %}