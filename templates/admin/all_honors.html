<!DOCTYPE html>
{% extends "layout.html" %}

{% block title %}荣誉总览 (管理员){% endblock %}

{% block head_extra %}
<style>
    /* --- 布局与通用样式 (与 home.html 相同) --- */
    .honor-section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem; }
    .honor-filters-container { display: flex; flex-wrap: wrap; align-items: center; gap: 0.75rem; }
    .honor-filter-container select { min-width: 130px; }
    .keyword-search-container { display: flex; align-items: center; gap: 0.5rem; flex-grow: 1; max-width: 250px; }
    .keyword-search-container input { width: 100%; }
    .card figure img { will-change: transform; }
    .toast { z-index: 9999 !important; }

    /* --- 编辑荣誉模态框样式 (与 home.html 相同) --- */
    #edit_honor_modal .modal-box { max-width: 48rem; width: 100%; }
    #edit_honor_modal .modal-content-grid { display: grid; grid-template-columns: 1fr 2fr; gap: 1.5rem; align-items: start; width: 100%; }
    #edit_honor_modal .modal-image-container { display: flex; flex-direction: column; align-items: center; }
    #edit_honor_modal .modal-image-container img { max-width: 100%; max-height: 300px; object-fit: contain; margin-bottom: 1rem; border-radius: 0.375rem; box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1); }
    .loading-overlay { position: absolute; inset: 0; background-color: rgba(255, 255, 255, 0.7); display: flex; align-items: center; justify-content: center; z-index: 10; border-radius: inherit; }
    @media (max-width: 768px) {
        #edit_honor_modal .modal-box { max-width: 95%; padding: 1.5rem 1rem; }
        #edit_honor_modal .modal-content-grid { grid-template-columns: 1fr; gap: 1rem; }
        #edit_honor_modal .modal-image-container { order: -1; }
        #edit_honor_modal .modal-image-container img { max-height: 200px; }
        .keyword-search-container { max-width: none; }
    }
</style>
{% endblock %}

{% block content %}
<div class="space-y-8">

    {# --- 1. 荣誉统计 Section (基于客户端当前筛选结果) --- #}
    <section>
        <div class="flex flex-wrap items-center justify-between gap-4 mb-3">
            <h2 class="text-xl font-semibold divider divider-start my-0 flex-shrink-0">荣誉统计 (当前视图)</h2>
            <div class="btn-group">
                <button id="stats-toggle-type" class="btn btn-sm btn-active" onclick="switchStatsView('type')">按类型</button>
                <button id="stats-toggle-level" class="btn btn-sm" onclick="switchStatsView('level')">按等级</button>
            </div>
        </div>
        {# 按类型统计 #}
        <div id="stats-by-type">
            <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 xl:grid-cols-6 gap-4 w-full">
                <div class="bg-base-200 shadow rounded-lg p-4 flex flex-col justify-center items-center text-center h-full">
                    <div class="text-sm font-medium text-base-content/70 mb-1">当前总计</div>
                    <div id="stats-total-count-type" class="text-3xl font-bold text-primary">0</div>
                    <div class="text-xs text-base-content/50 mt-1">项荣誉</div>
                </div>
                {% for type_name in honor_types %}
                <div class="bg-base-200 shadow rounded-lg p-4 flex flex-col justify-center items-center text-center h-full" data-stat-type="{{ type_name | escape }}">
                    <div class="text-sm font-medium text-base-content/70 mb-1">{{ type_name | escape }}</div>
                    <div class="stat-count text-3xl font-bold text-accent">0</div>
                    <div class="text-xs text-base-content/50 mt-1">项记录</div>
                </div>
                {% endfor %}
            </div>
        </div>
        {# 按等级统计 #}
        <div id="stats-by-level" class="hidden">
             <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 xl:grid-cols-6 gap-4 w-full">
                <div class="bg-base-200 shadow rounded-lg p-4 flex flex-col justify-center items-center text-center h-full">
                    <div class="text-sm font-medium text-base-content/70 mb-1">当前总计</div>
                    <div id="stats-total-count-level" class="text-3xl font-bold text-primary">0</div>
                    <div class="text-xs text-base-content/50 mt-1">项荣誉</div>
                </div>
                {% for level_name in honor_levels %}
                <div class="bg-base-200 shadow rounded-lg p-4 flex flex-col justify-center items-center text-center h-full" data-stat-level="{{ level_name | escape }}">
                    <div class="text-sm font-medium text-base-content/70 mb-1">{{ level_name | escape }}</div>
                    <div class="stat-count text-3xl font-bold text-accent">0</div>
                    <div class="text-xs text-base-content/50 mt-1">项记录</div>
                </div>
                {% endfor %}
            </div>
        </div>
    </section>

    {# --- 2. 荣誉列表与筛选 Section --- #}
    <section>
        <div class="honor-section-header">
            {# 动态标题 #}
            {% set filter_map = {'last_year': '一年内', 'last_3_years': '三年内', 'last_5_years': '五年内'} %}
            {% set filter_text = filter_map.get(selected_date_filter, '全部时间') %}
            {% if selected_date_filter == 'custom' and request.args.get('start_date') and request.args.get('end_date') %}
                {% set filter_text = request.args.get('start_date') + ' 至 ' + request.args.get('end_date') %}
            {% elif selected_date_filter == 'custom' %}
                {% set filter_text = '自选时间段' %}
            {% endif %}
            <h2 class="text-xl font-semibold divider divider-start my-0 flex-shrink-0">
                全部荣誉记录 <span class="text-base-content/70 font-normal">({{ filter_text }})</span>
            </h2>

            {# 筛选器容器 #}
            <div class="honor-filters-container">
                <div class="keyword-search-container" title="按荣誉名称搜索">
                    <input type="text" id="keyword-search-input" class="input input-bordered input-sm w-full" placeholder="搜索荣誉名称..."/>
                </div>

                <div class="dropdown dropdown-end">
                    <label tabindex="0" class="btn btn-sm btn-outline m-1 font-normal">
                        <span>{{ filter_text }}</span>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                    </label>
                    <div tabindex="0" class="dropdown-content z-[10] menu p-4 shadow bg-base-200 rounded-box w-80 space-y-3">
                        <h4 class="font-bold px-4">筛选时间</h4>
                        <ul class="menu p-0">
                            <li><a href="{{ url_for('admin_all_honors', filter_date='all') }}">全部时间</a></li>
                            <li><a href="{{ url_for('admin_all_honors', filter_date='last_year') }}">一年内</a></li>
                            <li><a href="{{ url_for('admin_all_honors', filter_date='last_3_years') }}">三年内</a></li>
                            <li><a href="{{ url_for('admin_all_honors', filter_date='last_5_years') }}">五年内</a></li>
                        </ul>
                        <div class="divider my-1">或自选范围</div>
                        <div class="space-y-2 px-2">
                            <div class="form-control"><label class="label py-0"><span class="label-text-alt">开始日期</span></label><input type="date" id="start-date-input" class="input input-bordered input-sm"></div>
                            <div class="form-control"><label class="label py-0"><span class="label-text-alt">结束日期</span></label><input type="date" id="end-date-input" class="input input-bordered input-sm" max="{{ now().strftime('%Y-%m-%d') }}"></div>
                        </div>
                        <button id="apply-custom-date-btn" class="btn btn-secondary btn-sm w-full">应用自选范围</button>
                    </div>
                </div>

                <div class="dropdown dropdown-end">
                    <label tabindex="0" class="btn btn-sm btn-outline m-1 font-normal" id="user-filter-btn"><span id="user-filter-label">筛选教师</span><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg></label>
                    <div tabindex="0" class="dropdown-content z-[10] menu p-4 shadow bg-base-200 rounded-box w-60 space-y-1">
                        <h4 class="font-bold px-4 mb-2">筛选教师</h4>
                        <div class="max-h-60 overflow-y-auto">
                        {% for username, truename in all_teachers.items()|sort(attribute=1) %}
                            <div class="form-control"><label class="label py-1 cursor-pointer"><span class="label-text">{{ truename }}</span><input type="checkbox" value="{{ username | escape }}" class="checkbox checkbox-sm checkbox-primary honor-user-cb"/></label></div>
                        {% endfor %}
                        </div>
                    </div>
                </div>
                
                <div class="dropdown dropdown-end">
                    <label tabindex="0" class="btn btn-sm btn-outline m-1 font-normal" id="major-filter-btn"><span id="major-filter-label">筛选专业</span><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg></label>
                    <div tabindex="0" class="dropdown-content z-[10] menu p-4 shadow bg-base-200 rounded-box w-60 space-y-1">
                        <h4 class="font-bold px-4 mb-2">筛选专业</h4>
                        <div class="max-h-60 overflow-y-auto">
                        {% for major_option in all_majors %}
                             <div class="form-control"><label class="label py-1 cursor-pointer"><span class="label-text">{{ major_option }}</span><input type="checkbox" value="{{ major_option | escape }}" class="checkbox checkbox-sm checkbox-primary honor-major-cb"/></label></div>
                        {% endfor %}
                        </div>
                    </div>
                </div>

                <div class="dropdown dropdown-end">
                    <label tabindex="0" class="btn btn-sm btn-outline m-1 font-normal" id="type-filter-btn"><span id="type-filter-label">筛选类型</span><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg></label>
                    <div tabindex="0" class="dropdown-content z-[10] menu p-4 shadow bg-base-200 rounded-box w-60 space-y-1">
                        <h4 class="font-bold px-4 mb-2">筛选类型</h4>
                        <div class="max-h-60 overflow-y-auto">
                        {% for type_option in honor_types %}
                            <div class="form-control"><label class="label py-1 cursor-pointer"><span class="label-text">{{ type_option }}</span><input type="checkbox" value="{{ type_option | escape }}" class="checkbox checkbox-sm checkbox-primary honor-type-cb"/></label></div>
                        {% endfor %}
                        </div>
                    </div>
                </div>

                <div class="dropdown dropdown-end">
                    <label tabindex="0" class="btn btn-sm btn-outline m-1 font-normal" id="level-filter-btn"><span id="level-filter-label">筛选等级</span><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg></label>
                    <div tabindex="0" class="dropdown-content z-[10] menu p-4 shadow bg-base-200 rounded-box w-60 space-y-1">
                         <h4 class="font-bold px-4 mb-2">筛选等级</h4>
                         <div class="max-h-60 overflow-y-auto">
                        {% for level_option in honor_levels %}
                            <div class="form-control"><label class="label py-1 cursor-pointer"><span class="label-text">{{ level_option }}</span><input type="checkbox" value="{{ level_option | escape }}" class="checkbox checkbox-sm checkbox-primary honor-level-cb"/></label></div>
                        {% endfor %}
                        </div>
                    </div>
                </div>

                <button id="reset-filters-btn" class="btn btn-primary btn-sm" title="重置全部筛选">重置筛选</button>
            </div>
        </div>

        {# 荣誉卡片网格 #}
        {% if honors %}
            <div id="honors-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-4 gap-6 mt-4">
                {% for honor in honors %}
                    {% set current_level = honor.honor_level or honor.level %}
                    <div id="card-{{ honor.id }}"
                         class="card bg-base-100 shadow-xl transition-shadow duration-300 hover:shadow-2xl group overflow-hidden"
                         data-type="{{ honor.type | escape }}"
                         data-level="{{ current_level | default('', true) | escape }}"
                         data-name="{{ honor.name | escape }}"
                         data-user="{{ honor.username | escape }}"
                         data-major="{{ honor.major | escape }}"
                         onmouseenter="preloadImage('{{ url_for('uploaded_file_user', username=honor.username, filename=honor.image_filename) }}')">
                        <figure class="relative cursor-pointer overflow-hidden h-64 w-full bg-base-200" onclick="showImageModal('{{ url_for('uploaded_file_user', username=honor.username, filename=honor.image_filename) }}', '{{ honor.name | escape | replace("'", "\\'") }}')">
                            {% set parts = honor.image_filename.rsplit('.', 1) %}
                            {% set thumb_filename = parts[0] + '_thumb.' + parts[1] if parts|length == 2 else honor.image_filename %}
                            <img src="{{ url_for('uploaded_file_user', username=honor.username, filename=thumb_filename) }}" alt="{{ honor.name }} 缩略图" loading="lazy" class="object-cover h-full w-full" onerror="this.onerror=null; this.src='{{ url_for('uploaded_file_user', username=honor.username, filename=honor.image_filename) }}';">
                        </figure>
                        <div class="card-body p-4">
                            <div class="text-xs text-base-content/60 mb-2">
                                <span class="font-semibold text-primary">{{ honor.truename }}</span> / {{ honor.major }}
                            </div>
                            <h3 class="card-title text-base lg:text-lg font-semibold truncate" title="{{ honor.name }}">{{ honor.name }}</h3>
                            <div class="text-sm text-base-content/80 space-y-1 mt-2">
                                <p><span class="font-medium">类型:</span> {{ honor.type }}</p>
                                {% if current_level %}<p><span class="font-medium">等级:</span> {{ current_level }}</p>{% endif %}
                                <p><span class="font-medium">时间:</span> {{ honor.date }}</p>
                                <p><span class="font-medium">单位:</span> <span title="{{ honor.stamp }}">{{ honor.stamp | truncate(20) }}</span></p>
                            </div>
                            <div class="card-actions justify-end mt-3">
                                <button type="button" class="btn btn-xs sm:btn-sm btn-outline btn-primary" title="编辑"
                                        onclick="openEditModal(this)"
                                        data-id="{{ honor.id }}" data-name="{{ honor.name | escape }}" data-type="{{ honor.type | escape }}" data-level="{{ current_level | default('', true) | escape }}"
                                        data-date="{{ honor.date }}" data-stamp="{{ honor.stamp | escape }}" data-stamp-other="{{ honor.stamp_other | default('', true) | escape }}"
                                        data-image-url="{{ url_for('uploaded_file_user', username=honor.username, filename=honor.image_filename) }}">
                                    编辑
                                </button>
                                <form method="post" action="{{ url_for('delete_honor', honor_id=honor.id) }}" onsubmit="return confirm('警告：您确定要永久删除教师 “{{ honor.truename }}” 的 “{{ honor.name | escape | replace("'", "\\'") }}” 这条荣誉记录吗？\n\n此操作无法撤销！');" style="display: inline;">
                                    <button type="submit" class="btn btn-xs sm:btn-sm btn-outline btn-secondary" title="删除">删除</button>
                                </form>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
            <div id="no-honors-message" class="alert alert-warning mt-6 shadow-md hidden" role="alert">
                <span>在当前视图中，未找到符合所选条件的荣誉记录。</span>
                <button class="btn btn-sm btn-ghost" onclick="resetClientFilters()">重置筛选</button>
            </div>
        {% else %}
             <div class="alert alert-info mt-6 shadow-md">
                 <span>系统中还没有任何荣誉记录。</span>
            </div>
        {% endif %}
    </section>

</div>

{# Modal 和 Toast 弹窗定义，如果这些文件在你的项目中是可复用的，推荐使用 include #}
{# 例如: {% include '_partials/edit_honor_modal.html' %} #}
{# 为确保独立性，这里直接写出HTML #}

<dialog id="edit_honor_modal" class="modal modal-bottom sm:modal-middle">
    <div class="modal-box relative">
        <div id="edit_modal_loading" class="loading-overlay hidden"><span class="loading loading-spinner loading-lg text-primary"></span></div>
        <div class="modal-content-grid">
            <div class="modal-image-container">
                <img id="edit_modal_image" src="" alt="当前荣誉图片" />
                <span class="text-xs text-base-content/60 mt-2">当前图片</span>
            </div>
            <div class="modal-form-container">
                <form id="edit_honor_form" class="space-y-3">
                    <h3 class="font-bold text-lg mb-3 text-center md:text-left">编辑荣誉信息</h3>
                    <input type="hidden" id="edit_honor_id" name="honor_id">
                    <div class="form-control w-full">
                        <label class="label py-1" for="edit_honor_name"><span class="label-text font-medium">荣誉名称 <span class="text-error">*</span></span></label>
                        <input type="text" id="edit_honor_name" name="honor_name" class="input input-sm input-bordered w-full" required />
                    </div>
                    <div class="form-control w-full">
                        <label class="label py-1" for="edit_honor_type"><span class="label-text font-medium">荣誉类型 <span class="text-error">*</span></span></label>
                        <select id="edit_honor_type" name="honor_type" class="select select-sm select-bordered w-full" required>
                            <option value="" disabled>请选择类型</option>
                            {% for type_option in honor_types %}<option value="{{ type_option | escape }}">{{ type_option }}</option>{% endfor %}
                        </select>
                    </div>
                    <div class="form-control w-full">
                        <label class="label py-1" for="edit_honor_level"><span class="label-text font-medium">荣誉等级 <span class="text-error">*</span></span></label>
                        <select id="edit_honor_level" name="honor_level" class="select select-sm select-bordered w-full" required>
                            <option value="" disabled>请选择等级</option>
                            {% for level_option in honor_levels %}<option value="{{ level_option | escape }}">{{ level_option }}</option>{% endfor %}
                        </select>
                    </div>
                    <div class="form-control w-full">
                        <label class="label py-1" for="edit_honor_date"><span class="label-text font-medium">获得时间 <span class="text-error">*</span></span></label>
                        <input type="date" id="edit_honor_date" name="honor_date" class="input input-sm input-bordered w-full" required max="{{ now().strftime('%Y-%m-%d') }}"/>
                    </div>
                    <div class="form-control w-full">
                        <label class="label py-1" for="edit_honor_stamp"><span class="label-text font-medium">颁发单位 <span class="text-error">*</span></span></label>
                        <input type="text" id="edit_honor_stamp" name="honor_stamp" class="input input-sm input-bordered w-full" required />
                    </div>
                    <div class="form-control w-full">
                        <label class="label py-1" for="edit_honor_stamp_other"><span class="label-text font-medium">颁发单位2 (可选)</span></label>
                        <input type="text" id="edit_honor_stamp_other" name="honor_stamp_other" class="input input-sm input-bordered w-full" />
                    </div>
                    <div class="form-control w-full">
                        <label class="label py-1" for="edit_honor_image_file"><span class="label-text font-medium">替换证明图片 (可选)</span></label>
                        <input type="file" id="edit_honor_image_file" name="honor_image" class="file-input file-input-sm file-input-bordered file-input-secondary w-full" accept="image/png, image/jpeg, image/gif" />
                        <label class="label py-0"><span class="label-text-alt text-xs">不选则保留原图</span></label>
                    </div>
                    <div id="edit_modal_error" class="text-error text-sm mt-2 hidden min-h-[1.25rem]"></div>
                    <div class="modal-action mt-4 justify-end space-x-2">
                        <button type="button" class="btn btn-sm btn-ghost" onclick="closeEditModal()">取消</button>
                        <button type="submit" class="btn btn-sm btn-primary">确认修改</button>
                    </div>
                </form>
            </div>
        </div>
        <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2" onclick="closeEditModal()">✕</button>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button type="button" onclick="closeEditModal()">close</button>
    </form>
</dialog>

<dialog id="image_modal" class="modal">
  <div class="modal-box w-11/12 max-w-5xl">
    <h3 id="modal_title" class="font-bold text-lg">图片详情</h3>
    <div class="py-4">
      <img id="modal_image" src="" alt="荣誉图片放大" class="w-full h-auto object-contain max-h-[80vh]"/>
    </div>
    <div class="modal-action">
      <form method="dialog">
        <button class="btn">关闭</button>
      </form>
    </div>
  </div>
   <form method="dialog" class="modal-backdrop"><button>关闭</button></form>
</dialog>


<div id="toast-success" class="toast toast-top toast-center hidden">
    <div class="alert alert-success shadow-lg">
        <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
        <span id="toast-success-message">操作成功！</span>
    </div>
</div>

{% endblock %}


{# ====================================================== #}
{# ================ JAVASCRIPT SECTION ================== #}
{# ====================================================== #}
{% block scripts %}
<script>
// 全局辅助函数
const preloadedImages = new Set();
function preloadImage(url) {
    if (!preloadedImages.has(url)) {
        const img = new Image();
        img.src = url;
        preloadedImages.add(url);
    }
}

document.addEventListener('DOMContentLoaded', () => {
    //==========================================================
    // 1. 全局 DOM 元素引用
    //==========================================================
    const honorsGrid = document.getElementById('honors-grid');
    const noHonorsMessage = document.getElementById('no-honors-message');
    const keywordSearchInput = document.getElementById('keyword-search-input');
    const resetFiltersBtn = document.getElementById('reset-filters-btn');

    // Dropdown 筛选器
    const startDateInput = document.getElementById('start-date-input');
    const endDateInput = document.getElementById('end-date-input');
    const applyCustomDateBtn = document.getElementById('apply-custom-date-btn');
    
    const userFilterBtnLabel = document.getElementById('user-filter-label');
    const majorFilterBtnLabel = document.getElementById('major-filter-label');
    const typeFilterBtnLabel = document.getElementById('type-filter-label');
    const levelFilterBtnLabel = document.getElementById('level-filter-label');

    const userCheckboxes = document.querySelectorAll('.honor-user-cb');
    const majorCheckboxes = document.querySelectorAll('.honor-major-cb');
    const typeCheckboxes = document.querySelectorAll('.honor-type-cb');
    const levelCheckboxes = document.querySelectorAll('.honor-level-cb');
    const allCheckboxes = document.querySelectorAll('.dropdown-content .checkbox');

    // 统计相关
    const statsByTypeDiv = document.getElementById('stats-by-type');
    const statsByLevelDiv = document.getElementById('stats-by-level');
    const statsToggleTypeBtn = document.getElementById('stats-toggle-type');
    const statsToggleLevelBtn = document.getElementById('stats-toggle-level');
    const statsTotalCountType = document.getElementById('stats-total-count-type');
    const statsTotalCountLevel = document.getElementById('stats-total-count-level');

    // 编辑荣誉 Modal 相关
    const editModal = document.getElementById('edit_honor_modal');
    const editForm = document.getElementById('edit_honor_form');
    const editModalError = document.getElementById('edit_modal_error');
    const editModalLoading = document.getElementById('edit_modal_loading');
    const editHonorIdInput = document.getElementById('edit_honor_id');
    const editHonorNameInput = document.getElementById('edit_honor_name');
    const editHonorTypeSelect = document.getElementById('edit_honor_type');
    const editHonorLevelSelect = document.getElementById('edit_honor_level');
    const editHonorDateInput = document.getElementById('edit_honor_date');
    const editHonorStampInput = document.getElementById('edit_honor_stamp');
    const editHonorStampOtherInput = document.getElementById('edit_honor_stamp_other');
    const editModalImage = document.getElementById('edit_modal_image');

    // Toast 相关
    const successToast = document.getElementById('toast-success');
    const successToastMessage = document.getElementById('toast-success-message');

    //==========================================================
    // 2. 函数定义
    //==========================================================

    // --- 筛选核心逻辑 ---
    function applyAllClientFilters() {
        if (!honorsGrid) return;
        const keyword = keywordSearchInput ? keywordSearchInput.value.trim().toLowerCase() : "";
        const selectedUsers = Array.from(userCheckboxes).filter(cb => cb.checked).map(cb => cb.value);
        const selectedMajors = Array.from(majorCheckboxes).filter(cb => cb.checked).map(cb => cb.value);
        const selectedTypes = Array.from(typeCheckboxes).filter(cb => cb.checked).map(cb => cb.value);
        const selectedLevels = Array.from(levelCheckboxes).filter(cb => cb.checked).map(cb => cb.value);

        const honorCards = honorsGrid.querySelectorAll('.card');
        let visibleCount = 0;
        const visibleTypeCounts = {}, visibleLevelCounts = {};

        honorCards.forEach(card => {
            const nameMatch = !keyword || card.dataset.name.toLowerCase().includes(keyword);
            const userMatch = selectedUsers.length === 0 || selectedUsers.includes(card.dataset.user);
            const majorMatch = selectedMajors.length === 0 || selectedMajors.includes(card.dataset.major);
            const typeMatch = selectedTypes.length === 0 || selectedTypes.includes(card.dataset.type);
            const levelMatch = selectedLevels.length === 0 || selectedLevels.includes(card.dataset.level);

            if (nameMatch && userMatch && majorMatch && typeMatch && levelMatch) {
                card.style.display = '';
                visibleCount++;
                const cardType = card.dataset.type;
                const cardLevel = card.dataset.level;
                if(cardType) visibleTypeCounts[cardType] = (visibleTypeCounts[cardType] || 0) + 1;
                if(cardLevel) visibleLevelCounts[cardLevel] = (visibleLevelCounts[cardLevel] || 0) + 1;
            } else {
                card.style.display = 'none';
            }
        });
        
        updateDynamicStats(visibleTypeCounts, visibleLevelCounts, visibleCount);
        updateNoHonorsMessage(visibleCount);
        updateFilterButtonLabel(userFilterBtnLabel, '教师', selectedUsers.length);
        updateFilterButtonLabel(majorFilterBtnLabel, '专业', selectedMajors.length);
        updateFilterButtonLabel(typeFilterBtnLabel, '类型', selectedTypes.length);
        updateFilterButtonLabel(levelFilterBtnLabel, '等级', selectedLevels.length);

        localStorage.setItem('adminHonorFilterKeyword', keyword);
        localStorage.setItem('adminHonorFilterUser', JSON.stringify(selectedUsers));
        localStorage.setItem('adminHonorFilterMajor', JSON.stringify(selectedMajors));
        localStorage.setItem('adminHonorFilterType', JSON.stringify(selectedTypes));
        localStorage.setItem('adminHonorFilterLevel', JSON.stringify(selectedLevels));
    }

    function updateFilterButtonLabel(labelElement, prefix, count) {
        if (!labelElement) return;
        const button = labelElement.parentElement;
        if (count > 0) {
            labelElement.textContent = `筛选${prefix} (${count})`;
            button.classList.add('btn-active', 'btn-primary');
        } else {
            labelElement.textContent = `筛选${prefix}`;
            button.classList.remove('btn-active', 'btn-primary');
        }
    }

    function updateNoHonorsMessage(visibleCount) {
        if (!noHonorsMessage) return;
        const isFiltering = (keywordSearchInput && keywordSearchInput.value) || Array.from(allCheckboxes).some(cb => cb.checked);
        noHonorsMessage.classList.toggle('hidden', !(visibleCount === 0 && isFiltering));
    }

    window.resetClientFilters = () => {
        if (keywordSearchInput) keywordSearchInput.value = "";
        allCheckboxes.forEach(cb => cb.checked = false);
        applyAllClientFilters();
    };

    function applySavedFilters() {
        if (keywordSearchInput) keywordSearchInput.value = localStorage.getItem('adminHonorFilterKeyword') || '';
        
        const setCheckboxes = (storageKey, checkboxes) => {
            try {
                const saved = JSON.parse(localStorage.getItem(storageKey) || '[]');
                if (saved.length > 0) {
                    checkboxes.forEach(cb => { if (saved.includes(cb.value)) cb.checked = true; });
                }
            } catch (e) { localStorage.removeItem(storageKey); }
        };

        setCheckboxes('adminHonorFilterUser', userCheckboxes);
        setCheckboxes('adminHonorFilterMajor', majorCheckboxes);
        setCheckboxes('adminHonorFilterType', typeCheckboxes);
        setCheckboxes('adminHonorFilterLevel', levelCheckboxes);
    }
    
    // --- 统计面板相关函数 ---
    function updateDynamicStats(typeCounts, levelCounts, totalCount) {
        if (statsTotalCountType) statsTotalCountType.textContent = totalCount;
        if (statsTotalCountLevel) statsTotalCountLevel.textContent = totalCount;

        document.querySelectorAll('#stats-by-type [data-stat-type]').forEach(card => {
            const typeName = card.dataset.statType;
            const countEl = card.querySelector('.stat-count');
            const count = typeCounts[typeName] || 0;
            if (countEl) {
                countEl.textContent = count;
                countEl.classList.toggle('text-accent', count > 0);
                countEl.classList.toggle('text-base-content/30', count === 0);
            }
        });

        document.querySelectorAll('#stats-by-level [data-stat-level]').forEach(card => {
            const levelName = card.dataset.statLevel;
            const countEl = card.querySelector('.stat-count');
            const count = levelCounts[levelName] || 0;
            if (countEl) {
                countEl.textContent = count;
                countEl.classList.toggle('text-accent', count > 0);
                countEl.classList.toggle('text-base-content/30', count === 0);
            }
        });
    }

    window.switchStatsView = (viewType) => {
        localStorage.setItem('adminStatsView', viewType);
        if (!statsByTypeDiv || !statsByLevelDiv || !statsToggleTypeBtn || !statsToggleLevelBtn) return;
        const isTypeView = viewType === 'type';
        statsByTypeDiv.classList.toggle('hidden', !isTypeView);
        statsByLevelDiv.classList.toggle('hidden', isTypeView);
        statsToggleTypeBtn.classList.toggle('btn-active', isTypeView);
        statsToggleLevelBtn.classList.toggle('btn-active', !isTypeView);
    };

    function applySavedStatsView() {
        const savedView = localStorage.getItem('adminStatsView');
        switchStatsView(savedView === 'level' ? 'level' : 'type');
    }

    // --- Modal 与 Toast 相关函数 ---
    window.openEditModal = (button) => {
        if (!editModal || !editForm) return;
        editForm.reset();
        if (editModalError) { editModalError.textContent = ''; editModalError.classList.add('hidden'); }
        if (editModalLoading) editModalLoading.classList.add('hidden');
        const data = button.dataset;
        if(editHonorIdInput) editHonorIdInput.value = data.id;
        if(editHonorNameInput) editHonorNameInput.value = data.name;
        if(editHonorTypeSelect) editHonorTypeSelect.value = data.type;
        if(editHonorLevelSelect) editHonorLevelSelect.value = data.level;
        if(editHonorDateInput) editHonorDateInput.value = data.date;
        if(editHonorStampInput) editHonorStampInput.value = data.stamp;
        if(editHonorStampOtherInput) editHonorStampOtherInput.value = data.stampOther;
        if(editModalImage) {
            editModalImage.src = data.imageUrl;
            editModalImage.alt = `当前 ${data.name} 的图片`;
        }
        editModal.showModal();
    };

    window.closeEditModal = () => { if (editModal) editModal.close(); };

    window.showImageModal = (imageUrl, imageTitle) => {
        const imageModal = document.getElementById('image_modal');
        if (!imageModal) { window.open(imageUrl, '_blank'); return; }
        const modalImgEl = document.getElementById('modal_image');
        const modalTitleEl = document.getElementById('modal_title');
        if (modalImgEl) modalImgEl.src = imageUrl;
        if (modalTitleEl) modalTitleEl.textContent = imageTitle || '图片详情';
        imageModal.showModal();
    };
    
    const showSuccessToast = (message) => {
        if (!successToast || !successToastMessage) return;
        successToastMessage.textContent = message;
        successToast.classList.remove('hidden');
        setTimeout(() => successToast.classList.add('hidden'), 3000);
    };

    //==========================================================
    // 3. 事件绑定与初始化调用
    //==========================================================
    if (keywordSearchInput) keywordSearchInput.addEventListener('input', applyAllClientFilters);
    allCheckboxes.forEach(cb => cb.addEventListener('change', applyAllClientFilters));

    if (resetFiltersBtn) {
        resetFiltersBtn.addEventListener('click', () => {
            ['Keyword', 'User', 'Major', 'Type', 'Level'].forEach(key => localStorage.removeItem(`adminHonorFilter${key}`));
            window.location.href = "{{ url_for('admin_all_honors', filter_date='all') }}";
        });
    }

    if (applyCustomDateBtn) {
        applyCustomDateBtn.addEventListener('click', () => {
            const startDate = startDateInput.value;
            const endDate = endDateInput.value;
            if (!startDate || !endDate) { alert('请同时选择开始和结束日期。'); return; }
            if (new Date(startDate) > new Date(endDate)) { alert('开始日期不能晚于结束日期。'); return; }
            const url = new URL(window.location.href);
            url.searchParams.set('filter_date', 'custom');
            url.searchParams.set('start_date', startDate);
            url.searchParams.set('end_date', endDate);
            window.location.href = url.toString();
        });
    }

    if (editForm) {
        editForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const honorId = editHonorIdInput.value;
            if (!honorId) return;
            if (editModalLoading) editModalLoading.classList.remove('hidden');
            if (editModalError) { editModalError.textContent = ''; editModalError.classList.add('hidden'); }
            
            const formData = new FormData(editForm);
            try {
                const response = await fetch(`/edit_honor/${honorId}`, {
                    method: 'POST', body: formData, headers: { 'Accept': 'application/json' }
                });
                const result = await response.json();
                if (response.ok && result.success) {
                    closeEditModal();
                    showSuccessToast(result.message || '更新成功！页面即将刷新...');
                    setTimeout(() => window.location.reload(), 1500);
                } else {
                    const errorMsg = result.error || `更新失败 (${response.status})。`;
                    if(editModalError) { editModalError.textContent = errorMsg; editModalError.classList.remove('hidden'); }
                }
            } catch (error) {
                if(editModalError) {
                    editModalError.textContent = '请求失败，请检查网络连接。';
                    editModalError.classList.remove('hidden');
                }
            } finally {
                if(editModalLoading) editModalLoading.classList.add('hidden');
            }
        });
    }

    // --- 页面加载时初始化 ---
    applySavedStatsView();
    applySavedFilters();
    applyAllClientFilters();
});
</script>
{% endblock %}