{% extends "layout.html" %}

{% block title %}添加新荣誉{% endblock %}

{% block head_extra %}
<style>
    /* 为必填项的 <label> 添加星号 */
    .label.required::after {
      content: " *";
      color: #ff0000;
      font-weight: bold;
    }
</style>
{% endblock %}

{% block content %}
<h1 class="text-3xl font-bold mb-6 prose">添加新荣誉记录</h1>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

    <form action="{{ url_for('add_honor') }}" method="post" enctype="multipart/form-data"
          class="lg:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">

        <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 p-4 bg-base-200 rounded-lg">

            <div class="form-control w-full">
                <label class="label required" for="major_select">
                    <span class="label-text font-medium">所属专业</span>
                </label>
                <select id="major_select"
                        class="select select-bordered w-full"
                        required
                        {% if session.role != 'admin' %}disabled{% endif %}
                        {% if session.role == 'admin' %}name="major"{% endif %}>

                    {% if session.role == 'admin' %}
                        <option disabled selected value="">请选择专业</option>
                        {% for major in all_majors %}
                            <option value="{{ major }}">{{ major }}</option>
                        {% endfor %}
                    {% else %}
                        <option value="{{ session.major }}" selected>{{ session.major }}</option>
                    {% endif %}
                </select>
            </div>
            {% if session.role != 'admin' %}
            <input type="hidden" name="major" value="{{ session.major }}">
            {% endif %}

            <div class="form-control w-full">
                <label class="label required" for="teacher_select">
                    <span class="label-text font-medium">所属教师</span>
                </label>
                <select id="teacher_select"
                        class="select select-bordered w-full"
                        required
                        {% if session.role not in ['admin', 'major_admin'] %}disabled{% endif %}
                        {% if session.role in ['admin', 'major_admin'] %}name="teacher_username"{% endif %}>

                    {% if session.role in ['admin', 'major_admin'] %}
                        <option disabled selected value="">
                            {% if session.role == 'admin' %}请先选择专业{% else %}请选择教师{% endif %}
                        </option>
                        {% if session.role == 'major_admin' %}
                            {% for user in major_admin_users %}
                                <option value="{{ user.username }}">{{ user.truename }}</option>
                            {% endfor %}
                        {% endif %}
                    {% else %}
                        <option value="{{ session.username }}" selected>{{ session.truename or session.username }}</option>
                    {% endif %}
                </select>
            </div>
            {% if session.role not in ['admin', 'major_admin'] %}
            <input type="hidden" name="teacher_username" value="{{ session.username }}">
            {% endif %}
        </div>

        <div class="form-control w-full md:col-span-2 relative">
            <label class="label required" for="honor_name">
                <span class="label-text font-medium">荣誉名称</span>
            </label>
            <input type="text" id="honor_name" name="honor_name" value="{{ form_data.honor_name if form_data else '' }}" placeholder="例如：全国大学生数学建模竞赛一等奖" class="input input-bordered w-full" required />

            <div id="duplicate-alert" class="alert alert-warning shadow-lg p-3 absolute z-10 top-full mt-1 w-full hidden">
                <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-5 w-5" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
                <div>
                    <h3 class="font-bold text-sm">发现相似荣誉:</h3>
                    <ul id="warning-matches-list" class="list-disc list-inside text-xs mt-1 space-y-1">
                        </ul>
                </div>
            </div>
        </div>

        <div class="form-control w-full">
            <label class="label required" for="honor_type">
                <span class="label-text font-medium">荣誉类型</span>
            </label>
            <select id="honor_type" name="honor_type" class="select select-bordered w-full" required>
                <option disabled {% if not form_data or not form_data.honor_type %}selected{% endif %} value="">请选择类型</option>
                {% for type_option in honor_types %}
                    <option value="{{ type_option }}" {% if form_data and form_data.honor_type == type_option %}selected{% endif %}>{{ type_option }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-control w-full">
            <label class="label required" for="honor_level">
                <span class="label-text font-medium">荣誉等级</span>
            </label>
            <select id="honor_level" name="honor_level" class="select select-bordered w-full" required>
                <option disabled {% if not form_data or not form_data.honor_level %}selected{% endif %} value="">请选择等级</option>
                {% for level in honor_levels %}
                    <option value="{{ level }}" {% if form_data and form_data.honor_level == level %}selected{% endif %}>{{ level }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-control w-full">
            <label class="label required" for="honor_stamp">
                <span class="label-text font-medium">敲章/颁发单位1</span>
            </label>
            <input type="text" id="honor_stamp" name="honor_stamp" value="{{ form_data.honor_stamp if form_data else '' }}" placeholder="例如：教育部、XX大学" class="input input-bordered w-full" required />
        </div>

        <div class="form-control w-full">
            <label class="label" for="honor_stamp_other">
                <span class="label-text font-medium">敲章/颁发单位2 (可选)</span>
            </label>
            <input type="text" id="honor_stamp_other" name="honor_stamp_other" value="{{ form_data.honor_other if form_data else '' }}" placeholder="例如：XX省教育厅" class="input input-bordered w-full" />
        </div>

        <div class="form-control w-full">
            <label class="label required" for="honor_date">
                <span class="label-text font-medium">获得时间</span>
            </label>
            <input type="date" id="honor_date" name="honor_date" value="{{ form_data.honor_date if form_data else '' }}" class="input input-bordered w-full" required max="{{ now.strftime('%Y-%m-%d') }}" />
        </div>

        <div class="form-control w-full md:col-span-2">
            <label class="label required" for="honor_image_upload">
                <span class="label-text font-medium">上传证明文件</span>
            </label>
            <input type="file" id="honor_image_upload" name="honor_image" class="file-input file-input-bordered file-input-primary w-full" accept=".png,.jpg,.jpeg,.gif,.pdf" required />
            <label class="label">
                <span id="upload-status" class="label-text-alt text-xs min-h-[1rem]"></span>
                <span class="label-text-alt">支持PDF、PNG、JPG、GIF。PDF将被自动转换为图片。</span>
            </label>
        </div>

        <div class="text-center md:col-span-2 mt-4">
            <a href="{{ url_for('home') }}" class="btn btn-ghost mr-2">返回</a>
            <button type="submit" class="btn btn-primary">确认添加</button>
        </div>
    </form>

    <div class="lg:col-span-1 space-y-6">

        <div id="file-preview-card" class="card bg-base-100 shadow-xl hidden">
            <div class="card-body p-4">
                <div class="flex justify-between items-center mb-2">
                    <h2 class="card-title text-base">文件预览</h2>
                    <button id="close-preview-btn" type="button" class="btn btn-xs btn-ghost btn-circle" title="取消上传">✕</button>
                </div>
                <figure id="file-preview-figure" class="rounded-lg bg-base-200 cursor-pointer" title="点击放大预览">
                    <img id="file-preview-image" src="" alt="File Preview" class="max-h-60 w-full object-contain rounded-lg" />
                </figure>
                <p id="file-preview-name" class="text-xs text-center mt-2 truncate"></p>
            </div>
        </div>

        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <h2 class="card-title" id="recent-honors-title">我最近添加的荣誉</h2>

                <div id="recent-honors-spinner" class="text-center p-4 hidden">
                    <span class="loading loading-spinner loading-md"></span>
                </div>

                <div id="recent-honors-container" class="space-y-4">
                    {% if recent_honors %}
                        {% for honor in recent_honors %}
                        <div class="flex items-center gap-3">
                            <div class="avatar">
                                <div class="w-12 h-12 rounded bg-base-200">
                                    <img src="{{ url_for('uploaded_file_user', username=session.username, filename=honor.thumb_filename) }}"
                                         alt="{{ honor.name }} 缩略图"
                                         class="object-cover"
                                         onerror="this.style.display='none'; this.parentElement.innerHTML='<span class=\"text-xs text-base-content/50 p-1\">无图</span>';" />
                                </div>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-sm font-medium truncate" title="{{ honor.name }}">{{ honor.name }}</p>
                                <p class="text-xs text-base-content/60">{{ honor.date }}</p>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-sm text-base-content/60 italic">您（{{ session.truename }}）还没有添加过任何荣誉。</p>
                    {% endif %}
                </div>
                <div class="card-actions justify-end mt-4">
                    </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script src="https://mozilla.github.io/pdf.js/build/pdf.js"></script>
<script>
if (typeof pdfjsLib !== 'undefined') {
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://mozilla.github.io/pdf.js/build/pdf.worker.js';
}
</script>
<script>
/**
 * PDF 转换 (返回 imageFile 和 dataURL)
 */
function convertPdfToImageForSubmission(pdfFile) {
    return new Promise((resolve, reject) => {
        const fileReader = new FileReader();
        fileReader.onload = function() {
            const typedarray = new Uint8Array(this.result);
            pdfjsLib.getDocument(typedarray).promise.then(pdf => {
                return pdf.getPage(1);
            }).then(page => {
                const scale = 1.5;
                const viewport = page.getViewport({ scale: scale });
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                const renderContext = {
                    canvasContext: context,
                    viewport: viewport
                };
                page.render(renderContext).promise.then(() => {
                    const dataURL = canvas.toDataURL('image/jpeg', 0.9);
                    canvas.toBlob(blob => {
                        const newFileName = pdfFile.name.replace(/\.pdf$/i, '.jpg');
                        const imageFile = new File([blob], newFileName, {
                            type: 'image/jpeg',
                            lastModified: Date.now()
                        });
                        resolve({ imageFile: imageFile, dataURL: dataURL });
                    }, 'image/jpeg', 0.9);
                });
            }).catch(error => {
                console.error("PDF.js processing error:", error);
                reject(new Error("无法解析此PDF文件。"));
            });
        };
        fileReader.onerror = () => reject(new Error("读取文件时出错。"));
        fileReader.readAsArrayBuffer(pdfFile);
    });
}

/**
 * 文件选择处理 (带预览和点击放大)
 */
async function handleSubmissionFileSelect(
    event,
    fileInputElement,
    statusElement,
    previewCard,
    previewImg,
    previewName,
    previewFigure
) {
    statusElement.textContent = '';
    previewFigure.onclick = null;
    const file = event.target.files[0];

    if (!file) {
        previewCard.classList.add('hidden');
        statusElement.textContent = '已取消选择。';
        return;
    }

    if (file.type === 'application/pdf') {
        statusElement.textContent = '正在转换PDF为图片...';
        statusElement.style.color = 'hsl(var(--p))';
        try {
            const { imageFile, dataURL } = await convertPdfToImageForSubmission(file);
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(imageFile);
            fileInputElement.files = dataTransfer.files;
            statusElement.textContent = '✅ PDF已转换为图片。';
            statusElement.style.color = 'hsl(var(--su))';

            previewImg.src = dataURL;
            const previewTitle = file.name + " (封面预览)";
            previewName.textContent = previewTitle;
            previewCard.classList.remove('hidden');
            previewFigure.onclick = () => window.showImageModal(dataURL, previewTitle);

        } catch (error) {
            statusElement.textContent = `❌ ${error.message}`;
            statusElement.style.color = 'hsl(var(--er))';
            fileInputElement.value = '';
            previewCard.classList.add('hidden');
        }

    } else if (file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = (e) => {
            const dataURL = e.target.result;
            statusElement.textContent = '✅ 图片文件已选中。';
            statusElement.style.color = 'hsl(var(--su))';
            previewImg.src = dataURL;
            const previewTitle = file.name;
            previewName.textContent = previewTitle;
            previewCard.classList.remove('hidden');
            previewFigure.onclick = () => window.showImageModal(dataURL, previewTitle);
        };
        reader.readAsDataURL(file);

    } else {
        statusElement.textContent = `❌ 不支持的文件类型 (仅限 .pdf, .jpg, .png)。`;
        statusElement.style.color = 'hsl(var(--er))';
        fileInputElement.value = '';
        previewCard.classList.add('hidden');
    }
}
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- 1. 获取所有需要的 DOM 元素 ---

    // (文件上传/预览)
    const submissionFileInput = document.getElementById('honor_image_upload');
    const submissionStatusDiv = document.getElementById('upload-status');
    const filePreviewCard = document.getElementById('file-preview-card');
    const filePreviewImage = document.getElementById('file-preview-image');
    const filePreviewName = document.getElementById('file-preview-name');
    const filePreviewFigure = document.getElementById('file-preview-figure');
    const closePreviewBtn = document.getElementById('close-preview-btn');

    // (AJAX 查重)
    const honorNameInput = document.getElementById('honor_name');
    const warningCard = document.getElementById('duplicate-alert');
    const warningList = document.getElementById('warning-matches-list');

    // (Admin 级联 和 动态卡片)
    const teacherSelect = document.getElementById('teacher_select');

    // 【新增】动态卡片元素
    const recentHonorsTitle = document.getElementById('recent-honors-title');
    const recentHonorsContainer = document.getElementById('recent-honors-container');
    const recentHonorsSpinner = document.getElementById('recent-honors-spinner');

    // (用于防抖)
    let debounceTimeout;

    // --- 2. 定义函数 ---

    // AJAX 查重防抖
    function debounce(func, delay) {
        clearTimeout(debounceTimeout);
        debounceTimeout = setTimeout(func, delay);
    }

    // AJAX 查重核心
    async function performDuplicateCheck() {
        const name = honorNameInput.value.trim().toLowerCase();
        const username = teacherSelect.value;
        if (name.length < 3 || !username) {
            warningCard.classList.add('hidden');
            return;
        }
        try {
            const response = await fetch(`/api/check_honor_exists?name=${encodeURIComponent(name)}&username=${encodeURIComponent(username)}`, {
                method: 'GET',
                headers: { 'Accept': 'application/json' }
            });
            if (!response.ok) { throw new Error('API request failed'); }
            const data = await response.json();
            if (data.found && data.matches.length > 0) {
                warningList.innerHTML = '';
                data.matches.forEach(match => {
                    const li = document.createElement('li');
                    li.textContent = `${match.name} (${match.date})`;
                    warningList.appendChild(li);
                });
                warningCard.classList.remove('hidden');
            } else {
                warningCard.classList.add('hidden');
            }
        } catch (error) {
            console.error('Duplicate check failed:', error);
            warningCard.classList.add('hidden');
        }
    }

    // 【新增】动态卡片更新函数
    const selfUsername = "{{ session.username }}";
    async function updateRecentHonors(targetUsername, targetTruename) {
        if (!recentHonorsContainer || !recentHonorsSpinner || !recentHonorsTitle) return;

        // 1. 更新标题并显示 Spinner
        if (targetUsername === selfUsername) {
            recentHonorsTitle.textContent = "我最近添加的荣誉";
        } else {
            recentHonorsTitle.textContent = `${targetTruename} 的最近荣誉`;
        }
        recentHonorsSpinner.classList.remove('hidden');
        recentHonorsContainer.classList.add('hidden'); // 隐藏旧内容

        try {
            // 2. 调用 API
            const response = await fetch(`/api/user/${targetUsername}/recent_honors`);
            if (!response.ok) {
                throw new Error(`API request failed with status ${response.status}`);
            }
            const data = await response.json();

            // 3. 更新卡片内容
            if (data.success) {
                recentHonorsContainer.innerHTML = data.html;
            } else {
                recentHonorsContainer.innerHTML = `<p class="text-sm text-error">加载失败: ${data.error || 'Unknown error'}</p>`;
            }
        } catch (error) {
            console.error('Failed to update recent honors:', error);
            recentHonorsContainer.innerHTML = `<p class="text-sm text-error">加载荣誉时发生网络错误。</p>`;
        } finally {
            // 4. 隐藏 Spinner, 显示新内容
            recentHonorsSpinner.classList.add('hidden');
            recentHonorsContainer.classList.remove('hidden');
        }
    }

    // --- 3. 绑定所有事件 ---

    // 文件上传事件
    if (submissionFileInput) {
        submissionFileInput.addEventListener('change', (event) => {
            handleSubmissionFileSelect(
                event,
                submissionFileInput,
                submissionStatusDiv,
                filePreviewCard,
                filePreviewImage,
                filePreviewName,
                filePreviewFigure
            );
        });
    }

    // 文件预览卡片的关闭按钮
    if (closePreviewBtn) {
        closePreviewBtn.addEventListener('click', () => {
            filePreviewCard.classList.add('hidden');
            submissionFileInput.value = '';
            submissionStatusDiv.textContent = '已取消上传。';
            submissionStatusDiv.style.color = 'hsl(var(--wa))';
            filePreviewFigure.onclick = null;
        });
    }

    // AJAX 查重事件 (绑定到 honorNameInput)
    if (honorNameInput) {
        honorNameInput.addEventListener('input', () => {
            debounce(performDuplicateCheck, 500);
        });
    }

    // 教师选择框的事件 (同时触发 查重 和 动态卡片)
    if (teacherSelect) {
        teacherSelect.addEventListener('change', () => {
            // 1. 立即触发查重
            performDuplicateCheck();

            // 2. 触发动态卡片更新 (仅限 Admin 和 Major_admin)
            {% if session.role in ['admin', 'major_admin'] %}
            const selectedOption = teacherSelect.options[teacherSelect.selectedIndex];
            const selectedUsername = selectedOption.value;
            const selectedTruename = selectedOption.text.split('(')[0].trim();

            if (selectedUsername) {
                updateRecentHonors(selectedUsername, selectedTruename);
            }
            {% endif %}
        });
    }

    // Admin 级联事件 (绑定到 majorSelect)
    {% if session.role == 'admin' %}
    const majorSelect = document.getElementById('major_select');
    const teacherSelectAdmin = document.getElementById('teacher_select'); // (已在顶部定义)
    const usersByMajor = JSON.parse('{{ users_by_major_json | tojson | safe }}');

    function updateTeacherOptions(major) {
        teacherSelectAdmin.innerHTML = '';
        const users = usersByMajor[major] || [];
        if (users.length === 0) {
            const defaultOption = new Option('该专业下无教师记录', '');
            defaultOption.disabled = true;
            teacherSelectAdmin.add(defaultOption);
            teacherSelectAdmin.value = '';
        } else {
            const defaultOption = new Option('请选择教师', '');
            defaultOption.disabled = true;
            teacherSelectAdmin.add(defaultOption);
            users.forEach(user => {
                const option = new Option(`${user.truename} (${user.username})`, user.username);
                teacherSelectAdmin.add(option);
            });
            teacherSelectAdmin.value = '';
        }

        // 【重要】当专业改变时，教师被重置，
        // 此时也应该重置“最近荣誉”卡片到初始状态
        // (如果选中的教师被清空)
        if (!teacherSelectAdmin.value) {
            updateRecentHonors(selfUsername, "{{ session.truename }}");
        }
    }

    if (majorSelect) {
        majorSelect.addEventListener('change', (event) => {
            const selectedMajor = event.target.value;
            updateTeacherOptions(selectedMajor);
            // 专业改变时，也清空查重警告
            warningCard.classList.add('hidden');
        });
    }
    {% endif %}

});
</script>
{% endblock %}