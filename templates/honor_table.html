{% extends "layout.html" %}

{% block title %}我的看板{% endblock %}

{% block head_extra %}
<style>
    /* --- 样式保持不变 (No changes needed here) --- */
    #edit_honor_modal .modal-box { max-width: 48rem; width: 100%; }
    #edit_honor_modal .modal-content-grid { display: grid; grid-template-columns: 1fr 2fr; gap: 1.5rem; align-items: start; width: 100%; }
    #edit_honor_modal .modal-image-container { display: flex; flex-direction: column; align-items: center; }
    #edit_honor_modal .modal-image-container img { max-width: 100%; max-height: 300px; object-fit: contain; margin-bottom: 1rem; border-radius: 0.375rem; box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1); }
    .loading-overlay { position: absolute; inset: 0; background-color: rgba(255, 255, 255, 0.7); display: flex; align-items: center; justify-content: center; z-index: 10; border-radius: inherit; }
    .card figure img { will-change: transform; }

    @media (max-width: 768px) {
        #edit_honor_modal .modal-box { max-width: 95%; padding: 1rem; }
        #edit_honor_modal .modal-content-grid { grid-template-columns: 1fr; gap: 1rem; }
        #edit_honor_modal .modal-image-container { order: -1; }
        #edit_honor_modal .modal-image-container img { max-height: 200px; }
    }

    .honor-section-header {
        display: flex;
        justify-content: space-between; /* Pushes items to ends */
        align-items: center; /* Vertically aligns items */
        margin-bottom: 0.5rem; /* Spacing below header */
        flex-wrap: wrap; /* Allow wrapping on smaller screens */
        gap: 0.5rem; /* Space between title and filter if they wrap */
    }
    .honor-filters-container {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 0.5rem; /* 调整间距 */
    }
    .honor-filter-container label {
        margin-right: 0.5rem; /* Space between label and select */
        font-weight: 500; /* Medium weight for label */
        display: none; /* 可以隐藏标签，如果下拉框本身足够清晰 */
    }
    .honor-filter-container select {
        min-width: 130px; /* 给 select 一个合适的最小宽度 */
    }
    .stat-value.text-accent {
        color: hsl(var(--a));
    }
    /* 控制编辑按钮的显示 */
    #motto-display-area .btn {
        opacity: 0; /* 默认隐藏 */
        transition: opacity 0.2s ease-in-out;
    }
    #motto-display-area:hover .btn {
        opacity: 0.7; /* 悬停时显示 */
    }
    #motto-display-area .btn:hover {
        opacity: 1; /* 悬停在按钮本身时更明显 */
    }

    /* 编辑区域的输入框和按钮 */
    #motto-edit-area .input {
        height: 2rem; /* input-sm */
        padding-left: 0.75rem;
        padding-right: 0.75rem;
    }
    #motto-edit-area .btn {
        min-height: 2rem; /* btn-sm */
        height: 2rem;
        padding-left: 0.75rem;
        padding-right: 0.75rem;
    }

    /* 微调 Toast 的 Z-index */
    .toast { z-index: 9999 !important; }

</style>
{% endblock %}

{% block content %}
<div class="space-y-8">
    {# --- Personal Info Section (No changes) --- #}
    <section class="max-w-none">
        <h2 class="text-2xl font-semibold mb-4 divider divider-start">个人信息</h2>
        <div class="flex flex-col md:flex-row gap-6 bg-base-200 p-6 rounded-lg shadow">
            <div class="flex-1 space-y-3">
                <div>
                    <div class="text-sm font-medium text-base-content/70 mb-1">姓名</div>
                    <div class="text-2xl font-bold text-primary">{{ truename or username }}</div>
                </div>
            </div>
            <div class="flex-1 md:border-l md:border-base-300 md:pl-6">
                <div class="text-sm font-medium text-base-content/70 mb-2">个性签名</div>
                <div id="motto-display-area" class="flex items-center group cursor-pointer min-h-[2.5rem] py-1" onclick="enterEditMottoMode()">
                    <span id="motto-text" class="text-base-content/90 mr-2 flex-grow italic" title="点击编辑签名">"{{ motto or '编辑您的个性签名...' }}"</span>
                    <button id="edit-motto-btn" type="button" class="btn btn-ghost btn-xs p-1 opacity-0 group-hover:opacity-70 focus:opacity-70 transition-opacity" title="编辑签名">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                            <path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" />
                        </svg>
                    </button>
                </div>
                <div id="motto-edit-area" class="hidden">
                    <div class="flex items-center gap-2">
                        <input type="text" id="motto-input"
                               class="input input-bordered input-sm w-full flex-grow"
                               placeholder="输入签名 (最多100字)" maxlength="100">
                        <button id="save-motto-btn" type="button" class="btn btn-primary btn-sm">
                            <span class="loading loading-spinner loading-xs hidden"></span>
                            保存
                        </button>
                        <button id="cancel-motto-btn" type="button" class="btn btn-ghost btn-sm">取消</button>
                    </div>
                    <div id="motto-error" class="text-error text-xs mt-1 h-4"></div>
                </div>
            </div>
        </div>
    </section>

    {# --- Statistics Section (【修改】添加ID以便JS更新) --- #}
    <section>
        <div class="flex flex-wrap items-center justify-between gap-4 mb-3">
            <h2 class="text-xl font-semibold divider divider-start my-0 flex-shrink-0">荣誉统计</h2>
            <div class="btn-group">
                <button id="stats-toggle-type" class="btn btn-sm btn-active" onclick="switchStatsView('type')">按类型</button>
                <button id="stats-toggle-level" class="btn btn-sm" onclick="switchStatsView('level')">按等级</button>
            </div>
        </div>

        {# --- Statistics Display Area --- #}
        {# 1. Stats by Type (Initially Visible) #}
        <div id="stats-by-type">
            {% if total_honor_count > 0 or honor_type_counts %}
                <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 xl:grid-cols-6 gap-4 w-full">
                    <div class="bg-base-200 shadow rounded-lg p-4 flex flex-col justify-center items-center text-center h-full">
                        <div class="text-sm font-medium text-base-content/70 mb-1">总计</div>
                        {# 【修改】为总计的数值添加ID #}
                        <div id="stat-total-count-by-type" class="text-3xl font-bold text-primary">{{ total_honor_count | default(0) }}</div>
                        <div class="text-xs text-base-content/50 mt-1">项荣誉</div>
                    </div>
                    {% for type_name, count in honor_type_counts.items() %}
                    <div class="bg-base-200 shadow rounded-lg p-4 flex flex-col justify-center items-center text-center h-full">
                        <div class="text-sm font-medium text-base-content/70 mb-1">{{ type_name | escape }}</div>
                        {# 【修改】为每种类型的数值添加唯一ID，并保持初始值 #}
                        <div id="stat-value-type-{{ type_name | escape }}" class="stat-value text-3xl font-bold {{ 'text-accent' if count > 0 else 'text-base-content/30' }}">{{ count }}</div>
                        <div class="text-xs text-base-content/50 mt-1">项记录</div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                {# This part remains unchanged #}
                <div role="alert" class="alert alert-info mt-4 shadow-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
                    <span>您还没有添加任何荣誉记录。</span>
                    <a href="{{ url_for('add_honor') }}" class="btn btn-sm btn-primary">立即添加</a>
                </div>
            {% endif %}
        </div> {# End stats-by-type #}

        {# 2. Stats by Level (Initially Hidden) #}
        <div id="stats-by-level" class="hidden">
             {% if total_honor_count > 0 or honor_level_counts %}
                <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 xl:grid-cols-6 gap-4 w-full">
                    <div class="bg-base-200 shadow rounded-lg p-4 flex flex-col justify-center items-center text-center h-full">
                        <div class="text-sm font-medium text-base-content/70 mb-1">总计</div>
                        {# 【修改】为总计的数值添加ID #}
                        <div id="stat-total-count-by-level" class="text-3xl font-bold text-primary">{{ total_honor_count | default(0) }}</div>
                        <div class="text-xs text-base-content/50 mt-1">项荣誉</div>
                    </div>
                    {% for level_name, count in honor_level_counts.items() %}
                        <div class="bg-base-200 shadow rounded-lg p-4 flex flex-col justify-center items-center text-center h-full">
                            <div class="text-sm font-medium text-base-content/70 mb-1">{{ level_name | escape }}</div>
                            {# 【修改】为每种等级的数值添加唯一ID，并保持初始值 #}
                            <div id="stat-value-level-{{ level_name | escape }}" class="stat-value text-3xl font-bold {{ 'text-accent' if count > 0 else 'text-base-content/30' }}">{{ count }}</div>
                            <div class="text-xs text-base-content/50 mt-1">项记录</div>
                        </div>
                    {% endfor %}
                </div>
             {% else %}
                {# This part remains unchanged #}
                <div role="alert" class="alert alert-info mt-4 shadow-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
                    <span>您还没有添加任何荣誉记录。</span>
                    <a href="{{ url_for('add_honor') }}" class="btn btn-sm btn-primary">立即添加</a>
                </div>
             {% endif %}
        </div> {# End stats-by-level #}
    </section> {# --- Statistics Section End --- #}


    {# --- Honors Grid Section (No changes to the grid itself) --- #}
    <section>
        <div class="honor-section-header">
            {% set filter_text = "全部时间" %}
            {% if selected_date_filter == 'last_year' %}
                {% set filter_text = "一年内" %}
            {% elif selected_date_filter == 'last_3_years' %}
                {% set filter_text = "三年内" %}
            {% elif selected_date_filter == 'last_5_years' %}
                {% set filter_text = "五年内" %}
            {% endif %}
            <h2 class="text-xl font-semibold divider divider-start my-0 flex-shrink-0">
                我的荣誉记录 <span class="text-base-content/70 font-normal">({{ filter_text }})</span>
            </h2>
            <div class="honor-filters-container">
                <div class="honor-filter-container">
                    <select id="date-filter-select" name="filter_date" class="select select-bordered select-sm w-full max-w-xs" title="按时间筛选荣誉列表">
                        <option value="all" {% if selected_date_filter == 'all' %}selected{% endif %}>全部时间</option>
                        <option value="last_year" {% if selected_date_filter == 'last_year' %}selected{% endif %}>一年内</option>
                        <option value="last_3_years" {% if selected_date_filter == 'last_3_years' %}selected{% endif %}>三年内</option>
                        <option value="last_5_years" {% if selected_date_filter == 'last_5_years' %}selected{% endif %}>五年内</option>
                    </select>
                </div>
                {% if honors and honor_types %}
                <div class="honor-filter-container">
                    <select id="honor-type-filter" name="honor_type_filter" class="select select-bordered select-sm" title="按类型筛选当前列表">
                        <option value="">全部类型</option>
                        {% for type_option in honor_types %}
                            <option value="{{ type_option | escape }}">{{ type_option }}</option>
                        {% endfor %}
                    </select>
                </div>
                {% endif %}
                {% if honors and honor_levels %}
                <div class="honor-filter-container">
                    <select id="honor-level-filter" name="honor_level_filter" class="select select-bordered select-sm" title="按等级筛选当前列表">
                        <option value="">全部等级</option>
                        {% for level_option in honor_levels %}
                            <option value="{{ level_option | escape }}">{{ level_option }}</option>
                        {% endfor %}
                    </select>
                </div>
                {% endif %}
            </div>
        </div>

        {% if honors %}
            <div id="honors-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-4 gap-6">
                {% for honor in honors %}
                    {% set current_level = honor.honor_level or honor.level %}
                    <div id="card-{{ honor.id }}"
                         class="card bg-base-100 shadow-xl transition-shadow duration-300 hover:shadow-2xl group overflow-hidden"
                         data-type="{{ honor.type | escape }}"
                         data-level="{{ current_level | default('', true) | escape }}"
                         >
                        <figure class="relative cursor-pointer overflow-hidden h-64 w-full" onclick="showImageModal('{{ url_for('uploaded_file_user', username=username, filename=honor.image_filename) }}', '{{ honor.name | escape | replace("'", "\\'") }}')">
                            {% set parts = honor.image_filename.rsplit('.', 1) %}
                            {% set thumb_filename = parts[0] + '_thumb.' + parts[1] if parts|length == 2 else honor.image_filename %}
                            <img id="img-thumb-{{ honor.id }}"
                                 src="{{ url_for('uploaded_file_user', username=username, filename=thumb_filename) }}"
                                 alt="{{ honor.name }} 缩略图" loading="lazy"
                                 class="transition-transform duration-300 group-hover:scale-110 object-cover h-full w-full"
                                 onerror="this.onerror=null; this.src='{{ url_for('uploaded_file_user', username=username, filename=honor.image_filename) }}';" />
                        </figure>
                        <div class="card-body p-4">
                            <h3 id="card-title-{{ honor.id }}" class="card-title text-base lg:text-lg font-semibold truncate" title="{{ honor.name }}">{{ honor.name }}</h3>
                            <div class="text-sm text-base-content/80 space-y-1 mt-2">
                                <p><span class="font-medium text-base-content/60">类型:</span> <span id="card-type-{{ honor.id }}">{{ honor.type }}</span></p>
                                {% if current_level %}
                                <p><span class="font-medium text-base-content/60">等级:</span> <span id="card-level-{{ honor.id }}">{{ current_level }}</span></p>
                                {% endif %}
                                <p><span class="font-medium text-base-content/60">时间:</span> <span id="card-date-{{ honor.id }}">{{ honor.date }}</span></p>
                                <p><span class="font-medium text-base-content/60">单位:</span> <span id="card-stamp-{{ honor.id }}" title="{{ honor.stamp }}">{{ honor.stamp | truncate(20) }}</span></p>

                            </div>
                            <div class="card-actions justify-end mt-3 items-center space-x-2">
                                <button type="button" id="edit-btn-{{ honor.id }}" class="btn btn-xs sm:btn-sm btn-outline btn-primary" title="编辑"
                                        onclick="openEditModal(this)"
                                        data-id="{{ honor.id }}"
                                        data-name="{{ honor.name | escape }}"
                                        data-type="{{ honor.type | escape }}"
                                        data-level="{{ current_level | default('', true) | escape }}"
                                        data-date="{{ honor.date }}"
                                        data-stamp="{{ honor.stamp | escape }}"
                                        data-stamp-other="{{ honor.stamp_other | default('', true) | escape }}"
                                        data-image-url="{{ url_for('uploaded_file_user', username=username, filename=honor.image_filename) }}"
                                        >
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" /></svg>
                                    <span class="hidden sm:inline ml-1">编辑</span>
                                </button>
                                <form method="post" action="{{ url_for('delete_honor', honor_id=honor.id) }}" onsubmit="return confirm('警告：您确定要永久删除这条荣誉记录 “{{ honor.name | escape | replace("'", "\\'") }}” 吗？\n\n此操作将同时删除关联的图片文件，且无法撤销！');" style="display: inline;">
                                    <button type="submit" class="btn btn-xs sm:btn-sm btn-outline btn-secondary" title="删除">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" /></svg>
                                        <span class="hidden sm:inline ml-1">删除</span>
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
            <div id="no-honors-message" class="alert alert-warning mt-6 shadow-md hidden" role="alert">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 3.75h.008v.008H12v-.008Z" /></svg>
                <span>在当前列表（{{ filter_text }}）中，未找到符合所选类型/等级条件的荣誉记录。请尝试调整筛选器或选择不同的时间范围。</span>
                <button class="btn btn-sm btn-ghost" onclick="resetFilters()">重置类型/等级筛选</button>
            </div>
        {% else %}
             <div role="alert" class="alert alert-info mt-6 shadow-md">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <span>在选定的时间范围（{{ filter_text }}）内，您还没有添加任何荣誉记录。</span>
                <a href="{{ url_for('add_honor') }}" class="btn btn-sm btn-primary ml-4">立即添加</a>
            </div>
        {% endif %}
    </section>

</div>

{# --- MODAL DEFINITIONS (No changes) --- #}
<dialog id="edit_honor_modal" class="modal modal-bottom sm:modal-middle">
  <div class="modal-box relative">
    <div id="edit_modal_loading" class="loading-overlay hidden justify-center items-center">
        <span class="loading loading-spinner loading-lg text-primary"></span>
    </div>
    <div class="modal-content-grid">
        <div class="modal-image-container">
            <img id="edit_modal_image" src="" alt="当前荣誉图片" class="rounded shadow"/>
            <span class="text-xs text-gray-500 mt-1">当前图片</span>
        </div>
        <div class="modal-form-container">
            <form id="edit_honor_form" class="space-y-3">
                <h3 class="font-bold text-lg mb-3 text-center">编辑荣誉信息</h3>
                <input type="hidden" id="edit_honor_id" name="honor_id">

                <div class="form-control w-full">
                    <label class="label py-1" for="edit_honor_name"><span class="label-text font-medium">荣誉名称 <span class="text-error">*</span></span></label>
                    <input type="text" id="edit_honor_name" name="honor_name" class="input input-sm input-bordered w-full" required />
                </div>
                <div class="form-control w-full">
                    <label class="label py-1" for="edit_honor_type"><span class="label-text font-medium">荣誉类型 <span class="text-error">*</span></span></label>
                    <select id="edit_honor_type" name="honor_type" class="select select-sm select-bordered w-full" required>
                        <option value="" disabled>请选择类型</option>
                        {% for type_option in honor_types %}
                            <option value="{{ type_option | escape }}">{{ type_option }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-control w-full">
                    <label class="label py-1" for="edit_honor_level"><span class="label-text font-medium">荣誉等级 <span class="text-error">*</span></span></label>
                    <select id="edit_honor_level" name="honor_level" class="select select-sm select-bordered w-full" required>
                          <option value="" disabled>请选择等级</option>
                          {% for level_option in honor_levels %}
                              <option value="{{ level_option | escape }}">{{ level_option }}</option>
                          {% endfor %}
                    </select>
                </div>
                <div class="form-control w-full">
                    <label class="label py-1" for="edit_honor_date"><span class="label-text font-medium">获得时间 <span class="text-error">*</span></span></label>
                    <input type="date" id="edit_honor_date" name="honor_date" class="input input-sm input-bordered w-full" required max="{{ now().strftime('%Y-%m-%d') }}"/>
                </div>
                 <div class="form-control w-full">
                    <label class="label py-1" for="edit_honor_stamp"><span class="label-text font-medium">敲章/颁发单位 <span class="text-error">*</span></span></label>
                    <input type="text" id="edit_honor_stamp" name="honor_stamp" class="input input-sm input-bordered w-full" required />
                </div>
                <div class="form-control w-full">
                    <label class="label py-1" for="edit_honor_stamp_other"><span class="label-text font-medium">敲章/颁发单位2 (可选)</span></label>
                    <input type="text" id="edit_honor_stamp_other" name="honor_stamp_other" class="input input-sm input-bordered w-full" />
                </div>
                <div class="form-control w-full">
                     <label class="label py-1" for="edit_honor_image_file"><span class="label-text font-medium">替换证明图片 (可选)</span></label>
                     <input type="file" id="edit_honor_image_file" name="honor_image" class="file-input file-input-sm file-input-bordered file-input-secondary w-full" accept="image/png, image/jpeg, image/gif" />
                     <label class="label py-0"><span class="label-text-alt text-xs">不选则保留原图</span></label>
                 </div>
                <div id="edit_modal_error" class="text-error text-sm mt-2 hidden min-h-[1.25rem]"></div>
                <div class="modal-action mt-4 justify-end space-x-2">
                    <button type="button" class="btn btn-sm btn-ghost" onclick="closeEditModal()">取消</button>
                    <button type="submit" class="btn btn-sm btn-primary">确认修改</button>
                </div>
            </form>
        </div>
    </div>
    <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2" onclick="closeEditModal()">✕</button>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button type="button" onclick="closeEditModal()">close</button>
  </form>
</dialog>

<dialog id="image_modal" class="modal">
  <div class="modal-box max-w-4xl p-4">
    <h3 id="modal_title" class="font-bold text-lg mb-4 text-center">图片详情</h3>
    <figure class="flex justify-center items-center max-h-[85vh]">
        <img id="modal_image" src="" alt="荣誉图片详情" class="max-w-full max-h-full object-contain rounded shadow-lg" />
    </figure>
    <div class="modal-action mt-4">
      <form method="dialog">
        <button class="btn">关闭</button>
      </form>
    </div>
  </div>
    <form method="dialog" class="modal-backdrop">
      <button>close</button>
    </form>
</dialog>

<div id="toast-success" class="toast toast-top toast-center hidden z-50">
  <div class="alert alert-success shadow-lg">
    <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
    <span id="toast-success-message">操作成功！</span>
  </div>
</div>
{% endblock %}


{# ====================================================== #}
{# =============== JAVASCRIPT SECTION =================== #}
{# ====================================================== #}
{% block scripts %}
<script>
    // --- DOM Element References ---
    // (This part has no changes, just for context)
    const editModal = document.getElementById('edit_honor_modal');
    const editForm = document.getElementById('edit_honor_form');
    // ... other modal elements ...
    const successToast = document.getElementById('toast-success');
    const successToastMessage = document.getElementById('toast-success-message');

    // Filtering Elements
    const dateFilterSelect = document.getElementById('date-filter-select');
    const honorTypeFilterSelect = document.getElementById('honor-type-filter');
    const honorLevelFilterSelect = document.getElementById('honor-level-filter');
    const honorsGrid = document.getElementById('honors-grid');
    const noHonorsMessage = document.getElementById('no-honors-message');

    // Statistics Toggle Elements
    const statsByTypeDiv = document.getElementById('stats-by-type');
    const statsByLevelDiv = document.getElementById('stats-by-level');
    const statsToggleTypeBtn = document.getElementById('stats-toggle-type');
    const statsToggleLevelBtn = document.getElementById('stats-toggle-level');

    const currentUsername = "{{ username }}";

    // 【新增】将后端传来的所有类型和等级存入JS数组，用于重置统计
    const allHonorTypes = {{ honor_types | tojson }};
    const allHonorLevels = {{ honor_levels | tojson }};


    // --- Function: Close Edit Modal and Reset State (No changes) ---
    function closeEditModal() { /* ... no changes ... */ }

    // --- Function: Switch Statistics View (No changes) ---
    function switchStatsView(viewType) { /* ... no changes ... */ }

    // 【新增】一个新的函数，专门用来根据计算好的数量更新统计UI
    function updateStatsUI(visibleCount, typeCounts, levelCounts) {
        console.log("Updating stats UI...");

        // 更新“按类型”统计视图
        const totalCountTypeEl = document.getElementById('stat-total-count-by-type');
        if (totalCountTypeEl) {
            totalCountTypeEl.textContent = visibleCount;
        }
        allHonorTypes.forEach(typeName => {
            const count = typeCounts[typeName] || 0;
            const valueEl = document.getElementById(`stat-value-type-${typeName}`);
            if (valueEl) {
                valueEl.textContent = count;
                valueEl.classList.toggle('text-accent', count > 0);
                valueEl.classList.toggle('text-base-content/30', count === 0);
            }
        });

        // 更新“按等级”统计视图
        const totalCountLevelEl = document.getElementById('stat-total-count-by-level');
        if (totalCountLevelEl) {
            totalCountLevelEl.textContent = visibleCount;
        }
        allHonorLevels.forEach(levelName => {
            const count = levelCounts[levelName] || 0;
            const valueEl = document.getElementById(`stat-value-level-${levelName}`);
            if (valueEl) {
                valueEl.textContent = count;
                valueEl.classList.toggle('text-accent', count > 0);
                valueEl.classList.toggle('text-base-content/30', count === 0);
            }
        });
    }


    // 【修改】核心修改：applyFilters 函数现在会计算统计数据并调用 updateStatsUI
    function applyFilters() {
        if (!honorsGrid) {
            console.warn("Honors grid not found, cannot apply filters.");
            if (noHonorsMessage) noHonorsMessage.classList.add('hidden');
            return;
        }

        const selectedType = honorTypeFilterSelect ? honorTypeFilterSelect.value : "";
        const selectedLevel = honorLevelFilterSelect ? honorLevelFilterSelect.value : "";
        console.log(`Applying filters - Type: "${selectedType || 'All'}", Level: "${selectedLevel || 'All'}"`);

        const honorCards = honorsGrid.querySelectorAll('.card[data-type][data-level]');
        let visibleCount = 0;

        // 【新增】用于存储筛选后统计结果的对象
        const visibleTypeCounts = {};
        const visibleLevelCounts = {};

        honorCards.forEach(card => {
            const cardType = card.dataset.type;
            const cardLevel = card.dataset.level;
            const typeMatch = (selectedType === "" || cardType === selectedType);
            const levelMatch = (selectedLevel === "" || cardLevel === selectedLevel);

            if (typeMatch && levelMatch) {
                card.style.display = '';
                visibleCount++;
                // 【新增】累加可见卡片的类型和等级
                visibleTypeCounts[cardType] = (visibleTypeCounts[cardType] || 0) + 1;
                if (cardLevel) { // 确保等级存在
                    visibleLevelCounts[cardLevel] = (visibleLevelCounts[cardLevel] || 0) + 1;
                }
            } else {
                card.style.display = 'none';
            }
        });

        // 【新增】在筛选结束后，调用新的UI更新函数
        updateStatsUI(visibleCount, visibleTypeCounts, visibleLevelCounts);

        if (noHonorsMessage) {
            const isFiltering = selectedType !== "" || selectedLevel !== "";
            noHonorsMessage.classList.toggle('hidden', !(visibleCount === 0 && isFiltering));
        }
        console.log(`Filtering complete. ${visibleCount} cards visible.`);
    }

    // --- Function: Reset Type/Level Filters (No changes) ---
    function resetFilters() {
        if (honorTypeFilterSelect) honorTypeFilterSelect.value = "";
        if (honorLevelFilterSelect) honorLevelFilterSelect.value = "";
        applyFilters(); // Re-apply, which will now also reset stats
        console.log("Client-side filters reset.");
    }

    // --- Event Listeners (No changes required here) ---
    if (dateFilterSelect) {
        dateFilterSelect.addEventListener('change', (event) => {
            const selectedValue = event.target.value;
            const currentUrl = new URL(window.location.href);
            currentUrl.searchParams.set('filter_date', selectedValue);
            window.location.href = currentUrl.toString();
        });
    }

    if (honorTypeFilterSelect) {
        honorTypeFilterSelect.addEventListener('change', applyFilters);
    }
    {% if honors and honor_types %}
    else { console.warn("Type filter select element not found."); }
    {% endif %}


    if (honorLevelFilterSelect) {
        honorLevelFilterSelect.addEventListener('change', applyFilters);
    }
    {% if honors and honor_levels %}
    else { console.warn("Level filter select element not found."); }
    {% endif %}


    // --- Other Functions (openEditModal, handle edit, show toasts, etc.) ---
    // --- These do not need changes for this feature request. ---
    function openEditModal(buttonElement) { /* ... no changes ... */ }
    if (editForm) { editForm.addEventListener('submit', async (event) => { /* ... no changes ... */ }); }
    function updateCard(honorId, updatedHonor) { /* ... no changes ... */ }
    function showSuccessToast(message) { /* ... no changes ... */ }
    function showImageModal(imageUrl, imageTitle) { /* ... no changes ... */ }
    // --- Motto editing functions also remain unchanged ---
    function enterEditMottoMode() { /* ... no changes ... */ }
    function exitEditMottoMode() { /* ... no changes ... */ }
    async function saveMotto() { /* ... no changes ... */ }
    // All motto-related event listeners also remain unchanged.


    // --- Initial Setup on DOM Load ---
    document.addEventListener('DOMContentLoaded', () => {
        console.log("DOM fully loaded. Applying initial filters and calculating initial stats.");
        // 【修改】页面加载时运行一次 applyFilters，以确保初始统计数据正确显示
        applyFilters();
    });

    // Dummy functions to prevent "not defined" errors if you copy only a part of the script
    // These should already exist in your file
    if(typeof closeEditModal === 'undefined') { function closeEditModal() {} }
    if(typeof openEditModal === 'undefined') { function openEditModal() {} }
    if(typeof showImageModal === 'undefined') { function showImageModal(e,t) {} }
    if(typeof updateCard === 'undefined') { function updateCard(e,t) {} }
    if(typeof enterEditMottoMode === 'undefined') { function enterEditMottoMode() {} }
    if(typeof exitEditMottoMode === 'undefined') { function exitEditMottoMode() {} }
    if(typeof saveMotto === 'undefined') { async function saveMotto() {} }
    // Add event listeners for motto just in case
    document.getElementById('motto-display-area')?.addEventListener('click', enterEditMottoMode);
    document.getElementById('cancel-motto-btn')?.addEventListener('click', exitEditMottoMode);
    document.getElementById('save-motto-btn')?.addEventListener('click', saveMotto);

</script>
{% endblock %}