{% extends "layout.html" %}

{% block title %}{{ user_truename }} - 我的荣誉表{% endblock %}

{% block head_extra %}
<script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>
<style>
    /* 表格吸顶/吸左样式 */
    .table th:first-child, .table td:first-child {
        position: sticky; left: 0; z-index: 1;
        /* 根据主题背景色调整，防止透视 */
        background-color: hsl(var(--b1));
    }
    .table th {
        position: sticky; top: 0; z-index: 2;
        background-color: hsl(var(--b2, var(--b1)));
    }
    .table-container {
        max-height: 70vh;
        overflow: auto;
        border: 1px solid hsl(var(--b3, var(--b1)));
        border-radius: var(--rounded-box, 1rem);
    }
    .table { width: 100%; }

    /* 筛选器头部布局 */
    .filters-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
        gap: 1rem;
    }
    .filters-container {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 0.75rem;
    }
    .keyword-search-container {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex-grow: 1;
        max-width: 250px;
    }
    .dropdown-content .menu a:hover, .dropdown-content .menu li>a:hover {
        background-color: hsl(var(--b3));
    }
</style>
{% endblock %}

{% block content %}

{# --- 1. 筛选和标题区域 --- #}
<div class="filters-header">
    {# 动态标题 #}
    {% set filter_map = {'last_year': '一年内', 'last_3_years': '三年内', 'last_5_years': '五年内'} %}
    {% set filter_text = filter_map.get(selected_date_filter, '全部时间') %}
    {% if selected_date_filter == 'custom' and request.args.get('start_date') and request.args.get('end_date') %}
        {% set filter_text = request.args.get('start_date') + ' 至 ' + request.args.get('end_date') %}
    {% elif selected_date_filter == 'custom' %}
        {% set filter_text = '自选时间段' %}
    {% endif %}
    <h1 class="text-2xl font-semibold my-0 flex-shrink-0">
        {{ user_truename }} 的荣誉记录
        <span class="text-base-content/70 font-normal text-lg">({{ filter_text }})</span>
    </h1>

    {# 筛选器与操作按钮容器 #}
    <div class="filters-container">
        {# 关键词搜索 (客户端实时筛选) #}
        <div class="keyword-search-container" title="按荣誉名称实时搜索">
            <input type="search" id="keyword-search-input" class="input input-bordered input-sm w-full" placeholder="搜索荣誉名称...">
        </div>

        {# 时间筛选 Dropdown #}
        <div class="dropdown dropdown-end">
            <label tabindex="0" class="btn btn-sm btn-outline m-1 font-normal">
                <span>{{ filter_text }}</span>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
            </label>
            <div tabindex="0" class="dropdown-content z-[10] menu p-4 shadow bg-base-200 rounded-box w-80 space-y-3">
                <h4 class="font-bold px-4">筛选时间</h4>
                <ul class="menu p-0">
                    {# 注意 url_for 指向 honor_table #}
                    <li><a href="{{ url_for('honor_table', filter_date='all') }}">全部时间</a></li>
                    <li><a href="{{ url_for('honor_table', filter_date='last_year') }}">一年内</a></li>
                    <li><a href="{{ url_for('honor_table', filter_date='last_3_years') }}">三年内</a></li>
                    <li><a href="{{ url_for('honor_table', filter_date='last_5_years') }}">五年内</a></li>
                </ul>
                <div class="divider my-1">或自选范围</div>
                <div class="space-y-2 px-2">
                    <div class="form-control">
                        <label class="label py-0"><span class="label-text-alt">开始日期</span></label>
                        <input type="date" id="start-date-input" class="input input-bordered input-sm" value="{{ request.args.get('start_date', '') }}">
                    </div>
                    <div class="form-control">
                         <label class="label py-0"><span class="label-text-alt">结束日期</span></label>
                        <input type="date" id="end-date-input" class="input input-bordered input-sm" value="{{ request.args.get('end_date', '') }}" max="{{ now().strftime('%Y-%m-%d') }}">
                    </div>
                </div>
                <button id="apply-custom-date-btn" class="btn btn-secondary btn-sm w-full">应用自选范围</button>
            </div>
        </div>

        {# 类型筛选 Dropdown #}
        <div class="dropdown dropdown-end">
            <label tabindex="0" class="btn btn-sm btn-outline m-1 font-normal" id="type-filter-btn">
                <span id="type-filter-label">筛选类型</span>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
            </label>
            <div tabindex="0" class="dropdown-content z-[10] menu p-4 shadow bg-base-200 rounded-box w-60 space-y-1">
                <h4 class="font-bold px-4 mb-2">筛选类型</h4>
                <div class="max-h-60 overflow-y-auto">
                {% for type_option in honor_types %}
                    <div class="form-control">
                        <label class="label py-1 cursor-pointer">
                            <span class="label-text">{{ type_option }}</span>
                            <input type="checkbox" value="{{ type_option | escape }}" class="checkbox checkbox-sm checkbox-primary honor-type-cb"/>
                        </label>
                    </div>
                {% endfor %}
                </div>
            </div>
        </div>

        {# 等级筛选 Dropdown #}
        <div class="dropdown dropdown-end">
            <label tabindex="0" class="btn btn-sm btn-outline m-1 font-normal" id="level-filter-btn">
                <span id="level-filter-label">筛选等级</span>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
            </label>
            <div tabindex="0" class="dropdown-content z-[10] menu p-4 shadow bg-base-200 rounded-box w-60 space-y-1">
                 <h4 class="font-bold px-4 mb-2">筛选等级</h4>
                 <div class="max-h-60 overflow-y-auto">
                {% for level_option in honor_levels %}
                    <div class="form-control">
                        <label class="label py-1 cursor-pointer">
                            <span class="label-text">{{ level_option }}</span>
                            <input type="checkbox" value="{{ level_option | escape }}" class="checkbox checkbox-sm checkbox-primary honor-level-cb"/>
                        </label>
                    </div>
                {% endfor %}
                </div>
            </div>
        </div>
        
        {# 操作按钮组 #}
        <button id="reset-filters-btn" class="btn btn-primary btn-sm" title="重置全部筛选">重置</button>

        <div class="dropdown dropdown-end">
            <label tabindex="0" class="btn btn-sm btn-accent">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 mr-1"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>
                下载
            </label>
            <ul tabindex="0" class="dropdown-content z-[20] menu p-2 shadow bg-base-200 rounded-box w-56 mt-2">
                <li><a id="download-jpg-zip-btn"><span class="loading loading-spinner loading-xs hidden"></span>下载为 JPG (.zip)</a></li>
                <li><a id="download-pdf-zip-btn"><span class="loading loading-spinner loading-xs hidden"></span>下载为 PDF (.zip)</a></li>
                <div class="divider my-1"></div>
                <li><a id="download-excel-btn">下载表格 (.xlsx)</a></li>
            </ul>
        </div>
    </div>
</div>

{# --- 2. 表格区域 --- #}
<div class="table-container shadow-md">
    <div class="overflow-x-auto">
      <table class="table table-zebra table-pin-rows table-pin-cols w-full">
        <thead>
          <tr>
            <th>荣誉名称</th>
            <th>类型</th>
            <th>等级</th>
            <th>获得日期</th>
            <th>颁发单位</th>
            <th class="text-center">操作</th>
          </tr>
        </thead>
        <tbody id="honors-table-body">
          {% if honors %}
              {% for honor in honors %}
              <tr data-id="{{ honor.id }}" data-type="{{ honor.type | escape }}" data-level="{{ honor.display_level | escape }}" data-name="{{ honor.name | escape }}">
                <td class="font-medium">{{ honor.name }}</td>
                <td>{{ honor.type }}</td>
                <td>
                    <span class="badge badge-ghost badge-md">{{ honor.display_level }}</span>
                </td>
                <td>{{ honor.date }}</td>
                <td title="{{ honor.stamp }}{% if honor.stamp_other %} / {{ honor.stamp_other }}{% endif %}">
                    {{ honor.stamp | truncate(30) }}
                    {% if honor.stamp_other %}<span class="tooltip" data-tip="其他单位: {{ honor.stamp_other }}"><span class="badge badge-outline badge-xs ml-1">+1</span></span>{% endif %}
                </td>
                <td class="text-center">
                  {% if honor.image_filename %}
                  <div class="flex gap-2 justify-center">
                       <a href="{{ url_for('download_honor_image_jpg', honor_id=honor.id) }}" class="btn btn-xs btn-outline btn-secondary" download>JPG</a>
                       <a href="{{ url_for('download_honor_pdf', honor_id=honor.id) }}" class="btn btn-xs btn-outline btn-accent" download>PDF</a>
                  </div>
                  {% else %}
                  <span class="text-xs text-base-content/50 italic">无文件</span>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
          {% else %}
              <tr>
                  <td colspan="6" class="text-center text-base-content/70 py-6">
                      在 “{{ filter_text }}” 内没有荣誉记录。
                      <a href="{{ url_for('honor_table') }}" class="btn btn-xs btn-link">查看全部时间</a>
                  </td>
              </tr>
          {% endif %}
        </tbody>
         <tbody id="no-honors-message-body" class="hidden">
             <tr>
                 <td colspan="6" class="text-center text-warning py-6">
                     <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 3.75h.008v.008H12v-.008Z" /></svg>
                      在当前视图中，未找到符合所选条件的荣誉记录。
                     <button class="btn btn-xs btn-link" onclick="resetClientFilters()">重置筛选</button>
                 </td>
             </tr>
         </tbody>
      </table>
    </div>
</div>

{# --- 3. 全局 Toast 提示 --- #}
<div id="toast-container" class="toast toast-top toast-center z-[100]">
    <div id="toast-success" class="alert alert-success shadow-lg hidden"><span></span></div>
    <div id="toast-error" class="alert alert-error shadow-lg hidden"><span></span></div>
    <div id="toast-info" class="alert alert-info shadow-lg hidden"><span></span></div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- DOM 元素引用 ---
    const honorsTableBody = document.getElementById('honors-table-body');
    const noHonorsMessageBody = document.getElementById('no-honors-message-body');
    const keywordSearchInput = document.getElementById('keyword-search-input');
    const resetFiltersBtn = document.getElementById('reset-filters-btn');
    
    // Dropdown 筛选器
    const startDateInput = document.getElementById('start-date-input');
    const endDateInput = document.getElementById('end-date-input');
    const applyCustomDateBtn = document.getElementById('apply-custom-date-btn');
    const typeFilterBtnLabel = document.getElementById('type-filter-label');
    const levelFilterBtnLabel = document.getElementById('level-filter-label');
    const typeCheckboxes = document.querySelectorAll('.honor-type-cb');
    const levelCheckboxes = document.querySelectorAll('.honor-level-cb');

    // 下载按钮
    const downloadJpgZipBtn = document.getElementById('download-jpg-zip-btn');
    const downloadPdfZipBtn = document.getElementById('download-pdf-zip-btn');
    const downloadExcelBtn = document.getElementById('download-excel-btn');

    // --- 核心筛选逻辑 ---
    function applyAllClientFilters() {
        if (!honorsTableBody) return;

        const keyword = keywordSearchInput ? keywordSearchInput.value.trim().toLowerCase() : "";
        const selectedTypes = Array.from(typeCheckboxes).filter(cb => cb.checked).map(cb => cb.value);
        const selectedLevels = Array.from(levelCheckboxes).filter(cb => cb.checked).map(cb => cb.value);

        const honorRows = honorsTableBody.querySelectorAll('tr[data-id]');
        let visibleCount = 0;

        honorRows.forEach(row => {
            const rowName = (row.dataset.name || "").toLowerCase();
            const rowType = row.dataset.type;
            const rowLevel = row.dataset.level;

            const nameMatch = !keyword || rowName.includes(keyword);
            const typeMatch = selectedTypes.length === 0 || selectedTypes.includes(rowType);
            const levelMatch = selectedLevels.length === 0 || selectedLevels.includes(rowLevel);

            if (nameMatch && typeMatch && levelMatch) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });
        
        // 更新UI
        const isFiltering = keyword || selectedTypes.length > 0 || selectedLevels.length > 0;
        noHonorsMessageBody.classList.toggle('hidden', !(visibleCount === 0 && isFiltering));
        honorsTableBody.classList.toggle('hidden', visibleCount === 0 && isFiltering);
        updateFilterButtonLabel(typeFilterBtnLabel, '类型', selectedTypes.length);
        updateFilterButtonLabel(levelFilterBtnLabel, '等级', selectedLevels.length);
    }

    function updateFilterButtonLabel(labelElement, prefix, count) {
        if (!labelElement) return;
        const button = labelElement.parentElement;
        if (count > 0) {
            labelElement.textContent = `筛选${prefix} (${count})`;
            button.classList.add('btn-active', 'btn-primary');
        } else {
            labelElement.textContent = `筛选${prefix}`;
            button.classList.remove('btn-active', 'btn-primary');
        }
    }
    
    window.resetClientFilters = () => {
        if (keywordSearchInput) keywordSearchInput.value = "";
        typeCheckboxes.forEach(cb => cb.checked = false);
        levelCheckboxes.forEach(cb => cb.checked = false);
        applyAllClientFilters();
    };

    // --- 下载功能 ---
    function showToast(type = 'info', message = '', duration = 3000) {
        const toastMap = {
            success: document.getElementById('toast-success'),
            error: document.getElementById('toast-error'),
            info: document.getElementById('toast-info')
        };
        Object.values(toastMap).forEach(t => t?.classList.add('hidden'));
        const toastElement = toastMap[type];
        if (toastElement) {
            toastElement.querySelector('span').textContent = message;
            toastElement.classList.remove('hidden');
            setTimeout(() => toastElement.classList.add('hidden'), duration);
        }
    }
    
    async function handleBulkDownload(buttonElement, endpoint, fileType) {
        const visibleRows = Array.from(honorsTableBody.querySelectorAll('tr[data-id]')).filter(row => row.style.display !== 'none');
        const honorIdsToDownload = visibleRows.map(row => row.dataset.id).filter(id => id);

        if (honorIdsToDownload.length === 0) {
            showToast('info', '当前视图没有可供下载的数据。');
            return;
        }

        const loadingSpinner = buttonElement.querySelector('.loading');
        if (loadingSpinner) loadingSpinner.classList.remove('hidden');
        buttonElement.classList.add('disabled');

        try {
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Accept': 'application/zip' },
                body: JSON.stringify({ honor_ids: honorIdsToDownload })
            });

            if (response.ok) {
                const blob = await response.blob();
                const contentDisposition = response.headers.get('content-disposition');
                let filename = `honors_download.${fileType}`;
                if (contentDisposition) {
                    const filenameMatch = contentDisposition.match(/filename="(.+?)"/);
                    if (filenameMatch && filenameMatch[1]) filename = filenameMatch[1];
                }
                const link = document.createElement('a');
                link.href = window.URL.createObjectURL(blob);
                link.download = filename;
                link.click();
                link.remove();
                window.URL.revokeObjectURL(link.href);
                showToast('success', `成功开始下载 ${filename}`);
            } else {
                const errorResult = await response.json().catch(() => ({}));
                showToast('error', errorResult.error || `下载失败 (${response.status})`);
            }
        } catch (error) {
            showToast('error', '下载请求时发生网络错误。');
        } finally {
            if (loadingSpinner) loadingSpinner.classList.add('hidden');
            buttonElement.classList.remove('disabled');
            if (document.activeElement) document.activeElement.blur();
        }
    }
    
    function handleExcelDownload() {
        const visibleRows = Array.from(honorsTableBody.querySelectorAll('tr[data-id]')).filter(row => row.style.display !== 'none');
        if (visibleRows.length === 0) {
            showToast('info', '当前视图没有可供下载的数据。');
            return;
        }
        const headers = ["荣誉名称", "类型", "等级", "获得日期", "颁发单位"];
        const data = [headers];
        visibleRows.forEach(row => {
            const cells = row.querySelectorAll('td');
            const rowData = [
                cells[0].textContent.trim(), cells[1].textContent.trim(),
                cells[2].textContent.trim(), cells[3].textContent.trim(),
                cells[4].getAttribute('title') || cells[4].textContent.trim()
            ];
            data.push(rowData);
        });
        const ws = XLSX.utils.aoa_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Honors");
        XLSX.writeFile(wb, `honors_export_${new Date().toISOString().slice(0, 10)}.xlsx`);
    }

    // --- 事件绑定 ---
    // 客户端筛选
    if (keywordSearchInput) keywordSearchInput.addEventListener('input', applyAllClientFilters);
    typeCheckboxes.forEach(cb => cb.addEventListener('change', applyAllClientFilters));
    levelCheckboxes.forEach(cb => cb.addEventListener('change', applyAllClientFilters));
    
    // 服务端筛选与重置
    if (resetFiltersBtn) {
        resetFiltersBtn.addEventListener('click', () => {
             window.location.href = "{{ url_for('honor_table', filter_date='all') }}";
        });
    }
    if (applyCustomDateBtn) {
        applyCustomDateBtn.addEventListener('click', () => {
            const startDate = startDateInput.value;
            const endDate = endDateInput.value;
            if (!startDate || !endDate) {
                return showToast('info', '请同时选择开始和结束日期。');
            }
            if (new Date(startDate) > new Date(endDate)) {
                return showToast('info', '开始日期不能晚于结束日期。');
            }
            const url = new URL(window.location.href);
            url.searchParams.set('filter_date', 'custom');
            url.searchParams.set('start_date', startDate);
            url.searchParams.set('end_date', endDate);
            window.location.href = url.toString();
        });
    }

    // 下载按钮
    if (downloadJpgZipBtn) downloadJpgZipBtn.addEventListener('click', (e) => handleBulkDownload(e.currentTarget, "{{ url_for('download_honors_zip') }}", 'zip'));
    if (downloadPdfZipBtn) downloadPdfZipBtn.addEventListener('click', (e) => handleBulkDownload(e.currentTarget, "{{ url_for('download_individual_pdfs_zip') }}", 'zip'));
    if (downloadExcelBtn) {
        downloadExcelBtn.addEventListener('click', (e) => {
            handleExcelDownload();
            if (document.activeElement) document.activeElement.blur();
        });
    }

    // --- 页面加载时初始化 ---
    applyAllClientFilters();
    console.log("荣誉表格页加载完成，客户端筛选已初始化。");
});
</script>
{% endblock %}