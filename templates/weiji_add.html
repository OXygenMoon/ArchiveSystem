{% extends "layout.html" %}

{% block title %}添加违纪记录{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8 grid place-items-center">
    <h1 class="text-2xl font-bold mb-6 text-center">添加新违纪记录</h1>

    {% include '_flashes.html' %} <!-- 包含 flash 消息显示模板 -->

    <form method="POST" class="max-w-3xl w-full"> {# 可以适当增加 max-w-* 以适应三列布局 #}
        {# 主要表单字段网格，改为 md:grid-cols-3 #}
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">

            <!-- Row 1: 姓名 -->
            <div class="form-control">
                <label class="label">
                    <span class="label-text">姓名</span>
                </label>
                <input type="text" name="name" id="student-name" class="input input-bordered" required>
            </div>

            <!-- Row 1: 班级 -->
            <div class="form-control">
                <label class="label">
                    <span class="label-text">班级</span>
                </label>
                <input type="text" name="class" id="student-class" class="input input-bordered" required>
            </div>

            <!-- Row 1: 经手人 -->
            <div class="form-control">
                <label class="label">
                    <span class="label-text">经手人</span> {# 更改标签文本为“经手人” #}
                </label>
                {# 确保 session['username'] 存在且正确 #}
                <input type="text" name="byteacher" class="input input-bordered" value="{{ session.get('username', '未知') }}" disabled>
            </div>

            <!-- Row 2: 违纪日期 -->
            <div class="form-control">
                <label class="label">
                    <span class="label-text">违纪日期</span>
                </label>
                <input type="date" name="date" class="input input-bordered" required value="{{ today }}">
            </div>

            <!-- Row 2: 系部 -->
            <div class="form-control">
                <label class="label">
                    <span class="label-text">系部</span>
                </label>
                <select name="department" class="select select-bordered" required>
                    <option value="">请选择系部</option>
                    {% for dept in departments %}
                    <option value="{{ dept }}" {% if session.department == dept %}selected{% endif %}>{{ dept }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Row 2: 违纪等级 -->
            <div class="form-control">
                <label class="label">
                    <span class="label-text">违纪等级</span>
                </label>
                <select name="level" class="select select-bordered" required>
                    <option value="">请选择等级</option>
                    {% for level in levels %}
                    <option value="{{ level }}" {% if level == "警告" %} selected {% endif %}>{{ level }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Row 3: 违纪类型 (跨越所有列) -->
            <div class="form-control md:col-span-3"> {# 让类型区域跨越三列 #}
                <label class="label">
                    <span class="label-text">违纪类型 (可多选)</span>
                </label>
                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-2 p-2 border border-base-300 rounded-lg"> {# 调整内部网格以适应更多空间 #}
                    {% for weiji_type in weiji_types %}
                    <div class="form-control">
                        <label class="label cursor-pointer justify-start gap-2">
                            <input type="checkbox" name="type" value="{{ weiji_type }}" class="checkbox checkbox-accent checkbox-sm" />
                            <span class="label-text">{{ weiji_type }}</span>
                        </label>
                    </div>
                    {% endfor %}
                </div>
                {# 隐藏 input 仍然有用 #}
                <input type="hidden" name="type" value="">
            </div>
        </div> {# 结束主要字段的网格布局 #}

        <!-- Row 4: 原因 (单独的 div, 占据全部宽度) -->
        <div class="form-control mt-4"> {# 使用 mt-4 添加与上方网格的间距 #}
            <label class="label">
                <span class="label-text">违纪原因</span>
            </label>
            <textarea name="reason" class="textarea textarea-bordered h-32" required></textarea>
        </div>

        <!-- Row 5: 按钮 (单独的 div) -->
        <div class="mt-6 flex justify-center gap-4"> {# 增加 gap 让按钮间距更大 #}
            <a href="{{ url_for('weiji_show') }}" class="btn bg-secondary">查看记录</a>
            <button type="submit" class="btn btn-primary">提交记录</button>
        </div>
    </form>

    <!-- 过往记录查询区域保持不变 -->
    <div id="past-records-container" class="mt-8 max-w-3xl w-full bg-base-200 p-4 rounded-lg shadow"> {# 也可以调整 max-width #}
        <h3 class="text-lg font-semibold mb-2 text-center">过往记录查询</h3>
        <div id="records-output" class="text-sm">
            <p class="text-gray-500 text-center">请输入完整的姓名和班级以查询过往记录。</p>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- 获取元素 ---
        const nameInput = document.getElementById('student-name');
        const classInput = document.getElementById('student-class');
        const recordsOutput = document.getElementById('records-output');
        const recordsContainer = document.getElementById('past-records-container');
        const form = document.querySelector('form[method="POST"]'); // 获取 form

        // --- 过往记录查询相关 ---
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        const fetchRecords = async () => {
            // 检查 nameInput 和 classInput 是否实际存在
            if (!nameInput || !classInput) {
                 console.warn("Name or Class input not found for fetching records.");
                 return;
            }
            const name = nameInput.value.trim();
            const className = classInput.value.trim();

            if (name && className) {
                recordsOutput.innerHTML = '<p class="text-info text-center animate-pulse">正在查询...</p>';
                try {
                    const url = new URL("{{ url_for('get_student_records') }}", window.location.origin);
                    url.searchParams.append('name', name);
                    url.searchParams.append('class_name', className);
                    const response = await fetch(url);
                    const data = await response.json();
                    if (!response.ok) {
                        recordsOutput.innerHTML = `<p class="text-error text-center">查询失败: ${data.message || data.error || response.statusText}</p>`;
                        return;
                    }
                    if (data.records && data.records.length > 0) {
                        let html = '<ul class="space-y-2">';
                        data.records.forEach(record => {
                            const revokeInfo = record['撤销信息'] ? `<span class="text-success ml-2">(已撤销: ${record['撤销信息']})</span>` : '<span class="text-warning ml-2">(未撤销)</span>';
                            html += `
                                <li class="border-b border-base-300 pb-1">
                                    <strong>${record['日期'] || 'N/A'}</strong> - ${record['处分等级'] || 'N/A'} - ${record['原因'] || 'N/A'} - ${record['系部'] || 'N/A'} - ${record['经手人'] || 'N/A'} ${revokeInfo}
                                </li>`;
                        });
                        html += '</ul>';
                        recordsOutput.innerHTML = html;
                    } else {
                        recordsOutput.innerHTML = '<p class="text-success text-center">未查询到该学生的过往违纪记录。</p>';
                    }
                } catch (error) {
                    console.error('查询记录时出错:', error);
                    recordsOutput.innerHTML = '<p class="text-error text-center">查询过程中发生错误，请检查网络或联系管理员。</p>';
                }
            } else {
                recordsOutput.innerHTML = '<p class="text-gray-500 text-center">请输入完整的姓名和班级以查询过往记录。</p>';
            }
        };

        const debouncedFetchRecords = debounce(fetchRecords, 500);

        // 添加监听器前最好也检查元素是否存在
        if (nameInput) {
            nameInput.addEventListener('input', debouncedFetchRecords);
        } else {
            console.error("Element with ID 'student-name' not found.");
        }
        if (classInput) {
            classInput.addEventListener('input', debouncedFetchRecords);
        } else {
             console.error("Element with ID 'student-class' not found.");
        }

        // --- 表单提交处理 ---
        // 检查 form 是否存在
        if (form) {
            const typeCheckboxes = form.querySelectorAll('input[name="type"][type="checkbox"]');
            // const hiddenTypeInput = form.querySelector('input[name="type"][type="hidden"]'); // 通常不需要显式处理这个隐藏input

            form.addEventListener('submit', function(event) {
                let isChecked = false;
                typeCheckboxes.forEach(checkbox => {
                    if (checkbox.checked) {
                        isChecked = true;
                    }
                });

                // 这里可以添加客户端验证，例如要求至少选择一个类型
                // if (!isChecked) {
                //     alert('请至少选择一个违纪类型！');
                //     event.preventDefault(); // 阻止表单提交
                //     return; // 停止执行后续代码
                // }

                // 注意：你不需要在客户端处理隐藏的 type input。
                // Flask 的 request.form.getlist('type') 会自动处理复选框：
                // - 如果至少有一个被选中，它会返回一个包含所有选中值的列表。
                // - 如果一个都没选中，它会返回一个空列表 `[]`。
                // 那个隐藏的 <input type="hidden" name="type" value=""> 实际上可能会干扰 getlist，
                // 导致在没有选中任何框时返回 [''] 而不是 []。
                // 建议：可以考虑从 HTML 中移除 <input type="hidden" name="type" value="">。

                console.log("Form submit event triggered. Checkbox checked status:", isChecked);
            });
        } else {
            console.error("Form element not found!"); // 如果 form 没找到，在这里输出错误
        }

    }); // 结束 DOMContentLoaded 监听器
</script>
{% endblock %}